[phases.setup]
nixPkgs = ["nodejs_20", "python3", "gcc", "gnumake", "yt-dlp", "ffmpeg"]

[variables]
PUPPETEER_SKIP_CHROMIUM_DOWNLOAD = "false"
PUPPETEER_CACHE_DIR = "/app/.cache/puppeteer"

[phases.install]
cmds = ["npm install"]

[phases.install.env]
PYTHON = "python3"

[phases.build]
cmds = [
  "npm --prefix client install",
  "npm --prefix client run build",
  "npm --prefix server install",
  "mkdir -p /app/.cache/puppeteer",
  "PUPPETEER_CACHE_DIR=/app/.cache/puppeteer ./server/node_modules/.bin/puppeteer browsers install chrome"
]

[start]
cmd = "PUPPETEER_CACHE_DIR=/app/.cache/puppeteer node server/server.js"
