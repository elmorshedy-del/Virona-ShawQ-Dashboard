

================ FILE: ./server/services/metaService.js ================
// server/services/metaService.js
import fetch from 'node-fetch';
import { getDb } from '../db/database.js';
import { formatDateAsGmt3 } from '../utils/dateUtils.js';

const META_API_VERSION = 'v19.0';
const META_BASE_URL = `https://graph.facebook.com/${META_API_VERSION}`;

// Store configurations - using the actual env variable names from Railway
const STORE_CONFIGS = {
  vironax: {
    accountIdEnv: 'META_AD_ACCOUNT_ID',
    tokenEnv: 'META_ACCESS_TOKEN',
    currency: 'SAR',
    displayCurrency: 'SAR',
    needsConversion: false
  },
  shawq: {
    accountIdEnv: 'SHAWQ_META_AD_ACCOUNT_ID',
    tokenEnv: 'SHAWQ_META_ACCESS_TOKEN',
    currency: 'TRY',
    displayCurrency: 'USD',
    needsConversion: true
  }
};

// small helper to fetch all pages from Meta Insights
async function fetchAllPages(initialUrl, label) {
  const allRows = [];
  let url = initialUrl;

  while (url) {
    const res = await fetch(url);
    const data = await res.json();

    if (data.error) {
      console.error(`[Meta API] ${label} error:`, data.error);
      throw new Error(data.error.message);
    }

    if (Array.isArray(data.data)) {
      allRows.push(...data.data);
    }

    url = data.paging && data.paging.next ? data.paging.next : null;
  }

  console.log(`[Meta API] ${label}: collected ${allRows.length} rows (all pages)`);
  return allRows;
}

// Get exchange rate TRY â†’ USD
async function getExchangeRate(fromCurrency, toCurrency) {
  const db = getDb();
  const today = formatDateAsGmt3(new Date());
  
  // Check cache first
  const cached = db.prepare(`
    SELECT rate FROM exchange_rates 
    WHERE from_currency = ? AND to_currency = ? AND date = ?
  `).get(fromCurrency, toCurrency, today);
  
  if (cached) {
    return cached.rate;
  }
  
  // Fetch from free API
  try {
    const res = await fetch(`https://api.exchangerate-api.com/v4/latest/${fromCurrency}`);
    const data = await res.json();
    const rate = data.rates[toCurrency] || 0.03; // fallback ~30 TRY = 1 USD
    
    // Cache the rate
    db.prepare(`
      INSERT OR REPLACE INTO exchange_rates (from_currency, to_currency, rate, date)
      VALUES (?, ?, ?, ?)
    `).run(fromCurrency, toCurrency, rate, today);
    
    console.log(`Exchange rate ${fromCurrency}â†’${toCurrency}: ${rate}`);
    return rate;
  } catch (error) {
    console.error('Exchange rate fetch error:', error);
    return fromCurrency === 'TRY' && toCurrency === 'USD' ? 0.029 : 1; // fallback
  }
}

export async function fetchMetaCampaigns(store, dateStart, dateEnd) {
  const config = STORE_CONFIGS[store];
  if (!config) throw new Error(`Unknown store: ${store}`);
  
  const accountId = process.env[config.accountIdEnv];
  const accessToken = process.env[config.tokenEnv];

  console.log(`[Meta API] Store: ${store}`);
  console.log(`[Meta API] Looking for env: ${config.accountIdEnv} = ${accountId ? 'SET' : 'NOT SET'}`);
  console.log(`[Meta API] Looking for env: ${config.tokenEnv} = ${accessToken ? 'SET' : 'NOT SET'}`);

  if (!accountId || !accessToken) {
    console.log(`[Meta API] Credentials not configured for ${store} - using demo data`);
    return getDemoMetaData(store, dateStart, dateEnd);
  }

  const fields = [
    'campaign_id',
    'campaign_name',
    'spend',
    'impressions',
    'reach',
    'clicks',
    'actions',
    'action_values',
    'cpm',
    'cpc',
    'ctr',
    'frequency'
  ].join(',');

  const cleanAccountId = accountId.replace(/^act_/, '');
  const baseUrl =
    `${META_BASE_URL}/act_${cleanAccountId}/insights` +
    `?fields=${fields}` +
    `&time_range={"since":"${dateStart}","until":"${dateEnd}"}` +
    `&level=campaign&time_increment=1&access_token=${accessToken}`;

  console.log(`[Meta API] Fetching campaigns for ${store} ${dateStart} â†’ ${dateEnd}`);

  try {
    let results = await fetchAllPages(baseUrl, 'campaigns');

    // Convert currency if needed (Shawq: TRY â†’ USD)
    if (config.needsConversion) {
      const rate = await getExchangeRate(config.currency, config.displayCurrency);
      results = results.map(row => ({
        ...row,
        spend: (parseFloat(row.spend) * rate).toFixed(2),
        cpm: (parseFloat(row.cpm || 0) * rate).toFixed(2),
        cpc: (parseFloat(row.cpc || 0) * rate).toFixed(2),
        action_values: (row.action_values || []).map(av => ({
          ...av,
          value: (parseFloat(av.value) * rate).toFixed(2)
        }))
      }));
    }

    return results;
  } catch (error) {
    console.error(`[Meta API] Error for ${store}:`, error.message);
    console.log(`[Meta API] Falling back to demo data for ${store}`);
    return getDemoMetaData(store, dateStart, dateEnd);
  }
}

export async function fetchMetaCampaignsByCountry(store, dateStart, dateEnd) {
  const config = STORE_CONFIGS[store];
  if (!config) throw new Error(`Unknown store: ${store}`);
  
  const accountId = process.env[config.accountIdEnv];
  const accessToken = process.env[config.tokenEnv];

  if (!accountId || !accessToken) {
    console.log('[Meta API] No creds for country breakdown, using demo');
    return getDemoMetaDataByCountry(store, dateStart, dateEnd);
  }

  const fields = [
    'campaign_id',
    'campaign_name',
    'spend',
    'impressions',
    'reach',
    'clicks',
    'actions',
    'action_values',
    'cpm',
    'cpc',
    'ctr',
    'frequency',
    'country'
  ].join(',');

  const cleanAccountId = accountId.replace(/^act_/, '');
  const baseUrl =
    `${META_BASE_URL}/act_${cleanAccountId}/insights` +
    `?fields=${fields}` +
    `&time_range={"since":"${dateStart}","until":"${dateEnd}"}` +
    `&level=campaign&time_increment=1&breakdowns=country&access_token=${accessToken}`;

  try {
    let results = await fetchAllPages(baseUrl, 'country breakdown');

    if (config.needsConversion) {
      const rate = await getExchangeRate(config.currency, config.displayCurrency);
      results = results.map(row => ({
        ...row,
        spend: (parseFloat(row.spend) * rate).toFixed(2),
        cpm: (parseFloat(row.cpm || 0) * rate).toFixed(2),
        cpc: (parseFloat(row.cpc || 0) * rate).toFixed(2),
        action_values: (row.action_values || []).map(av => ({
          ...av,
          value: (parseFloat(av.value) * rate).toFixed(2)
        }))
      }));
    }

    return results;
  } catch (error) {
    console.error(`[Meta API] Country breakdown error for ${store}:`, error.message);
    return getDemoMetaDataByCountry(store, dateStart, dateEnd);
  }
}

// Fetch by age breakdown
export async function fetchMetaCampaignsByAge(store, dateStart, dateEnd) {
  const config = STORE_CONFIGS[store];
  if (!config) throw new Error(`Unknown store: ${store}`);
  
  const accountId = process.env[config.accountIdEnv];
  const accessToken = process.env[config.tokenEnv];

  if (!accountId || !accessToken) {
    return getDemoMetaDataByAge(store, dateStart, dateEnd);
  }

  try {
    const fields = [
      'campaign_id', 'campaign_name', 'spend', 'impressions', 'reach',
      'clicks', 'actions', 'action_values', 'cpm', 'cpc', 'ctr', 'frequency', 'age'
    ].join(',');

    const cleanAccountId = accountId.replace(/^act_/, '');
    const baseUrl =
      `${META_BASE_URL}/act_${cleanAccountId}/insights` +
      `?fields=${fields}` +
      `&time_range={"since":"${dateStart}","until":"${dateEnd}"}` +
      `&level=campaign&time_increment=1&breakdowns=age&access_token=${accessToken}`;

    let results = await fetchAllPages(baseUrl, 'age breakdown');

    if (config.needsConversion) {
      const rate = await getExchangeRate(config.currency, config.displayCurrency);
      results = results.map(row => ({
        ...row,
        spend: (parseFloat(row.spend) * rate).toFixed(2),
        cpm: (parseFloat(row.cpm || 0) * rate).toFixed(2),
        cpc: (parseFloat(row.cpc || 0) * rate).toFixed(2),
        action_values: (row.action_values || []).map(av => ({
          ...av,
          value: (parseFloat(av.value) * rate).toFixed(2)
        }))
      }));
    }
    return results;
  } catch (error) {
    console.error(`[Meta API] Age breakdown error for ${store}:`, error.message);
    return getDemoMetaDataByAge(store, dateStart, dateEnd);
  }
}

// Fetch by gender breakdown
export async function fetchMetaCampaignsByGender(store, dateStart, dateEnd) {
  const config = STORE_CONFIGS[store];
  if (!config) throw new Error(`Unknown store: ${store}`);
  
  const accountId = process.env[config.accountIdEnv];
  const accessToken = process.env[config.tokenEnv];

  if (!accountId || !accessToken) {
    return getDemoMetaDataByGender(store, dateStart, dateEnd);
  }

  try {
    const fields = [
      'campaign_id', 'campaign_name', 'spend', 'impressions', 'reach',
      'clicks', 'actions', 'action_values', 'cpm', 'cpc', 'ctr', 'frequency', 'gender'
    ].join(',');
    const cleanAccountId = accountId.replace(/^act_/, '');
    const baseUrl =
      `${META_BASE_URL}/act_${cleanAccountId}/insights` +
      `?fields=${fields}` +
      `&time_range={"since":"${dateStart}","until":"${dateEnd}"}` +
      `&level=campaign&time_increment=1&breakdowns=gender&access_token=${accessToken}`;

    let results = await fetchAllPages(baseUrl, 'gender breakdown');

    if (config.needsConversion) {
      const rate = await getExchangeRate(config.currency, config.displayCurrency);
      results = results.map(row => ({
        ...row,
        spend: (parseFloat(row.spend) * rate).toFixed(2),
        cpm: (parseFloat(row.cpm || 0) * rate).toFixed(2),
        cpc: (parseFloat(row.cpc || 0) * rate).toFixed(2),
        action_values: (row.action_values || []).map(av => ({
          ...av,
          value: (parseFloat(av.value) * rate).toFixed(2)
        }))
      }));
    }
    return results;
  } catch (error) {
    console.error(`[Meta API] Gender breakdown error for ${store}:`, error.message);
    return getDemoMetaDataByGender(store, dateStart, dateEnd);
  }
}

// Fetch by placement breakdown
export async function fetchMetaCampaignsByPlacement(store, dateStart, dateEnd) {
  const config = STORE_CONFIGS[store];
  if (!config) throw new Error(`Unknown store: ${store}`);
  
  const accountId = process.env[config.accountIdEnv];
  const accessToken = process.env[config.tokenEnv];

  if (!accountId || !accessToken) {
    return getDemoMetaDataByPlacement(store, dateStart, dateEnd);
  }

  try {
    const fields = [
      'campaign_id', 'campaign_name', 'spend', 'impressions', 'reach',
      'clicks', 'actions', 'action_values', 'cpm', 'cpc', 'ctr', 'frequency',
      'publisher_platform', 'platform_position'
    ].join(',');
    const cleanAccountId = accountId.replace(/^act_/, '');
    const baseUrl =
      `${META_BASE_URL}/act_${cleanAccountId}/insights` +
      `?fields=${fields}` +
      `&time_range={"since":"${dateStart}","until":"${dateEnd}"}` +
      `&level=campaign&time_increment=1&breakdowns=publisher_platform,platform_position&access_token=${accessToken}`;

    let results = await fetchAllPages(baseUrl, 'placement breakdown');

    if (config.needsConversion) {
      const rate = await getExchangeRate(config.currency, config.displayCurrency);
      results = results.map(row => ({
        ...row,
        spend: (parseFloat(row.spend) * rate).toFixed(2),
        cpm: (parseFloat(row.cpm || 0) * rate).toFixed(2),
        cpc: (parseFloat(row.cpc || 0) * rate).toFixed(2),
        action_values: (row.action_values || []).map(av => ({
          ...av,
          value: (parseFloat(av.value) * rate).toFixed(2)
        }))
      }));
    }
    return results;
  } catch (error) {
    console.error(`[Meta API] Placement breakdown error for ${store}:`, error.message);
    return getDemoMetaDataByPlacement(store, dateStart, dateEnd);
  }
}

export async function syncMetaData(store) {
  const db = getDb();
  const endDate = formatDateAsGmt3(new Date());
  const startDate = formatDateAsGmt3(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000));

  try {
    const campaigns = await fetchMetaCampaigns(store, startDate, endDate);
    const countryData = await fetchMetaCampaignsByCountry(store, startDate, endDate);
    const ageData = await fetchMetaCampaignsByAge(store, startDate, endDate);
    const genderData = await fetchMetaCampaignsByGender(store, startDate, endDate);
    const placementData = await fetchMetaCampaignsByPlacement(store, startDate, endDate);

    const insertStmt = db.prepare(`
      INSERT OR REPLACE INTO meta_daily_metrics 
      (store, date, campaign_id, campaign_name, country, age, gender, publisher_platform, platform_position,
       spend, impressions, reach, clicks, landing_page_views, add_to_cart, checkouts_initiated, 
       conversions, conversion_value, cpm, cpc, ctr, frequency)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);

    let recordsInserted = 0;

    // Insert campaign totals (ALL breakdown)
    for (const row of campaigns) {
      const actions = parseActions(row.actions || []);
      const actionValues = parseActionValues(row.action_values || []);

      insertStmt.run(
        store, row.date_start, row.campaign_id, row.campaign_name,
        'ALL', '', '', '', '',
        parseFloat(row.spend) || 0, parseInt(row.impressions) || 0, parseInt(row.reach) || 0,
        parseInt(row.clicks) || 0, actions.landing_page_view || 0, actions.add_to_cart || 0,
        actions.initiate_checkout || 0, actions.purchase || 0, actionValues.purchase || 0,
        parseFloat(row.cpm) || 0, parseFloat(row.cpc) || 0, parseFloat(row.ctr) || 0,
        parseFloat(row.frequency) || 0
      );
      recordsInserted++;
    }

    // Insert country breakdown
    for (const row of countryData) {
      const actions = parseActions(row.actions || []);
      const actionValues = parseActionValues(row.action_values || []);

      insertStmt.run(
        store, row.date_start, row.campaign_id, row.campaign_name,
        row.country || 'UNKNOWN', '', '', '', '',
        parseFloat(row.spend) || 0, parseInt(row.impressions) || 0, parseInt(row.reach) || 0,
        parseInt(row.clicks) || 0, actions.landing_page_view || 0, actions.add_to_cart || 0,
        actions.initiate_checkout || 0, actions.purchase || 0, actionValues.purchase || 0,
        parseFloat(row.cpm) || 0, parseFloat(row.cpc) || 0, parseFloat(row.ctr) || 0,
        parseFloat(row.frequency) || 0
      );
      recordsInserted++;
    }

    // Insert age breakdown
    for (const row of ageData) {
      const actions = parseActions(row.actions || []);
      const actionValues = parseActionValues(row.action_values || []);

      insertStmt.run(
        store, row.date_start, row.campaign_id, row.campaign_name,
        'ALL', row.age || '', '', '', '',
        parseFloat(row.spend) || 0, parseInt(row.impressions) || 0, parseInt(row.reach) || 0,
        parseInt(row.clicks) || 0, actions.landing_page_view || 0, actions.add_to_cart || 0,
        actions.initiate_checkout || 0, actions.purchase || 0, actionValues.purchase || 0,
        parseFloat(row.cpm) || 0, parseFloat(row.cpc) || 0, parseFloat(row.ctr) || 0,
        parseFloat(row.frequency) || 0
      );
      recordsInserted++;
    }

    // Insert gender breakdown
    for (const row of genderData) {
      const actions = parseActions(row.actions || []);
      const actionValues = parseActionValues(row.action_values || []);

      insertStmt.run(
        store, row.date_start, row.campaign_id, row.campaign_name,
        'ALL', '', row.gender || '', '', '',
        parseFloat(row.spend) || 0, parseInt(row.impressions) || 0, parseInt(row.reach) || 0,
        parseInt(row.clicks) || 0, actions.landing_page_view || 0, actions.add_to_cart || 0,
        actions.initiate_checkout || 0, actions.purchase || 0, actionValues.purchase || 0,
        parseFloat(row.cpm) || 0, parseFloat(row.cpc) || 0, parseFloat(row.ctr) || 0,
        parseFloat(row.frequency) || 0
      );
      recordsInserted++;
    }

    // Insert placement breakdown
    for (const row of placementData) {
      const actions = parseActions(row.actions || []);
      const actionValues = parseActionValues(row.action_values || []);

      insertStmt.run(
        store, row.date_start, row.campaign_id, row.campaign_name,
        'ALL', '', '', row.publisher_platform || '', row.platform_position || '',
        parseFloat(row.spend) || 0, parseInt(row.impressions) || 0, parseInt(row.reach) || 0,
        parseInt(row.clicks) || 0, actions.landing_page_view || 0, actions.add_to_cart || 0,
        actions.initiate_checkout || 0, actions.purchase || 0, actionValues.purchase || 0,
        parseFloat(row.cpm) || 0, parseFloat(row.cpc) || 0, parseFloat(row.ctr) || 0,
        parseFloat(row.frequency) || 0
      );
      recordsInserted++;
    }

    // Log sync
    db.prepare(`
      INSERT INTO sync_log (store, source, status, records_synced)
      VALUES (?, 'meta', 'success', ?)
    `).run(store, recordsInserted);

    return { success: true, records: recordsInserted };
  } catch (error) {
    db.prepare(`
      INSERT INTO sync_log (store, source, status, error_message)
      VALUES (?, 'meta', 'error', ?)
    `).run(store, error.message);

    throw error;
  }
}

function parseActions(actions) {
  const result = {
    landing_page_view: 0,
    add_to_cart: 0,
    initiate_checkout: 0,
    purchase: 0
  };

  for (const action of actions) {
    if (action.action_type === 'landing_page_view') {
      result.landing_page_view = parseInt(action.value) || 0;
    } else if (action.action_type === 'add_to_cart') {
      result.add_to_cart = parseInt(action.value) || 0;
    } else if (action.action_type === 'initiate_checkout') {
      result.initiate_checkout = parseInt(action.value) || 0;
    } else if (action.action_type === 'purchase' || action.action_type === 'omni_purchase') {
      result.purchase = parseInt(action.value) || 0;
    }
  }

  return result;
}

function parseActionValues(actionValues) {
  const result = { purchase: 0 };

  for (const av of actionValues) {
    if (av.action_type === 'purchase' || av.action_type === 'omni_purchase') {
      result.purchase = parseFloat(av.value) || 0;
    }
  }

  return result;
}

/* --- DEMO DATA HELPERS BELOW (unchanged logic) --- */

// Demo data - different for each store
function getDemoMetaData(store, dateStart, dateEnd) {
  // Returns empty array as demo data when Meta API is not configured
  return [];
}

// Demo data for country breakdown
function getDemoMetaDataByCountry(store, dateStart, dateEnd) {
  // Returns empty array as demo data when Meta API is not configured
  return [];
}

// Demo data for age breakdown
function getDemoMetaDataByAge(store, dateStart, dateEnd) {
  // Returns empty array as demo data when Meta API is not configured
  return [];
}

// Demo data for gender breakdown
function getDemoMetaDataByGender(store, dateStart, dateEnd) {
  // Returns empty array as demo data when Meta API is not configured
  return [];
}

// Demo data for placement breakdown
function getDemoMetaDataByPlacement(store, dateStart, dateEnd) {
  // Returns empty array as demo data when Meta API is not configured
  return [];
}


================ FILE: ./server/services/metaImportService.js ================
// server/services/metaImportService.js
import { getDb } from '../db/database.js';

function pick(obj, keys) {
  for (const k of keys) {
    if (
      obj &&
      Object.prototype.hasOwnProperty.call(obj, k) &&
      obj[k] !== undefined &&
      obj[k] !== null &&
      obj[k] !== ''
    ) {
      return obj[k];
    }
  }
  return null;
}

function toNumber(v) {
  if (v === null || v === undefined || v === '') return 0;
  if (typeof v === 'number') return Number.isFinite(v) ? v : 0;
  const cleaned = String(v).replace(/[,\s]/g, '');
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : 0;
}

function normalizeDate(v) {
  if (!v) return null;
  const s = String(v).trim();

  // already YYYY-MM-DD
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  // try Date.parse
  const d = new Date(s);
  if (!Number.isNaN(d.getTime())) {
    return d.toISOString().slice(0, 10);
  }
  return null;
}

function normalizeCountry(v) {
  if (!v) return 'ALL';
  const s = String(v).trim();
  // If user gives ISO2, fine; otherwise we store the raw label.
  return s.length ? s : 'ALL';
}

function normalizeText(v) {
  if (v === null || v === undefined) return null;
  const s = String(v).trim();
  return s.length ? s : null;
}

// Map a raw CSV row from Meta to our meta_daily_metrics schema
function rowToRecord(store, row) {
  const dateRaw = pick(row, ['date', 'day', 'date_start', 'Date', 'Day', 'Date start']);
  const campaignRaw = pick(row, ['campaign', 'campaign_name', 'Campaign', 'Campaign name']);
  const countryRaw = pick(row, ['country', 'country_code', 'Country', 'Country Code']);

  const ageRaw = pick(row, ['age', 'Age']);
  const genderRaw = pick(row, ['gender', 'Gender']);
  const publisherRaw = pick(row, ['publisher_platform', 'Publisher platform', 'publisher']);
  const positionRaw = pick(row, ['platform_position', 'Platform position', 'position']);
  const placementRaw = pick(row, ['placement', 'Placement']);

  const spendRaw = pick(row, ['spend', 'Spend', 'amount_spent', 'Amount spent']);
  const impressionsRaw = pick(row, ['impressions', 'Impressions']);
  const clicksRaw = pick(row, ['clicks', 'Clicks', 'link_clicks', 'Link clicks']);

  const purchasesRaw = pick(row, ['purchases', 'Purchases', 'purchase', 'Purchase']);
  const purchaseValueRaw = pick(row, [
    'purchase_value',
    'Purchase value',
    'revenue',
    'Revenue',
    'conversion_value'
  ]);

  const date = normalizeDate(dateRaw);
  const campaign = normalizeText(campaignRaw) || 'Unknown Campaign';
  const country = normalizeCountry(countryRaw);

  return {
    store,
    date,
    campaign,
    country,
    spend: toNumber(spendRaw),
    impressions: toNumber(impressionsRaw),
    clicks: toNumber(clicksRaw),
    purchases: toNumber(purchasesRaw),
    purchase_value: toNumber(purchaseValueRaw),
    age: normalizeText(ageRaw),
    gender: normalizeText(genderRaw),
    publisher_platform: normalizeText(publisherRaw),
    platform_position: normalizeText(positionRaw),
    placement: normalizeText(placementRaw)
  };
}

export function importMetaDailyRows(store, rows) {
  const db = getDb();

  const insertStmt = db.prepare(`
    INSERT OR IGNORE INTO meta_daily_metrics (
      store, date, campaign, country,
      spend, impressions, clicks, purchases, purchase_value,
      age, gender, publisher_platform, platform_position, placement
    ) VALUES (
      @store, @date, @campaign, @country,
      @spend, @impressions, @clicks, @purchases, @purchase_value,
      @age, @gender, @publisher_platform, @platform_position, @placement
    )
  `);

  const updateStmt = db.prepare(`
    UPDATE meta_daily_metrics SET
      spend = @spend,
      impressions = @impressions,
      clicks = @clicks,
      purchases = @purchases,
      purchase_value = @purchase_value,
      placement = COALESCE(@placement, placement)
    WHERE
      store = @store
      AND date = @date
      AND campaign = @campaign
      AND country = @country
      AND age IS @age
      AND gender IS @gender
      AND publisher_platform IS @publisher_platform
      AND platform_position IS @platform_position
  `);

  let inserted = 0;
  let updated = 0;
  let skipped = 0;

  const tx = db.transaction(() => {
    for (const row of rows) {
      try {
        const record = rowToRecord(store, row || {});
        if (!record.date || !record.campaign) {
          skipped += 1;
          continue;
        }

        const ins = insertStmt.run(record);
        if (ins.changes === 1) {
          inserted += 1;
          continue;
        }

        const upd = updateStmt.run(record);
        if (upd.changes > 0) {
          updated += 1;
        } else {
          skipped += 1;
        }
      } catch (e) {
        skipped += 1;
      }
    }
  });

  tx();

  return { inserted, updated, skipped };
}


================ FILE: ./server/services/analyticsService.js ================
import { getCountryInfo, getAllCountries } from '../utils/countryData.js';
import { getDb } from '../db/database.js';
import { formatDateAsGmt3 } from '../utils/dateUtils.js';

function getDateRange(params) {
  // Get current date in local timezone
  const now = new Date();
  const today = formatDateAsGmt3(now);
  
  // Handle custom date range (startDate and endDate provided)
  if (params.startDate && params.endDate) {
    const start = new Date(params.startDate);
    const end = new Date(params.endDate);
    const days = Math.ceil((end - start) / (24 * 60 * 60 * 1000)) + 1;
    return { startDate: params.startDate, endDate: params.endDate, days };
  }
  
  // Handle yesterday specifically
  if (params.yesterday) {
    const yesterday = formatDateAsGmt3(new Date(now.getTime() - 24 * 60 * 60 * 1000));
    return { startDate: yesterday, endDate: yesterday, days: 1 };
  }
  
  let days = 7;
  
  if (params.days) days = parseInt(params.days);
  else if (params.weeks) days = parseInt(params.weeks) * 7;
  else if (params.months) days = parseInt(params.months) * 30;
  
  // End date is always today
  const endDate = today;
  
  // Start date: for days=1, start=today (same day). For days=7, go back 6 days.
  const startMs = now.getTime() - (days - 1) * 24 * 60 * 60 * 1000;
  const startDate = formatDateAsGmt3(new Date(startMs));
  
  return { startDate, endDate, days };
}

export function getDashboard(store, params) {
  const db = getDb();
  const { startDate, endDate } = getDateRange(params);
  
  // Get campaign data
  const campaignData = db.prepare(`
    SELECT 
      campaign_id as campaignId,
      campaign_name as campaignName,
      SUM(spend) as spend,
      SUM(impressions) as impressions,
      SUM(reach) as reach,
      SUM(clicks) as clicks,
      SUM(landing_page_views) as lpv,
      SUM(add_to_cart) as atc,
      SUM(checkouts_initiated) as checkout,
      SUM(conversions) as conversions,
      SUM(conversion_value) as conversionValue,
      AVG(cpm) as cpm,
      AVG(frequency) as frequency
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country = 'ALL'
    GROUP BY campaign_id, campaign_name
    ORDER BY spend DESC
  `).all(store, startDate, endDate);

  // Enrich campaign data with calculated metrics
  const campaigns = campaignData.map(c => ({
    ...c,
    cpc: c.clicks > 0 ? c.spend / c.clicks : 0,
    ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
    cr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0,
    metaRoas: c.spend > 0 ? c.conversionValue / c.spend : 0,
    metaAov: c.conversions > 0 ? c.conversionValue / c.conversions : 0,
    metaCac: c.conversions > 0 ? c.spend / c.conversions : 0
  }));

  const metaTotals = db.prepare(`
    SELECT
      SUM(spend) as metaSpendTotal,
      SUM(conversion_value) as metaRevenueTotal,
      SUM(impressions) as impressions_total,
      SUM(reach) as reach_total,
      SUM(clicks) as clicks_total,
      SUM(landing_page_views) as lpv_total,
      SUM(add_to_cart) as atc_total,
      SUM(checkouts_initiated) as checkout_total,
      SUM(conversions) as conversions_total
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ?
  `).get(store, startDate, endDate) || {};

  const metaCampaignCount = db.prepare(`
    SELECT COUNT(DISTINCT campaign_id) as count
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND spend > 0
  `).get(store, startDate, endDate)?.count || 0;

  const metaSpendTotal = metaTotals.metaSpendTotal || 0;
  const metaRevenueTotal = metaTotals.metaRevenueTotal || 0;
  const impressions_total = metaTotals.impressions_total || 0;
  const reach_total = metaTotals.reach_total || 0;
  const clicks_total = metaTotals.clicks_total || 0;
  const lpv_total = metaTotals.lpv_total || 0;
  const atc_total = metaTotals.atc_total || 0;
  const checkout_total = metaTotals.checkout_total || 0;
  const conversions_total = metaTotals.conversions_total || 0;

  const metaRoasTotal = metaSpendTotal > 0 ? metaRevenueTotal / metaSpendTotal : null;
  const ctr_total = impressions_total > 0 ? clicks_total / impressions_total : null;
  const meta_cac_total = conversions_total > 0 ? metaSpendTotal / conversions_total : null;

  // Get e-commerce orders (Salla for vironax, Shopify for shawq)
  let ecomOrders;
  let ecomCityOrders;
  if (store === 'vironax') {
    ecomOrders = db.prepare(`
      SELECT
        country_code as countryCode,
        COUNT(*) as orders,
        SUM(order_total) as revenue
      FROM salla_orders
      WHERE store = ? AND date BETWEEN ? AND ? AND country_code IS NOT NULL AND country_code != ''
      GROUP BY country_code
    `).all(store, startDate, endDate);

    ecomCityOrders = db.prepare(`
      SELECT
        country_code as countryCode,
        COALESCE(NULLIF(city, ''), 'Unknown') as city,
        COUNT(*) as orders,
        SUM(order_total) as revenue
      FROM salla_orders
      WHERE store = ? AND date BETWEEN ? AND ? AND country_code IS NOT NULL AND country_code != '' AND city IS NOT NULL
      GROUP BY country_code, city
    `).all(store, startDate, endDate);
  } else {
    ecomOrders = db.prepare(`
      SELECT
        country_code as countryCode,
        COUNT(*) as orders,
        SUM(subtotal) as revenue
      FROM shopify_orders
      WHERE store = ? AND date BETWEEN ? AND ? AND country_code IS NOT NULL AND country_code != ''
      GROUP BY country_code
    `).all(store, startDate, endDate);

    ecomCityOrders = db.prepare(`
      SELECT
        country_code as countryCode,
        COALESCE(NULLIF(city, ''), 'Unknown') as city,
        COALESCE(NULLIF(state, ''), '') as state,
        COUNT(*) as orders,
        SUM(subtotal) as revenue
      FROM shopify_orders
      WHERE store = ? AND date BETWEEN ? AND ? AND country_code IS NOT NULL AND country_code != '' AND city IS NOT NULL
      GROUP BY country_code, city, state
    `).all(store, startDate, endDate);
  }

  // Get manual orders
  const manualOrders = db.prepare(`
    SELECT
      country as countryCode,
      SUM(spend) as spend,
      SUM(orders_count) as orders,
      SUM(revenue) as revenue
    FROM manual_orders
    WHERE store = ? AND date BETWEEN ? AND ?
    GROUP BY country
  `).all(store, startDate, endDate);

  const manualSpendOverrides = db.prepare(`
    SELECT
      country as countryCode,
      SUM(amount) as amount
    FROM manual_spend_overrides
    WHERE store = ? AND date BETWEEN ? AND ?
    GROUP BY country
  `).all(store, startDate, endDate);

  // Get meta spend by country (DYNAMIC - from actual data)
  const metaByCountry = db.prepare(`
    SELECT 
      country as countryCode,
      SUM(spend) as spend,
      SUM(conversions) as conversions,
      SUM(conversion_value) as conversionValue
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country != 'ALL'
    GROUP BY country
  `).all(store, startDate, endDate);

  // Build dynamic countries list from actual data
  const countryMap = new Map();

  // Seed map with ecommerce countries only (source of truth for inclusion)
  for (const e of ecomOrders) {
    const info = getCountryInfo(e.countryCode);
    countryMap.set(e.countryCode, {
      code: e.countryCode,
      name: info.name,
      flag: info.flag,
      spend: 0,
      manualSpend: 0,
      metaOrders: 0,
      metaRevenue: 0,
      ecomOrders: e.orders || 0,
      manualOrders: 0,
      revenue: e.revenue || 0,
      cities: []
    });
  }

  // Attach ecommerce cities (Shopify/Salla)
  const usStateAggregates = new Map();
  for (const cityRow of ecomCityOrders || []) {
    const country = countryMap.get(cityRow.countryCode);
    if (!country) continue;
    if (!cityRow.orders && !cityRow.revenue) continue;

    // For US orders, aggregate by state (regardless of city) so the breakdown is state-first
    if (cityRow.countryCode === 'US') {
      const stateName = cityRow.state?.trim() || 'Unknown';
      const cityName = cityRow.city?.trim() || 'Unknown';

      const existing = usStateAggregates.get(stateName) || {
        city: stateName,
        orders: 0,
        revenue: 0,
        cities: []
      };

      existing.orders += cityRow.orders || 0;
      existing.revenue += cityRow.revenue || 0;

      // Track per-city totals within the state (only for cities that actually ordered)
      if (cityRow.orders || cityRow.revenue) {
        const cityList = existing.cities || [];
        const existingCity = cityList.find(c => c.city === cityName) || { city: cityName, orders: 0, revenue: 0 };
        existingCity.orders += cityRow.orders || 0;
        existingCity.revenue += cityRow.revenue || 0;

        if (!cityList.includes(existingCity)) {
          cityList.push(existingCity);
        }

        existing.cities = cityList;
      }

      usStateAggregates.set(stateName, existing);
      continue;
    }

    const cityName = cityRow.city?.trim() || 'Unknown';
    const formattedCity = cityRow.countryCode === 'US' && (cityRow.state?.trim())
      ? `${cityName}, ${cityRow.state.trim()}`
      : cityName;
    country.cities.push({
      city: formattedCity,
      orders: cityRow.orders || 0,
      revenue: cityRow.revenue || 0
    });
  }

  // Attach aggregated US states with medal rankings (top 3 by orders) and alphabetical ordering
  if (usStateAggregates.size > 0 && countryMap.has('US')) {
    const usStates = Array.from(usStateAggregates.values()).filter(state => state.orders > 0);
    const rankedStates = [...usStates].sort((a, b) => b.orders - a.orders);

    rankedStates.slice(0, 3).forEach((state, idx) => {
      const medal = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : 'ðŸ¥‰';
      const target = usStates.find(s => s.city === state.city);
      if (target) {
        target.medal = medal;
        target.rank = idx + 1;
      }
    });

    const topStates = rankedStates.slice(0, 3);
    const remainingStates = usStates
      .filter(state => !topStates.some(top => top.city === state.city))
      .sort((a, b) => a.city.localeCompare(b.city));

    const orderedStates = [...topStates, ...remainingStates].map(state => ({
      ...state,
      cities: (state.cities || [])
        .filter(city => city.orders > 0)
        .sort((a, b) => b.orders - a.orders)
    }));

    countryMap.get('US').cities = orderedStates;
  }

  // Add Meta spend countries (spend only, NOT revenue - to avoid double counting)
  for (const m of metaByCountry) {
    if (!countryMap.has(m.countryCode)) continue;
    const country = countryMap.get(m.countryCode);
    country.spend = (country.spend || 0) + (m.spend || 0);
    country.metaOrders = (country.metaOrders || 0) + (m.conversions || 0);
    country.metaRevenue = (country.metaRevenue || 0) + (m.conversionValue || 0);
  }

  // Add manual orders only for ecommerce countries
  for (const m of manualOrders) {
    if (!countryMap.has(m.countryCode)) continue;
    const country = countryMap.get(m.countryCode);
    country.manualOrders = (country.manualOrders || 0) + (m.orders || 0);
    country.manualSpend = (country.manualSpend || 0) + (m.spend || 0);
    country.spend = (country.spend || 0) + (m.spend || 0);
    country.revenue += m.revenue || 0;
  }

  const overrideMap = new Map(
    manualSpendOverrides.map(o => [o.countryCode || 'ALL', o.amount || 0])
  );

  for (const [countryCode, amount] of overrideMap.entries()) {
    if (countryCode === 'ALL') continue;
    if (!countryMap.has(countryCode)) continue;
    const country = countryMap.get(countryCode);
    country.spend = amount || 0;
    country.manualSpend = amount || 0;
  }

  // Calculate country metrics
  const countries = Array.from(countryMap.values())
    .map(c => {
      const totalOrders = c.ecomOrders + c.manualOrders;
      const citiesWithAov = (c.code === 'US'
        ? (c.cities || []).map(city => ({
            ...city,
            aov: city.orders > 0 ? city.revenue / city.orders : 0,
            cities: (city.cities || []).map(innerCity => ({
              ...innerCity,
              aov: innerCity.orders > 0 ? innerCity.revenue / innerCity.orders : 0
            }))
          }))
        : (c.cities || []).map(city => ({
            ...city,
            aov: city.orders > 0 ? city.revenue / city.orders : 0
          }))
      );
      return {
        ...c,
        cities: citiesWithAov,
        totalOrders,
        aov: totalOrders > 0 ? c.revenue / totalOrders : 0,
        cac: totalOrders > 0 ? c.spend / totalOrders : 0,
        roas: c.spend > 0 ? c.revenue / c.spend : 0
      };
    })
    .filter(c => (c.ecomOrders || 0) > 0 || (c.revenue || 0) > 0)
    .sort((a, b) => b.spend - a.spend);

  // Calculate overview
  const overallOverride = overrideMap.get('ALL');
  const totalSpend = overallOverride != null
    ? overallOverride
    : countries.reduce((s, c) => s + (c.spend || 0), 0);
  const totalEcomOrders = ecomOrders.reduce((s, e) => s + e.orders, 0);
  const totalManualOrders = manualOrders.reduce((s, m) => s + m.orders, 0);
  const totalOrders = totalEcomOrders + totalManualOrders;
  const totalRevenue = countries.reduce((s, c) => s + c.revenue, 0);

  const overview = {
    revenue: totalRevenue,
    spend: totalSpend,
    orders: totalOrders,
    sallaOrders: store === 'vironax' ? totalEcomOrders : 0,
    shopifyOrders: store === 'shawq' ? totalEcomOrders : 0,
    manualOrders: totalManualOrders,
    aov: totalOrders > 0 ? totalRevenue / totalOrders : 0,
    cac: totalOrders > 0 ? totalSpend / totalOrders : 0,
    roas: totalSpend > 0 ? totalRevenue / totalSpend : 0
  };

  // Get daily trends
  const trends = getTrends(store, startDate, endDate);

  // Generate diagnostics
  const diagnostics = generateDiagnostics(campaigns, overview);

  return {
    overview,
    campaigns,
    countries,
    trends,
    diagnostics,
    dateRange: { startDate, endDate },
    metaCampaignCount,
    metaSpendTotal,
    metaRevenueTotal,
    metaRoasTotal,
    metaImpressionsTotal: impressions_total,
    metaReachTotal: reach_total,
    metaClicksTotal: clicks_total,
    metaCtrTotal: ctr_total,
    metaLpvTotal: lpv_total,
    metaAtcTotal: atc_total,
    metaCheckoutTotal: checkout_total,
    metaConversionsTotal: conversions_total,
    metaCacTotal: meta_cac_total
  };
}

function getTrends(store, startDate, endDate) {
  const db = getDb();
  
  // Generate all dates in range
  const allDates = [];
  const start = new Date(startDate);
  const end = new Date(endDate);
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    allDates.push(formatDateAsGmt3(d));
  }
  
  // Meta daily data
  const metaDaily = db.prepare(`
    SELECT 
      date,
      SUM(spend) as spend,
      SUM(conversions) as metaConversions,
      SUM(conversion_value) as metaRevenue
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country = 'ALL'
    GROUP BY date
    ORDER BY date
  `).all(store, startDate, endDate);

  // E-commerce daily
  let ecomDaily;
  if (store === 'vironax') {
    ecomDaily = db.prepare(`
      SELECT date, COUNT(*) as orders, SUM(order_total) as revenue
      FROM salla_orders WHERE store = ? AND date BETWEEN ? AND ?
      GROUP BY date
    `).all(store, startDate, endDate);
  } else {
    ecomDaily = db.prepare(`
      SELECT date, COUNT(*) as orders, SUM(subtotal) as revenue
      FROM shopify_orders WHERE store = ? AND date BETWEEN ? AND ?
      GROUP BY date
    `).all(store, startDate, endDate);
  }

  // Manual daily
  const manualDaily = db.prepare(`
    SELECT date, SUM(spend) as spend, SUM(orders_count) as orders, SUM(revenue) as revenue
    FROM manual_orders WHERE store = ? AND date BETWEEN ? AND ?
    GROUP BY date
  `).all(store, startDate, endDate);

  // Initialize all dates
  const dateMap = new Map();
  for (const date of allDates) {
    dateMap.set(date, { date, spend: 0, orders: 0, revenue: 0 });
  }
  
  // Add Meta spend only (NOT revenue to avoid double counting with ecom)
  for (const m of metaDaily) {
    if (dateMap.has(m.date)) {
      dateMap.get(m.date).spend = m.spend || 0;
    }
  }

  // Add e-commerce orders (source of truth for revenue)
  for (const e of ecomDaily) {
    if (dateMap.has(e.date)) {
      dateMap.get(e.date).orders += e.orders || 0;
      dateMap.get(e.date).revenue += e.revenue || 0;
    }
  }

  // Add manual orders
  for (const m of manualDaily) {
    if (dateMap.has(m.date)) {
      dateMap.get(m.date).spend += m.spend || 0;
      dateMap.get(m.date).orders += m.orders || 0;
      dateMap.get(m.date).revenue += m.revenue || 0;
    }
  }

  return Array.from(dateMap.values())
    .sort((a, b) => a.date.localeCompare(b.date))
    .map(d => ({
      ...d,
      aov: d.orders > 0 ? d.revenue / d.orders : 0,
      cac: d.orders > 0 ? d.spend / d.orders : 0,
      roas: d.spend > 0 ? d.revenue / d.spend : 0
    }));
}

function generateDiagnostics(campaigns, overview) {
  const diagnostics = [];

  // Check ROAS
  if (overview.roas < 2) {
    diagnostics.push({
      type: 'warning',
      icon: 'âš ï¸',
      title: 'Low ROAS',
      detail: `Overall ROAS is ${overview.roas.toFixed(2)}Ã— which is below the 2Ã— breakeven threshold`,
      action: 'Consider pausing low performers and reallocating budget'
    });
  } else if (overview.roas > 4) {
    diagnostics.push({
      type: 'success',
      icon: 'âœ…',
      title: 'Strong ROAS',
      detail: `Overall ROAS is ${overview.roas.toFixed(2)}Ã— - excellent performance`,
      action: 'Consider scaling budget on top performers'
    });
  }

  // Check CAC
  const avgCAC = overview.cac;
  if (avgCAC > 100) {
    diagnostics.push({
      type: 'warning',
      icon: 'ðŸ’°',
      title: 'High CAC',
      detail: `Average CAC is $${avgCAC.toFixed(0)} which may be eating into margins`,
      action: 'Review targeting and creative performance'
    });
  }

  // Check for campaign with high frequency
  for (const c of campaigns) {
    if (c.frequency > 3) {
      diagnostics.push({
        type: 'warning',
        icon: 'ðŸ”„',
        title: `High Frequency: ${c.campaignName}`,
        detail: `Frequency of ${c.frequency.toFixed(1)} indicates audience fatigue`,
        action: 'Refresh creatives or expand audience'
      });
      break; // Only report first one
    }
  }

  // Check CTR
  const avgCTR = campaigns.reduce((s, c) => s + c.ctr, 0) / (campaigns.length || 1);
  if (avgCTR < 0.8) {
    diagnostics.push({
      type: 'warning',
      icon: 'ðŸ‘†',
      title: 'Low CTR',
      detail: `Average CTR is ${avgCTR.toFixed(2)}% - below industry benchmark`,
      action: 'Test new ad creatives and copy'
    });
  }

  return diagnostics;
}

export function getEfficiency(store, params) {
  const db = getDb();
  const { startDate, endDate, days } = getDateRange(params);
  
  // Compare current vs previous period
  const prevStartDate = formatDateAsGmt3(new Date(new Date(startDate).getTime() - days * 24 * 60 * 60 * 1000));
  
  const currentPeriod = db.prepare(`
    SELECT SUM(spend) as spend, SUM(conversions) as orders, SUM(conversion_value) as revenue
    FROM meta_daily_metrics WHERE store = ? AND date BETWEEN ? AND ? AND country = 'ALL'
  `).get(store, startDate, endDate);

  const previousPeriod = db.prepare(`
    SELECT SUM(spend) as spend, SUM(conversions) as orders, SUM(conversion_value) as revenue
    FROM meta_daily_metrics WHERE store = ? AND date BETWEEN ? AND ? AND country = 'ALL'
  `).get(store, prevStartDate, startDate);

  const currentSpend = currentPeriod?.spend || 0;
  const currentOrders = currentPeriod?.orders || 0;
  const currentRevenue = currentPeriod?.revenue || 0;
  const prevSpend = previousPeriod?.spend || currentSpend;
  const prevOrders = previousPeriod?.orders || currentOrders;
  const prevRevenue = previousPeriod?.revenue || currentRevenue;

  const currentRoas = currentSpend > 0 ? currentRevenue / currentSpend : 0;
  const prevRoas = prevSpend > 0 ? prevRevenue / prevSpend : currentRoas;

  const spendChange = prevSpend > 0 ? ((currentSpend - prevSpend) / prevSpend) * 100 : 0;
  const roasChange = prevRoas > 0 ? ((currentRoas - prevRoas) / prevRoas) * 100 : 0;

  const averageCac = currentOrders > 0 ? currentSpend / currentOrders : 0;
  
  // Marginal CAC calculation
  const spendDelta = currentSpend - prevSpend;
  const ordersDelta = currentOrders - prevOrders;
  const marginalCac = ordersDelta > 0 ? spendDelta / ordersDelta : averageCac * 1.5;
  const marginalPremium = averageCac > 0 ? ((marginalCac - averageCac) / averageCac) * 100 : 0;

  // Efficiency ratio
  const efficiencyRatio = marginalCac > 0 ? averageCac / marginalCac : 1;

  // Determine status
  let status = 'green';
  if (marginalPremium > 30 || efficiencyRatio < 0.7) status = 'red';
  else if (marginalPremium > 15 || efficiencyRatio < 0.85) status = 'yellow';

  // Campaign efficiency
  const campaigns = db.prepare(`
    SELECT 
      campaign_id as campaignId,
      campaign_name as campaignName,
      SUM(spend) as spend,
      SUM(conversions) as conversions,
      AVG(frequency) as frequency,
      AVG(cpm) as cpm,
      AVG(ctr) as ctr
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country = 'ALL'
    GROUP BY campaign_id, campaign_name
  `).all(store, startDate, endDate);

  const campaignEfficiency = campaigns.map(c => {
    const metaCac = c.conversions > 0 ? c.spend / c.conversions : 0;
    let campStatus = 'green';
    if (c.frequency > 3 || metaCac > averageCac * 1.3) campStatus = 'red';
    else if (c.frequency > 2.5 || metaCac > averageCac * 1.15) campStatus = 'yellow';

    return {
      ...c,
      metaCac,
      marginalCac: metaCac * (1 + Math.random() * 0.3),
      status: campStatus,
      cpmChange: Math.round((Math.random() - 0.3) * 20),
      ctrChange: Math.round((Math.random() - 0.4) * 15)
    };
  });

  // Country efficiency (dynamic from data)
  const countryData = db.prepare(`
    SELECT 
      country as code,
      SUM(spend) as spend,
      SUM(conversions) as orders
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country != 'ALL'
    GROUP BY country
    ORDER BY spend DESC
  `).all(store, startDate, endDate);

  const countryEfficiency = countryData.map(c => {
    const info = getCountryInfo(c.code);
    const cac = c.orders > 0 ? c.spend / c.orders : 0;
    let scaling = 'green';
    if (cac > averageCac * 1.3) scaling = 'red';
    else if (cac > averageCac * 1.1) scaling = 'yellow';

    return {
      code: c.code,
      name: info.name,
      scaling,
      headroom: scaling === 'green' ? '+20-30%' : scaling === 'yellow' ? '+5-10%' : 'At limit'
    };
  });

  return {
    status,
    spendChange,
    roasChange,
    efficiencyRatio,
    averageCac,
    marginalCac,
    marginalPremium,
    campaigns: campaignEfficiency,
    countries: countryEfficiency
  };
}

export function getEfficiencyTrends(store, params) {
  const trends = getTrends(store, ...Object.values(getDateRange(params)).slice(0, 2));
  
  // Add rolling averages
  return trends.map((d, i, arr) => {
    const window = arr.slice(Math.max(0, i - 2), i + 1);
    const rollingSpend = window.reduce((s, x) => s + x.spend, 0) / window.length;
    const rollingOrders = window.reduce((s, x) => s + x.orders, 0) / window.length;
    const rollingRevenue = window.reduce((s, x) => s + x.revenue, 0) / window.length;
    
    return {
      ...d,
      rollingCac: rollingOrders > 0 ? rollingSpend / rollingOrders : 0,
      rollingRoas: rollingSpend > 0 ? rollingRevenue / rollingSpend : 0,
      marginalCac: d.cac * (1 + Math.random() * 0.3)
    };
  });
}

export function getRecommendations(store, params) {
  const dashboard = getDashboard(store, params);
  const recommendations = [];

  // Based on diagnostics
  if (dashboard.overview.roas < 3) {
    recommendations.push({
      type: 'urgent',
      title: 'Improve ROAS',
      detail: 'Current ROAS is below target. Review underperforming campaigns.',
      impact: 'Could improve profitability by 20-30%'
    });
  }

  // Check top campaigns
  const topCampaign = dashboard.campaigns[0];
  if (topCampaign && topCampaign.metaRoas > 4) {
    recommendations.push({
      type: 'positive',
      title: `Scale ${topCampaign.campaignName}`,
      detail: `This campaign has ${topCampaign.metaRoas.toFixed(1)}Ã— ROAS - consider increasing budget`,
      impact: 'Potential 15-25% revenue increase'
    });
  }

  // Check countries
  const topCountry = dashboard.countries[0];
  if (topCountry && topCountry.roas > 5) {
    recommendations.push({
      type: 'positive',
      title: `Double down on ${topCountry.name}`,
      detail: `${topCountry.name} shows ${topCountry.roas.toFixed(1)}Ã— ROAS`,
      impact: 'High potential for profitable scaling'
    });
  }

  // General recommendation
  recommendations.push({
    type: 'info',
    title: 'Creative refresh',
    detail: 'Consider testing new ad creatives every 2-3 weeks',
    impact: 'Maintains engagement and prevents fatigue'
  });

  return recommendations;
}

// Get dynamic countries list from actual data
export function getAvailableCountries(store) {
  return getAllCountries();
}

// Get campaigns broken down by country
export function getCampaignsByCountry(store, params) {
  const db = getDb();
  const { startDate, endDate } = getDateRange(params);
  
  const data = db.prepare(`
    SELECT 
      campaign_id as campaignId,
      campaign_name as campaignName,
      country,
      SUM(spend) as spend,
      SUM(impressions) as impressions,
      SUM(reach) as reach,
      SUM(clicks) as clicks,
      SUM(landing_page_views) as lpv,
      SUM(add_to_cart) as atc,
      SUM(checkouts_initiated) as checkout,
      SUM(conversions) as conversions,
      SUM(conversion_value) as conversionValue,
      AVG(cpm) as cpm,
      AVG(frequency) as frequency
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country != 'ALL'
    GROUP BY campaign_id, campaign_name, country
    ORDER BY campaign_name, spend DESC
  `).all(store, startDate, endDate);

  return data.map(c => {
    const countryInfo = getCountryInfo(c.country);
    return {
      ...c,
      countryName: countryInfo.name,
      countryFlag: countryInfo.flag,
      cpc: c.clicks > 0 ? c.spend / c.clicks : 0,
      ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
      cr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0,
      metaRoas: c.spend > 0 ? c.conversionValue / c.spend : 0,
      metaAov: c.conversions > 0 ? c.conversionValue / c.conversions : 0,
      metaCac: c.conversions > 0 ? c.spend / c.conversions : 0
    };
  });
}

// Get campaigns broken down by age
export function getCampaignsByAge(store, params) {
  const db = getDb();
  const { startDate, endDate } = getDateRange(params);
  
  const data = db.prepare(`
    SELECT 
      campaign_id as campaignId,
      campaign_name as campaignName,
      age,
      SUM(spend) as spend,
      SUM(impressions) as impressions,
      SUM(reach) as reach,
      SUM(clicks) as clicks,
      SUM(conversions) as conversions,
      SUM(conversion_value) as conversionValue,
      AVG(cpm) as cpm,
      AVG(frequency) as frequency
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND age IS NOT NULL AND age != ''
    GROUP BY campaign_id, campaign_name, age
    ORDER BY campaign_name, spend DESC
  `).all(store, startDate, endDate);

  return data.map(c => ({
    ...c,
    cpc: c.clicks > 0 ? c.spend / c.clicks : 0,
    ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
    cr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0,
    metaRoas: c.spend > 0 ? c.conversionValue / c.spend : 0,
    metaAov: c.conversions > 0 ? c.conversionValue / c.conversions : 0,
    metaCac: c.conversions > 0 ? c.spend / c.conversions : 0
  }));
}

// Get campaigns broken down by gender
export function getCampaignsByGender(store, params) {
  const db = getDb();
  const { startDate, endDate } = getDateRange(params);
  
  const data = db.prepare(`
    SELECT 
      campaign_id as campaignId,
      campaign_name as campaignName,
      gender,
      SUM(spend) as spend,
      SUM(impressions) as impressions,
      SUM(reach) as reach,
      SUM(clicks) as clicks,
      SUM(conversions) as conversions,
      SUM(conversion_value) as conversionValue,
      AVG(cpm) as cpm,
      AVG(frequency) as frequency
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND gender IS NOT NULL AND gender != ''
    GROUP BY campaign_id, campaign_name, gender
    ORDER BY campaign_name, spend DESC
  `).all(store, startDate, endDate);

  return data.map(c => ({
    ...c,
    genderLabel: c.gender === 'male' ? 'ðŸ‘¨ Male' : c.gender === 'female' ? 'ðŸ‘© Female' : 'â“ Unknown',
    cpc: c.clicks > 0 ? c.spend / c.clicks : 0,
    ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
    cr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0,
    metaRoas: c.spend > 0 ? c.conversionValue / c.spend : 0,
    metaAov: c.conversions > 0 ? c.conversionValue / c.conversions : 0,
    metaCac: c.conversions > 0 ? c.spend / c.conversions : 0
  }));
}

// Get campaigns broken down by combined age and gender
export function getCampaignsByAgeGender(store, params) {
  const db = getDb();
  const { startDate, endDate } = getDateRange(params);

  const data = db.prepare(`
    SELECT
      campaign_id as campaignId,
      campaign_name as campaignName,
      age,
      gender,
      SUM(spend) as spend,
      SUM(impressions) as impressions,
      SUM(reach) as reach,
      SUM(clicks) as clicks,
      SUM(conversions) as conversions,
      SUM(conversion_value) as conversionValue,
      AVG(cpm) as cpm,
      AVG(frequency) as frequency
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND age IS NOT NULL AND age != '' AND gender IS NOT NULL AND gender != ''
    GROUP BY campaign_id, campaign_name, age, gender
    ORDER BY campaign_name, spend DESC
  `).all(store, startDate, endDate);

  return data.map(c => ({
    ...c,
    genderLabel: c.gender === 'male' ? 'ðŸ‘¨ Male' : c.gender === 'female' ? 'ðŸ‘© Female' : 'â“ Unknown',
    cpc: c.clicks > 0 ? c.spend / c.clicks : 0,
    ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
    cr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0,
    metaRoas: c.spend > 0 ? c.conversionValue / c.spend : 0,
    metaAov: c.conversions > 0 ? c.conversionValue / c.conversions : 0,
    metaCac: c.conversions > 0 ? c.spend / c.conversions : 0
  }));
}

// Get campaigns broken down by placement
export function getCampaignsByPlacement(store, params) {
  const db = getDb();
  const { startDate, endDate } = getDateRange(params);
  
  const data = db.prepare(`
    SELECT 
      campaign_id as campaignId,
      campaign_name as campaignName,
      publisher_platform as platform,
      platform_position as placement,
      SUM(spend) as spend,
      SUM(impressions) as impressions,
      SUM(reach) as reach,
      SUM(clicks) as clicks,
      SUM(conversions) as conversions,
      SUM(conversion_value) as conversionValue,
      AVG(cpm) as cpm,
      AVG(frequency) as frequency
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND publisher_platform IS NOT NULL AND publisher_platform != ''
    GROUP BY campaign_id, campaign_name, publisher_platform, platform_position
    ORDER BY campaign_name, spend DESC
  `).all(store, startDate, endDate);

  const platformIcons = {
    'facebook': 'ðŸ“˜',
    'instagram': 'ðŸ“¸',
    'messenger': 'ðŸ’¬',
    'audience_network': 'ðŸŒ'
  };

  return data.map(c => ({
    ...c,
    platformIcon: platformIcons[c.platform] || 'ðŸ“±',
    placementLabel: `${platformIcons[c.platform] || 'ðŸ“±'} ${c.platform || 'unknown'} - ${c.placement || 'all'}`,
    cpc: c.clicks > 0 ? c.spend / c.clicks : 0,
    ctr: c.impressions > 0 ? (c.clicks / c.impressions) * 100 : 0,
    cr: c.clicks > 0 ? (c.conversions / c.clicks) * 100 : 0,
    metaRoas: c.spend > 0 ? c.conversionValue / c.spend : 0,
    metaAov: c.conversions > 0 ? c.conversionValue / c.conversions : 0,
    metaCac: c.conversions > 0 ? c.spend / c.conversions : 0
  }));
}

// Get daily order trends per country
export function getCountryTrends(store, params) {
  const db = getDb();
  const { startDate, endDate } = getDateRange(params);
  
  // Generate all dates in range
  const allDates = [];
  const start = new Date(startDate);
  const end = new Date(endDate);
  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    allDates.push(formatDateAsGmt3(d));
  }
  
  // Get ecommerce orders by country by date
  let ecomQuery;
  if (store === 'vironax') {
    ecomQuery = db.prepare(`
      SELECT date, country_code as country, COUNT(*) as orders, SUM(order_total) as revenue
      FROM salla_orders 
      WHERE store = ? AND date BETWEEN ? AND ?
      GROUP BY date, country_code
    `);
  } else {
    ecomQuery = db.prepare(`
      SELECT date, country_code as country, COUNT(*) as orders, SUM(subtotal) as revenue
      FROM shopify_orders 
      WHERE store = ? AND date BETWEEN ? AND ?
      GROUP BY date, country_code
    `);
  }
  const ecomData = ecomQuery.all(store, startDate, endDate);
  
  // Get manual orders by country by date
  const manualData = db.prepare(`
    SELECT date, country, SUM(orders_count) as orders, SUM(revenue) as revenue
    FROM manual_orders
    WHERE store = ? AND date BETWEEN ? AND ?
    GROUP BY date, country
  `).all(store, startDate, endDate);
  
  // Combine data by country
  const countryDataMap = new Map();

  const ecomCountrySet = new Set();

  // Process ecom orders
  for (const row of ecomData) {
    if (!row.country) continue;
    ecomCountrySet.add(row.country);
    if (!countryDataMap.has(row.country)) {
      countryDataMap.set(row.country, new Map());
    }
    const countryDates = countryDataMap.get(row.country);
    if (!countryDates.has(row.date)) {
      countryDates.set(row.date, { orders: 0, revenue: 0 });
    }
    const dateData = countryDates.get(row.date);
    dateData.orders += row.orders || 0;
    dateData.revenue += row.revenue || 0;
  }

  // Process manual orders (only for ecommerce countries)
  for (const row of manualData) {
    if (!ecomCountrySet.has(row.country)) continue;
    if (!countryDataMap.has(row.country)) {
      countryDataMap.set(row.country, new Map());
    }
    const countryDates = countryDataMap.get(row.country);
    if (!countryDates.has(row.date)) {
      countryDates.set(row.date, { orders: 0, revenue: 0 });
    }
    const dateData = countryDates.get(row.date);
    dateData.orders += row.orders || 0;
    dateData.revenue += row.revenue || 0;
  }

  if (countryDataMap.size === 0) {
    return [];
  }
  
  // Format output: array of countries with their daily trends
  const result = [];
  for (const [country, datesMap] of countryDataMap) {
    const countryInfo = getCountryInfo(country);
    const trends = allDates.map(date => {
      const data = datesMap.get(date) || { orders: 0, revenue: 0 };
      return {
        date,
        orders: data.orders,
        revenue: data.revenue
      };
    });
    
    const totalOrders = trends.reduce((sum, t) => sum + t.orders, 0);
    
    result.push({
      country: countryInfo.name,
      countryCode: country,
      flag: countryInfo.flag,
      totalOrders,
      trends
    });
  }
  
  // Sort by total orders descending
  return result.sort((a, b) => b.totalOrders - a.totalOrders);
}

// Shopify hourly orders for the selected range (defaults to last 7 days)
export function getShopifyTimeOfDay(store, params) {
  const allowedRegions = new Set(['us', 'europe', 'all']);
  const requestedRegion = typeof params.region === 'string' ? params.region.toLowerCase() : '';
  const region = allowedRegions.has(requestedRegion) ? requestedRegion : 'us';

  // For 'all' region, use UTC to show orders in a neutral timezone
  const timezone = region === 'europe' ? 'Europe/London' : region === 'all' ? 'UTC' : 'America/Chicago';

  if (store !== 'shawq') {
    return { data: [], timezone, sampleTimestamps: [] };
  }

  const db = getDb();
  const { startDate, endDate } = getDateRange(params);

  const tableInfo = db.prepare('PRAGMA table_info(shopify_orders)').all();
  const countryPriority = [
    'shipping_country_code',
    'shipping_country',
    'billing_country_code',
    'billing_country',
    'country_code',
    'country'
  ];

  const countryColumn = countryPriority.find(col => tableInfo.some(info => info.name === col));

  const normalizeCountryValue = (value) => {
    if (value === null || value === undefined) return null;
    if (typeof value !== 'string') return null;

    const trimmed = value.trim();
    if (!trimmed) return null;

    return trimmed.toUpperCase();
  };

  const usAllowlist = new Set([
    'US',
    'USA',
    'UNITED STATES',
    'UNITED STATES OF AMERICA'
  ]);

  const europeAllowlist = new Set([
    'GB', 'UK', 'UNITED KINGDOM',
    'IE', 'IRELAND',
    'FR', 'FRANCE',
    'DE', 'GERMANY',
    'ES', 'SPAIN',
    'IT', 'ITALY',
    'NL', 'NETHERLANDS',
    'BE', 'BELGIUM',
    'SE', 'SWEDEN',
    'NO', 'NORWAY',
    'DK', 'DENMARK',
    'FI', 'FINLAND',
    'CH', 'SWITZERLAND',
    'AT', 'AUSTRIA',
    'PL', 'POLAND',
    'PT', 'PORTUGAL',
    'GR', 'GREECE',
    'CZ', 'CZECH REPUBLIC',
    'RO', 'ROMANIA',
    'HU', 'HUNGARY'
  ]);

  const isRegionMatch = (countryValue) => {
    // 'all' region includes all orders regardless of country
    if (region === 'all') return true;

    if (!countryColumn) return true;

    const normalized = normalizeCountryValue(countryValue);
    if (!normalized) return false;

    if (region === 'us') {
      return usAllowlist.has(normalized);
    }

    if (region === 'europe') {
      return europeAllowlist.has(normalized);
    }

    return true;
  };

  const rows = db.prepare(`
    SELECT order_created_at, created_at, subtotal${countryColumn ? `, ${countryColumn} as country_value` : ''}
    FROM shopify_orders
    WHERE store = ? AND date BETWEEN ? AND ? AND (order_created_at IS NOT NULL OR created_at IS NOT NULL)
  `).all(store, startDate, endDate);

  const hourlyBuckets = Array.from({ length: 24 }, (_, idx) => ({
    hour: idx.toString().padStart(2, '0'),
    orders: 0,
    revenue: 0
  }));

  const sampleTimestamps = [];

  const hourFormatter = new Intl.DateTimeFormat('en-US', {
    timeZone: timezone,
    hour: '2-digit',
    hour12: false
  });

  for (const row of rows) {
    const countryValue = countryColumn ? row?.country_value : null;
    if (!isRegionMatch(countryValue)) continue;

    const rawTimestamp = row?.order_created_at || row?.created_at;
    if (!rawTimestamp) continue;

    if (sampleTimestamps.length < 5) {
      sampleTimestamps.push(rawTimestamp);
    }

    const parsed = new Date(rawTimestamp);
    if (Number.isNaN(parsed.getTime())) continue;

    const hourStr = hourFormatter.format(parsed);
    const hourIdx = parseInt(hourStr, 10);
    if (Number.isInteger(hourIdx) && hourIdx >= 0 && hourIdx < 24) {
      hourlyBuckets[hourIdx].orders += 1;
      hourlyBuckets[hourIdx].revenue += row?.subtotal || 0;
    }
  }

  return {
    data: hourlyBuckets,
    timezone,
    sampleTimestamps
  };
}


================ FILE: ./server/services/shopifyService.js ================
import fetch from 'node-fetch';
import { getDb } from '../db/database.js';
import { formatDateAsGmt3 } from '../utils/dateUtils.js';

export async function fetchShopifyOrders(dateStart, dateEnd) {
  const shopifyStore = process.env.SHAWQ_SHOPIFY_STORE;
  const accessToken = process.env.SHAWQ_SHOPIFY_ACCESS_TOKEN;

  if (!shopifyStore || !accessToken) {
    console.log('Shopify credentials not configured for Shawq - using demo data');
    return getDemoShopifyOrders(dateStart, dateEnd);
  }

  try {
    const orders = [];
    let url = `https://${shopifyStore}/admin/api/2024-01/orders.json?status=any&created_at_min=${dateStart}T00:00:00Z&created_at_max=${dateEnd}T23:59:59Z&limit=250`;

    while (url) {
      const response = await fetch(url, {
        headers: {
          'X-Shopify-Access-Token': accessToken,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.orders) {
        for (const order of data.orders) {
          const countryCode = order.shipping_address?.country_code || 
                             order.billing_address?.country_code || 'US';
          
          const createdAtIso = typeof order.created_at === 'string' ? order.created_at : null;
          const createdAtDate = createdAtIso ? new Date(createdAtIso) : null;
          const createdAtUtc = createdAtDate && !isNaN(createdAtDate.getTime())
            ? createdAtDate.toISOString()
            : null;
          const dateGmt3 = createdAtDate && !isNaN(createdAtDate.getTime())
            ? formatDateAsGmt3(createdAtDate)
            : (createdAtIso?.split('T')[0] || null);

          orders.push({
            order_id: order.id.toString(),
            date: dateGmt3,
            country: getCountryName(countryCode),
            country_code: countryCode,
            city: order.shipping_address?.city || order.billing_address?.city || null,
            state: order.shipping_address?.province || order.billing_address?.province || null,
            order_total: parseFloat(order.total_price) || 0,
            subtotal: parseFloat(order.subtotal_price) || 0,
            shipping: parseFloat(order.total_shipping_price_set?.shop_money?.amount) || 0,
            tax: parseFloat(order.total_tax) || 0,
            discount: parseFloat(order.total_discounts) || 0,
            items_count: order.line_items?.length || 1,
            status: order.fulfillment_status || 'unfulfilled',
            financial_status: order.financial_status || 'pending',
            fulfillment_status: order.fulfillment_status || null,
            payment_method: order.payment_gateway_names?.[0] || 'unknown',
            currency: order.currency || 'USD',
            order_created_at: createdAtUtc,
            createdAtUtcMs: createdAtUtc ? createdAtDate.getTime() : null
          });
        }
      }

      // Handle pagination via Link header
      const linkHeader = response.headers.get('Link');
      url = null;
      if (linkHeader) {
        const nextMatch = linkHeader.match(/<([^>]+)>;\s*rel="next"/);
        if (nextMatch) {
          url = nextMatch[1];
        }
      }
    }

    return orders;
  } catch (error) {
    console.error('Shopify API error:', error);
    throw error;
  }
}

export async function syncShopifyOrders() {
  const db = getDb();
  const endDate = formatDateAsGmt3(new Date());
  const startDate = formatDateAsGmt3(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000));

  try {
    const orders = await fetchShopifyOrders(startDate, endDate);

    const insertStmt = db.prepare(`
      INSERT OR REPLACE INTO shopify_orders
      (store, order_id, date, country, country_code, city, state, order_total, subtotal, shipping, tax, discount,
       items_count, status, financial_status, fulfillment_status, payment_method, currency, order_created_at)
      VALUES ('shawq', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);

    let recordsInserted = 0;
    for (const order of orders) {
      insertStmt.run(
        order.order_id,
        order.date,
        order.country,
        order.country_code,
        order.city,
        order.state,
        order.order_total,
        order.subtotal,
        order.shipping,
        order.tax,
        order.discount,
        order.items_count,
        order.status,
        order.financial_status,
        order.fulfillment_status,
        order.payment_method,
        order.currency,
        order.order_created_at
      );
      recordsInserted++;
    }

    db.prepare(`
      INSERT INTO sync_log (store, source, status, records_synced)
      VALUES ('shawq', 'shopify', 'success', ?)
    `).run(recordsInserted);

    return { success: true, records: recordsInserted };
  } catch (error) {
    db.prepare(`
      INSERT INTO sync_log (store, source, status, error_message)
      VALUES ('shawq', 'shopify', 'error', ?)
    `).run(error.message);

    throw error;
  }
}

function getCountryName(code) {
  const countries = {
    'US': 'United States',
    'GB': 'United Kingdom',
    'CA': 'Canada',
    'DE': 'Germany',
    'NL': 'Netherlands',
    'FR': 'France',
    'AU': 'Australia',
    'IT': 'Italy',
    'ES': 'Spain',
    'SE': 'Sweden',
    'NO': 'Norway',
    'DK': 'Denmark',
    'BE': 'Belgium',
    'CH': 'Switzerland',
    'AT': 'Austria',
    'IE': 'Ireland',
    'NZ': 'New Zealand'
  };
  return countries[code] || code;
}

// Demo data for Shopify (Western markets)
function getDemoShopifyOrders(dateStart, dateEnd) {
  const countries = [
    { name: 'United States', code: 'US', share: 0.40, avgOrder: 85 },
    { name: 'United Kingdom', code: 'GB', share: 0.20, avgOrder: 75 },
    { name: 'Canada', code: 'CA', share: 0.15, avgOrder: 80 },
    { name: 'Germany', code: 'DE', share: 0.10, avgOrder: 70 },
    { name: 'Netherlands', code: 'NL', share: 0.05, avgOrder: 65 },
    { name: 'France', code: 'FR', share: 0.05, avgOrder: 72 },
    { name: 'Australia', code: 'AU', share: 0.05, avgOrder: 78 }
  ];

  const orders = [];
  const start = new Date(dateStart);
  const end = new Date(dateEnd);
  let orderId = 500000;

  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const dateStr = formatDateAsGmt3(d);
    const dayOfWeek = d.getDay();
    const baseOrders = dayOfWeek === 0 || dayOfWeek === 6 ? 22 : 18;
    const dailyOrders = Math.floor(baseOrders * (0.8 + Math.random() * 0.4));

    for (let i = 0; i < dailyOrders; i++) {
      const rand = Math.random();
      let cumShare = 0;
      let selectedCountry = countries[0];

      for (const country of countries) {
        cumShare += country.share;
        if (rand < cumShare) {
          selectedCountry = country;
          break;
        }
      }

      const variance = 0.6 + Math.random() * 0.8;
      const orderTotal = selectedCountry.avgOrder * variance;
      // US gets free shipping over $75
      const shipping = selectedCountry.code === 'US' && orderTotal > 75 ? 0 :
                      selectedCountry.code === 'US' ? 8 : 15;
      const hour = Math.floor(Math.random() * 24).toString().padStart(2, '0');
      const minute = Math.floor(Math.random() * 60).toString().padStart(2, '0');
      const orderCreatedAt = `${dateStr}T${hour}:${minute}:00Z`;

      orders.push({
        order_id: (orderId++).toString(),
        date: dateStr,
        country: selectedCountry.name,
        country_code: selectedCountry.code,
        city: null,
        state: null,
        order_total: orderTotal + shipping,
        subtotal: orderTotal,
        shipping: shipping,
        tax: selectedCountry.code === 'US' ? 0 : orderTotal * 0.2,
        discount: Math.random() > 0.85 ? orderTotal * 0.15 : 0,
        items_count: Math.floor(1 + Math.random() * 3),
        status: Math.random() > 0.1 ? 'fulfilled' : 'unfulfilled',
        financial_status: 'paid',
        fulfillment_status: Math.random() > 0.1 ? 'fulfilled' : null,
        payment_method: Math.random() > 0.4 ? 'shopify_payments' : 'paypal',
        currency: 'USD',
        order_created_at: orderCreatedAt
      });
    }
  }

  return orders;
}


================ FILE: ./server/services/sallaService.js ================
import fetch from 'node-fetch';
import { getDb } from '../db/database.js';
import { formatDateAsGmt3 } from '../utils/dateUtils.js';

export async function fetchSallaOrders(dateStart, dateEnd) {
  const accessToken = process.env.VIRONAX_SALLA_ACCESS_TOKEN;

  if (!accessToken) {
    console.log('Salla credentials not configured - using demo data');
    return getDemoSallaOrders(dateStart, dateEnd);
  }

  try {
    const orders = [];
    let page = 1;
    let hasMore = true;

    while (hasMore) {
      const response = await fetch(`https://api.salla.dev/admin/v2/orders?page=${page}&per_page=50`, {
        headers: {
          'Authorization': `Bearer ${accessToken}`,
          'Content-Type': 'application/json'
        }
      });

      const data = await response.json();

      if (data.data && data.data.length > 0) {
        for (const order of data.data) {
          const orderDate = order.date?.date?.split(' ')[0] || order.created_at?.split('T')[0];
          
          if (orderDate >= dateStart && orderDate <= dateEnd) {
            orders.push({
              order_id: order.id.toString(),
              date: orderDate,
              country: order.shipping?.country?.name || 'Saudi Arabia',
              country_code: order.shipping?.country?.code || 'SA',
              city: order.shipping?.city?.name || order.shipping?.address?.city || null,
              order_total: parseFloat(order.amounts?.total?.amount) || 0,
              subtotal: parseFloat(order.amounts?.sub_total?.amount) || 0,
              shipping: parseFloat(order.amounts?.shipping_cost?.amount) || 0,
              tax: parseFloat(order.amounts?.tax?.amount) || 0,
              discount: parseFloat(order.amounts?.discount?.amount) || 0,
              items_count: order.items?.length || 1,
              status: order.status?.name || 'completed',
              payment_method: order.payment_method || 'unknown',
              currency: order.currency || 'SAR'
            });
          }
        }

        hasMore = data.pagination?.current_page < data.pagination?.total_pages;
        page++;
      } else {
        hasMore = false;
      }
    }

    return orders;
  } catch (error) {
    console.error('Salla API error:', error);
    throw error;
  }
}

export async function syncSallaOrders() {
  const db = getDb();
  const endDate = formatDateAsGmt3(new Date());
  const startDate = formatDateAsGmt3(new Date(Date.now() - 30 * 24 * 60 * 60 * 1000));

  try {
    const orders = await fetchSallaOrders(startDate, endDate);

    const insertStmt = db.prepare(`
      INSERT OR REPLACE INTO salla_orders
      (store, order_id, date, country, country_code, city, order_total, subtotal, shipping, tax, discount, items_count, status, payment_method, currency)
      VALUES ('vironax', ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);

    let recordsInserted = 0;
    for (const order of orders) {
      insertStmt.run(
        order.order_id,
        order.date,
        order.country,
        order.country_code,
        order.city,
        order.order_total,
        order.subtotal,
        order.shipping,
        order.tax,
        order.discount,
        order.items_count,
        order.status,
        order.payment_method,
        order.currency
      );
      recordsInserted++;
    }

    db.prepare(`
      INSERT INTO sync_log (store, source, status, records_synced)
      VALUES ('vironax', 'salla', 'success', ?)
    `).run(recordsInserted);

    return { success: true, records: recordsInserted };
  } catch (error) {
    db.prepare(`
      INSERT INTO sync_log (store, source, status, error_message)
      VALUES ('vironax', 'salla', 'error', ?)
    `).run(error.message);

    throw error;
  }
}

// Demo data for Salla (GCC markets)
function getDemoSallaOrders(dateStart, dateEnd) {
  const countries = [
    { name: 'Saudi Arabia', code: 'SA', share: 0.50, avgOrder: 320 },
    { name: 'United Arab Emirates', code: 'AE', share: 0.25, avgOrder: 380 },
    { name: 'Kuwait', code: 'KW', share: 0.12, avgOrder: 350 },
    { name: 'Qatar', code: 'QA', share: 0.08, avgOrder: 400 },
    { name: 'Oman', code: 'OM', share: 0.05, avgOrder: 290 }
  ];

  const orders = [];
  const start = new Date(dateStart);
  const end = new Date(dateEnd);
  let orderId = 100000;

  for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
    const dateStr = formatDateAsGmt3(d);
    const dayOfWeek = d.getDay();
    const baseOrders = dayOfWeek === 5 || dayOfWeek === 6 ? 28 : 22; // More on weekends
    const dailyOrders = Math.floor(baseOrders * (0.85 + Math.random() * 0.3));

    for (let i = 0; i < dailyOrders; i++) {
      const rand = Math.random();
      let cumShare = 0;
      let selectedCountry = countries[0];

      for (const country of countries) {
        cumShare += country.share;
        if (rand < cumShare) {
          selectedCountry = country;
          break;
        }
      }

      const variance = 0.7 + Math.random() * 0.6;
      const orderTotal = selectedCountry.avgOrder * variance;
      const shipping = Math.random() > 0.7 ? 25 : 0;

      orders.push({
        order_id: (orderId++).toString(),
        date: dateStr,
        country: selectedCountry.name,
        country_code: selectedCountry.code,
        city: null,
        order_total: orderTotal,
        subtotal: orderTotal - shipping,
        shipping: shipping,
        tax: orderTotal * 0.15,
        discount: Math.random() > 0.8 ? orderTotal * 0.1 : 0,
        items_count: Math.floor(1 + Math.random() * 2),
        status: 'completed',
        payment_method: Math.random() > 0.3 ? 'credit_card' : 'cod',
        currency: 'SAR'
      });
    }
  }

  return orders;
}


================ FILE: ./server/services/budgetIntelligenceService.js ================
import { getDb } from '../db/database.js';
import { getAvailableCountries } from './analyticsService.js';
import { formatDateAsGmt3 } from '../utils/dateUtils.js';

const FX_SAR_RATES = {
  SAR: 1,
  USD: 1 / 3.75
};

const BRAND_CONSTANTS = {
  vironax: {
    fallbackCAC: 120,
    fallbackROAS: 2.5,
    targetROAS: 3.0,
    currency: 'SAR'
  },
  shawq: {
    fallbackCAC: 45,
    fallbackROAS: 2.0,
    targetROAS: 2.5,
    currency: 'USD'
  }
};

function getDateRange(params) {
  const now = new Date();
  const today = formatDateAsGmt3(now);

  if (params.startDate && params.endDate) {
    const start = new Date(params.startDate);
    const end = new Date(params.endDate);
    const days = Math.ceil((end - start) / (24 * 60 * 60 * 1000)) + 1;
    return { startDate: params.startDate, endDate: params.endDate, days };
  }

  if (params.yesterday) {
    const yesterday = formatDateAsGmt3(new Date(now.getTime() - 24 * 60 * 60 * 1000));
    return { startDate: yesterday, endDate: yesterday, days: 1 };
  }

  let days = 7;

  if (params.days) days = parseInt(params.days);
  else if (params.weeks) days = parseInt(params.weeks) * 7;
  else if (params.months) days = parseInt(params.months) * 30;

  const endDate = today;
  const startMs = now.getTime() - (days - 1) * 24 * 60 * 60 * 1000;
  const startDate = formatDateAsGmt3(new Date(startMs));

  return { startDate, endDate, days };
}

function getPriorRange(endDate, daysBack = 60) {
  const end = new Date(endDate || new Date());
  const start = new Date(end);
  start.setDate(end.getDate() - (daysBack - 1));
  return {
    startDate: formatDateAsGmt3(start),
    endDate: formatDateAsGmt3(end),
    days: daysBack
  };
}

function sarToCurrency(amount, currency) {
  const rate = FX_SAR_RATES[currency] || 1;
  return amount * rate;
}

function safeDivide(numerator, denominator) {
  if (!denominator) return null;
  return numerator / denominator;
}

function median(values) {
  if (!values || values.length === 0) return null;
  const sorted = [...values].sort((a, b) => a - b);
  const mid = Math.floor(sorted.length / 2);
  return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
}

function computePosterior(priorMean, priorWeight, observedMean, effectiveN) {
  const observed = observedMean == null ? priorMean : observedMean;
  const weight = effectiveN >= 20 ? 3 : priorWeight;
  const obsWeight = effectiveN || 1;
  return ((priorMean * weight) + (observed * obsWeight)) / (weight + obsWeight);
}

function normalCdf(x) {
  // Abramowitz and Stegun approximation
  const t = 1 / (1 + 0.2316419 * Math.abs(x));
  const d = 0.3989423 * Math.exp(-x * x / 2);
  let probability = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
  if (x > 0) {
    probability = 1 - probability;
  }
  return probability;
}

function probabilityAboveThreshold(mean, sigma, target, direction = 'above') {
  if (sigma === 0) return mean >= target ? 1 : 0;
  const z = (target - mean) / sigma;
  const prob = normalCdf(z);
  return direction === 'above' ? 1 - prob : prob;
}

function confidenceLabel(effectiveN) {
  if (effectiveN >= 20) return 'High';
  if (effectiveN >= 8) return 'Medium';
  return 'Low';
}

export function getBudgetIntelligence(store, params) {
  const db = getDb();
  const { startDate, endDate, days } = getDateRange(params);
  const brandDefaults = BRAND_CONSTANTS[store] || BRAND_CONSTANTS.shawq;

  // Priors: use last 60 days ending at selected end date
  const priorRange = getPriorRange(endDate);
  const priorMeta = db.prepare(`
    SELECT SUM(spend) as spend, SUM(conversions) as purchases, SUM(conversion_value) as revenue
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ?
  `).get(store, priorRange.startDate, priorRange.endDate) || {};

  const priorConversions = priorMeta.purchases || 0;
  const priorSpend = priorMeta.spend || 0;
  const priorRevenue = priorMeta.revenue || 0;

  const metaCacSamples = db.prepare(`
    SELECT spend, conversions
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND conversions > 0 AND spend > 0
  `).all(store, priorRange.startDate, priorRange.endDate);

  const cacValues = metaCacSamples.map(row => row.spend / row.conversions).filter(v => v > 0);
  const medianBrandCac = median(cacValues) || brandDefaults.fallbackCAC;

  const priorMeanCAC = priorConversions > 0 && priorSpend > 0
    ? priorSpend / priorConversions
    : brandDefaults.fallbackCAC;
  const priorMeanROAS = priorSpend > 0 ? priorRevenue / priorSpend : brandDefaults.fallbackROAS;

  // Current period meta by campaign x country (excluding ALL)
  const campaignRows = db.prepare(`
    SELECT
      campaign_id as campaignId,
      campaign_name as campaignName,
      country,
      SUM(spend) as spend,
      SUM(conversions) as conversions,
      SUM(conversion_value) as revenue
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country != 'ALL'
    GROUP BY campaign_id, campaign_name, country
  `).all(store, startDate, endDate);

  // Country-level aggregates for observed signal
  const metaByCountry = db.prepare(`
    SELECT country, SUM(spend) as spend, SUM(conversions) as conversions, SUM(conversion_value) as revenue
    FROM meta_daily_metrics
    WHERE store = ? AND date BETWEEN ? AND ? AND country != 'ALL'
    GROUP BY country
  `).all(store, startDate, endDate);

  let ecommerceOrders = [];
  if (store === 'vironax') {
    ecommerceOrders = db.prepare(`
      SELECT country_code as country, COUNT(*) as orders, SUM(order_total) as revenue
      FROM salla_orders
      WHERE store = ? AND date BETWEEN ? AND ? AND country_code IS NOT NULL AND country_code != ''
      GROUP BY country_code
    `).all(store, startDate, endDate);
  } else {
    ecommerceOrders = db.prepare(`
      SELECT country_code as country, COUNT(*) as orders, SUM(subtotal) as revenue
      FROM shopify_orders
      WHERE store = ? AND date BETWEEN ? AND ? AND country_code IS NOT NULL AND country_code != ''
      GROUP BY country_code
    `).all(store, startDate, endDate);
  }

  const manualOrders = db.prepare(`
    SELECT country as country, SUM(spend) as spend, SUM(orders_count) as orders, SUM(revenue) as revenue
    FROM manual_orders
    WHERE store = ? AND date BETWEEN ? AND ?
    GROUP BY country
  `).all(store, startDate, endDate);

  const countryMap = new Map();
  const addToCountry = (code, data) => {
    if (!code) return;
    if (!countryMap.has(code)) {
      countryMap.set(code, { country: code, spend: 0, purchases: 0, revenue: 0, orders: 0 });
    }
    const existing = countryMap.get(code);
    existing.spend += data.spend || 0;
    existing.purchases += data.purchases || 0;
    existing.revenue += data.revenue || 0;
    existing.orders += data.orders || 0;
  };

  metaByCountry.forEach(row => addToCountry(row.country, {
    spend: row.spend,
    purchases: row.conversions,
    revenue: row.revenue
  }));
  ecommerceOrders.forEach(row => addToCountry(row.country, {
    orders: row.orders,
    revenue: row.revenue
  }));
  manualOrders.forEach(row => addToCountry(row.country, {
    spend: row.spend,
    orders: row.orders,
    revenue: row.revenue
  }));

  const availableCountries = getAvailableCountries(store);
  const countryMetadata = new Map(availableCountries.map(c => [c.code, c]));

  const countryStats = Array.from(countryMap.values()).map(row => {
    const meta = countryMetadata.get(row.country) || { name: row.country, flag: 'ðŸ³ï¸' };
    const effectiveN = Math.max(1, row.purchases || row.orders || 1);
    const observedCAC = row.purchases > 0 ? safeDivide(row.spend, row.purchases) : (row.orders > 0 ? safeDivide(row.spend, row.orders) : null);
    const observedROAS = safeDivide(row.revenue, row.spend) || null;
    const posteriorCAC = computePosterior(priorMeanCAC, 8, observedCAC, effectiveN);
    const posteriorROAS = computePosterior(priorMeanROAS, 8, observedROAS, effectiveN);
    const dailySpend = row.spend / days;
    const aov = row.purchases > 0 ? safeDivide(row.revenue, row.purchases) : null;

    return {
      ...meta,
      country: row.country,
      spend: row.spend,
      purchases: row.purchases,
      orders: row.orders,
      revenue: row.revenue,
      aov,
      dailySpend,
      observedCAC,
      observedROAS,
      posteriorCAC,
      posteriorROAS,
      effectiveN
    };
  });

  const comparableDailySpends = countryStats
    .map(c => c.dailySpend)
    .filter(v => v && v > 0);

  const targetPurchasesRange = { min: 8, max: 15 };
  const testDays = 4;
  const minDailySar = 20;
  const maxDailySar = 300;

  const startPlans = countryStats.map(c => {
    const targetPurchases = (targetPurchasesRange.min + targetPurchasesRange.max) / 2;
    const recommendedTotal = c.posteriorCAC * targetPurchases;
    let recommendedDaily = recommendedTotal / testDays;

    // Clamp vs comparable geos
    if (comparableDailySpends.length > 0) {
      let nearest = comparableDailySpends[0];
      let minDiff = Math.abs(recommendedDaily - nearest);
      for (const val of comparableDailySpends) {
        const diff = Math.abs(recommendedDaily - val);
        if (diff < minDiff) {
          minDiff = diff;
          nearest = val;
        }
      }
      recommendedDaily = Math.min(recommendedDaily, nearest * 1.3);
      recommendedDaily = Math.max(recommendedDaily, nearest * 0.7);
    }

    const minDaily = sarToCurrency(minDailySar, brandDefaults.currency);
    const maxDaily = sarToCurrency(maxDailySar, brandDefaults.currency);
    recommendedDaily = Math.min(Math.max(recommendedDaily, minDaily), maxDaily);

    const expectedPurchases = recommendedDaily * testDays / Math.max(c.posteriorCAC || priorMeanCAC, 1);
    const expectedRange = {
      low: Math.max(targetPurchasesRange.min * 0.8, expectedPurchases * 0.8),
      high: Math.min(targetPurchasesRange.max * 1.2, expectedPurchases * 1.2)
    };

    const sigmaRoas = Math.max(0.15, 1 / Math.sqrt(c.effectiveN)) * c.posteriorROAS;
    const confidenceBand = {
      low: c.posteriorROAS - sigmaRoas,
      high: c.posteriorROAS + sigmaRoas
    };

    return {
      country: c.country,
      name: c.name,
      flag: c.flag,
      recommendedDaily,
      recommendedTotal,
      testDays,
      posteriorCAC: c.posteriorCAC,
      posteriorROAS: c.posteriorROAS,
      expectedPurchases: expectedPurchases,
      expectedRange,
      confidence: confidenceLabel(c.effectiveN),
      confidenceBand,
      rationale: c.purchases > 0 || c.orders > 0 ? 'Blended prior + observed performance' : 'Using brand priors only',
      effectiveN: c.effectiveN,
      observedCAC: c.observedCAC,
      observedROAS: c.observedROAS
    };
  });

  // Live guidance table
  const targetCAC = medianBrandCac;
  const minimalSpendSar = 40;
  const minimalSpend = sarToCurrency(minimalSpendSar, brandDefaults.currency);

  const liveGuidance = campaignRows.map(row => {
    const effectiveN = Math.max(1, row.conversions || 0);
    const observedCAC = row.conversions > 0 ? safeDivide(row.spend, row.conversions) : null;
    const observedROAS = safeDivide(row.revenue, row.spend) || null;
    const posteriorCAC = computePosterior(priorMeanCAC, 8, observedCAC, effectiveN);
    const posteriorROAS = computePosterior(priorMeanROAS, 8, observedROAS, effectiveN);

    const sigmaRoas = Math.max(0.15, 1 / Math.sqrt(effectiveN)) * posteriorROAS;
    const sigmaCac = Math.max(0.15, 1 / Math.sqrt(effectiveN)) * posteriorCAC;

    const probRoas = probabilityAboveThreshold(posteriorROAS, sigmaRoas, brandDefaults.targetROAS, 'above');
    const probCac = probabilityAboveThreshold(posteriorCAC, sigmaCac, targetCAC, 'below');

    let action = 'Hold';
    let reason = 'Steady with mixed signals';

    if (row.spend < minimalSpend || effectiveN < 2) {
      action = 'Insufficient Data';
      reason = 'Not enough spend or purchases yet';
    } else if (probRoas >= 0.7 || probCac >= 0.7) {
      action = 'Scale';
      reason = 'High probability of beating targets';
    } else if (probRoas <= 0.3 && probCac <= 0.3) {
      action = 'Cut';
      reason = 'Low probability of meeting targets';
    }

    return {
      campaignId: row.campaignId,
      campaignName: row.campaignName,
      country: row.country,
      spend: row.spend,
      purchases: row.conversions,
      revenue: row.revenue,
      aov: row.conversions > 0 ? row.revenue / row.conversions : null,
      cac: observedCAC,
      roas: observedROAS,
      posteriorCAC,
      posteriorROAS,
      sigmaRoas,
      sigmaCac,
      probRoas,
      probCac,
      action,
      reason,
      effectiveN
    };
  });

  // Learning map scoring
  const learningMap = {
    highPriority: [],
    noisy: [],
    poorFit: [],
    lowSignal: []
  };

  countryStats.forEach(c => {
    if (c.effectiveN < 2) {
      learningMap.lowSignal.push(c);
      return;
    }

    const roasScore = c.posteriorROAS / (priorMeanROAS || 1);
    const cacScore = (priorMeanCAC || 1) / (c.posteriorCAC || priorMeanCAC || 1);
    const signalStrengthBonus = Math.min(0.8, Math.log10(c.effectiveN + 1));
    const score = roasScore + cacScore - 1 + signalStrengthBonus;

    if (score >= 1) learningMap.highPriority.push(c);
    else if (score >= 0.2) learningMap.noisy.push(c);
    else if (score <= -0.2) learningMap.poorFit.push(c);
    else learningMap.lowSignal.push(c);
  });

  return {
    store,
    currency: brandDefaults.currency,
    availableCountries,
    priors: {
      meanCAC: priorMeanCAC,
      meanROAS: priorMeanROAS,
      priorWeight: 8,
      targetROAS: brandDefaults.targetROAS,
      targetCAC,
      medianBrandCac,
      baselineSpend: priorSpend,
      baselinePurchases: priorConversions
    },
    planningDefaults: {
      targetPurchasesRange,
      testDays,
      minDaily: sarToCurrency(minDailySar, brandDefaults.currency),
      maxDaily: sarToCurrency(maxDailySar, brandDefaults.currency),
      comparableDailySpends
    },
    startPlans,
    liveGuidance,
    learningMap,
    period: { startDate, endDate, days },
    priorRange
  };
}

export default getBudgetIntelligence;


================ FILE: ./server/server.js ================
import express from 'express';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import cron from 'node-cron';

import { initDb } from './db/database.js';
import { syncMetaData } from './services/metaService.js';
import { syncSallaOrders } from './services/sallaService.js';
import { syncShopifyOrders } from './services/shopifyService.js';
import analyticsRoutes from './routes/analytics.js';
import manualRoutes from './routes/manual.js';
import budgetIntelligenceRoutes from './routes/budgetIntelligence.js';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const app = express();
const PORT = process.env.PORT || 5000;

// Initialize database
initDb();

// Middleware
app.use(cors());
app.use(express.json());

// API Routes
app.use('/api/analytics', analyticsRoutes);
app.use('/api/manual', manualRoutes);
app.use('/api/budget-intelligence', budgetIntelligenceRoutes);

// List available stores
app.get('/api/stores', (req, res) => {
  res.json([
    { id: 'vironax', name: 'VironaX', tagline: "Men's Jewelry", ecommerce: 'Salla', currency: 'SAR' },
    { id: 'shawq', name: 'Shawq', tagline: 'Palestinian & Syrian Apparel', ecommerce: 'Shopify', currency: 'USD' }
  ]);
});

// Sync endpoint
app.post('/api/sync', async (req, res) => {
  const store = req.query.store;
  
  try {
    if (store) {
      // Sync specific store
      await syncStore(store);
      res.json({ success: true, message: `Synced ${store}` });
    } else {
      // Sync all stores
      await syncAllStores();
      res.json({ success: true, message: 'All stores synced' });
    }
  } catch (error) {
    console.error('Sync error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Sync functions
async function syncStore(store) {
  console.log(`Syncing ${store}...`);
  
  try {
    // Sync Meta data
    const metaResult = await syncMetaData(store);
    console.log(`âœ… Synced ${metaResult.records} Meta records for ${store}`);
  } catch (error) {
    console.error(`Meta sync error for ${store}:`, error.message);
  }
  
  // Sync e-commerce based on store
  try {
    if (store === 'vironax') {
      const sallaResult = await syncSallaOrders();
      console.log(`âœ… Synced ${sallaResult.records} Salla orders for VironaX`);
    } else if (store === 'shawq') {
      const shopifyResult = await syncShopifyOrders();
      console.log(`âœ… Synced ${shopifyResult.records} Shopify orders for Shawq`);
    }
  } catch (error) {
    console.error(`E-commerce sync error for ${store}:`, error.message);
  }
}

async function syncAllStores() {
  console.log('Starting sync for all stores...');
  await syncStore('vironax');
  await syncStore('shawq');
  console.log('All stores synced');
}

// Serve static files in production
if (process.env.NODE_ENV === 'production') {
  app.use(express.static(path.join(__dirname, '../client/dist')));
  
  app.get('*', (req, res) => {
    res.sendFile(path.join(__dirname, '../client/dist/index.html'));
  });
}

// Start server
app.listen(PORT, '0.0.0.0', () => {
  console.log(`Server running on port ${PORT}`);
  console.log('Stores: VironaX (Salla) | Shawq (Shopify)');
  
  // Initial sync after 5 seconds
  setTimeout(async () => {
    console.log('Running initial sync...');
    await syncAllStores();
  }, 5000);
});

// Sync every 15 minutes for fresh Meta data
cron.schedule('*/15 * * * *', async () => {
  console.log('Running 15-minute sync...');
  await syncAllStores();
});


================ FILE: ./server/utils/dateUtils.js ================
// Utility to format dates in GMT+3 (used for order/day-level reporting)
const GMT3_OFFSET_HOURS = 3;
const GMT3_OFFSET_MS = GMT3_OFFSET_HOURS * 60 * 60 * 1000;

export function formatDateAsGmt3(date = new Date()) {
  const gmt3Date = new Date(date.getTime() + GMT3_OFFSET_MS);
  return gmt3Date.toISOString().split('T')[0];
}


================ FILE: ./server/utils/countryData.js ================
const FALLBACK_REGION_CODES = [
  'AF','AX','AL','DZ','AS','AD','AO','AI','AQ','AG','AR','AM','AW','AU','AT','AZ','BS','BH','BD','BB','BY','BE','BZ','BJ','BM','BT','BO','BQ','BA','BW','BV','BR','IO','BN','BG','BF','BI','CV','KH','CM','CA','KY','CF','TD','CL','CN','CX','CC','CO','KM','CG','CD','CK','CR','CI','HR','CU','CW','CY','CZ','DK','DJ','DM','DO','EC','EG','SV','GQ','ER','EE','SZ','ET','FK','FO','FJ','FI','FR','GF','PF','TF','GA','GM','GE','DE','GH','GI','GR','GL','GD','GP','GU','GT','GG','GN','GW','GY','HT','HM','VA','HN','HK','HU','IS','IN','ID','IR','IQ','IE','IM','IL','IT','JM','JP','JE','JO','KZ','KE','KI','KP','KR','KW','KG','LA','LV','LB','LS','LR','LY','LI','LT','LU','MO','MG','MW','MY','MV','ML','MT','MH','MQ','MR','MU','YT','MX','FM','MD','MC','MN','ME','MS','MA','MZ','MM','NA','NR','NP','NL','NC','NZ','NI','NE','NG','NU','NF','MK','MP','NO','OM','PK','PW','PS','PA','PG','PY','PE','PH','PN','PL','PT','PR','QA','RE','RO','RU','RW','BL','SH','KN','LC','MF','PM','VC','WS','SM','ST','SA','SN','RS','SC','SL','SG','SX','SK','SI','SB','SO','ZA','GS','SS','ES','LK','SD','SR','SJ','SE','CH','SY','TW','TJ','TZ','TH','TL','TG','TK','TO','TT','TN','TR','TM','TC','TV','UG','UA','AE','GB','US','UM','UY','UZ','VU','VE','VN','VG','VI','WF','EH','YE','ZM','ZW'
];

function countryCodeToFlag(code) {
  if (!/^[A-Z]{2}$/.test(code)) return 'ðŸ³ï¸';
  const codePoints = [...code].map(char => 127397 + char.charCodeAt(0));
  return String.fromCodePoint(...codePoints);
}

function resolveRegionCodes() {
  return FALLBACK_REGION_CODES;
}

function resolveDisplayNames() {
  if (typeof Intl.DisplayNames === 'function') {
    try {
      return new Intl.DisplayNames(['en'], { type: 'region' });
    } catch (error) {
      return null;
    }
  }
  return null;
}

const REGION_CODES = resolveRegionCodes();
const displayNames = resolveDisplayNames();

const ALL_COUNTRIES = REGION_CODES.map(code => ({
  code,
  name: displayNames ? displayNames.of(code) : code,
  flag: countryCodeToFlag(code)
})).sort((a, b) => a.name.localeCompare(b.name));

export function getAllCountries() {
  return ALL_COUNTRIES;
}

export function getCountryInfo(code) {
  const upperCode = (code || '').toUpperCase();
  return ALL_COUNTRIES.find(c => c.code === upperCode) || { code: upperCode, name: code, flag: 'ðŸ³ï¸' };
}


================ FILE: ./server/package.json ================
{
  "name": "multistore-dashboard-server",
  "version": "1.0.0",
  "type": "module",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "node --watch server.js"
  },
  "dependencies": {
    "better-sqlite3": "^9.4.3",
    "cors": "^2.8.5",
    "express": "^4.18.2",
    "node-cron": "^3.0.3",
    "node-fetch": "^3.3.2"
  }
}


================ FILE: ./server/routes/manual.js ================
import express from 'express';
import { getDb } from '../db/database.js';
import { formatDateAsGmt3 } from '../utils/dateUtils.js';

const router = express.Router();

// Get manual orders
router.get('/', (req, res) => {
  try {
    const db = getDb();
    const store = req.query.store || 'vironax';

    let startDate = req.query.startDate;
    let endDate = req.query.endDate || formatDateAsGmt3(new Date());

    if (!startDate) {
      let days = 7;
      if (req.query.days) days = parseInt(req.query.days);
      else if (req.query.weeks) days = parseInt(req.query.weeks) * 7;
      else if (req.query.months) days = parseInt(req.query.months) * 30;
      else if (req.query.yesterday) days = 1;

      startDate = formatDateAsGmt3(new Date(Date.now() - (days - 1) * 24 * 60 * 60 * 1000));
    }

    const orders = db.prepare(`
      SELECT * FROM manual_orders
      WHERE store = ? AND date BETWEEN ? AND ?
      ORDER BY date DESC, created_at DESC
    `).all(store, startDate, endDate);

    res.json(orders);
  } catch (error) {
    console.error('Get manual orders error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Get manual spend overrides
router.get('/spend', (req, res) => {
  try {
    const db = getDb();
    const store = req.query.store || 'vironax';

    let startDate = req.query.startDate;
    let endDate = req.query.endDate || formatDateAsGmt3(new Date());

    if (!startDate) {
      let days = 7;
      if (req.query.days) days = parseInt(req.query.days);
      else if (req.query.weeks) days = parseInt(req.query.weeks) * 7;
      else if (req.query.months) days = parseInt(req.query.months) * 30;
      else if (req.query.yesterday) days = 1;

      startDate = formatDateAsGmt3(new Date(Date.now() - (days - 1) * 24 * 60 * 60 * 1000));
    }

    const overrides = db.prepare(`
      SELECT * FROM manual_spend_overrides
      WHERE store = ? AND date BETWEEN ? AND ?
      ORDER BY date DESC, created_at DESC
    `).all(store, startDate, endDate);

    res.json(overrides);
  } catch (error) {
    console.error('Get manual spend overrides error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Add manual order
router.post('/', (req, res) => {
  try {
    const db = getDb();
    const store = req.query.store || req.body.store || 'vironax';
    const { date, country, campaign, spend, orders_count, revenue, source, notes } = req.body;
    
    const result = db.prepare(`
      INSERT INTO manual_orders (store, date, country, campaign, spend, orders_count, revenue, source, notes)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(
      store,
      date,
      country,
      campaign || '',
      spend || 0,
      orders_count || 1,
      revenue || 0,
      source || 'whatsapp',
      notes || ''
    );
    
    res.json({ success: true, id: result.lastInsertRowid });
  } catch (error) {
    console.error('Add manual order error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Add manual spend override
router.post('/spend', (req, res) => {
  try {
    const db = getDb();
    const store = req.query.store || req.body.store || 'vironax';
    const { date, country = 'ALL', amount = 0, notes = '' } = req.body;

    const result = db.prepare(`
      INSERT INTO manual_spend_overrides (store, date, country, amount, notes)
      VALUES (?, ?, ?, ?, ?)
      ON CONFLICT(store, date, country) DO UPDATE SET
        amount = excluded.amount,
        notes = excluded.notes,
        updated_at = CURRENT_TIMESTAMP
    `).run(store, date, country, amount, notes);

    res.json({ success: true, id: result.lastInsertRowid });
  } catch (error) {
    console.error('Add manual spend override error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Delete manual spend override
router.delete('/spend/:id', (req, res) => {
  try {
    const db = getDb();
    const { id } = req.params;

    db.prepare('DELETE FROM manual_spend_overrides WHERE id = ?').run(id);
    res.json({ success: true });
  } catch (error) {
    console.error('Delete manual spend override error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Delete single order
router.delete('/:id', (req, res) => {
  try {
    const db = getDb();
    const { id } = req.params;

    db.prepare('DELETE FROM manual_orders WHERE id = ?').run(id);
    res.json({ success: true });
  } catch (error) {
    console.error('Delete manual order error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Bulk delete orders
router.post('/delete-bulk', (req, res) => {
  try {
    const db = getDb();
    const store = req.query.store || req.body.store || 'vironax';
    const { scope, date } = req.body;
    
    let sql = 'DELETE FROM manual_orders WHERE store = ?';
    const params = [store];
    
    if (scope === 'all') {
      // Delete all for this store
    } else if (scope === 'day' && date) {
      sql += ' AND date = ?';
      params.push(date);
    } else if (scope === 'week' && date) {
      const d = new Date(date);
      const weekStart = formatDateAsGmt3(new Date(d.getFullYear(), d.getMonth(), d.getDate() - d.getDay()));
      const weekEnd = formatDateAsGmt3(new Date(d.getFullYear(), d.getMonth(), d.getDate() - d.getDay() + 6));
      sql += ' AND date BETWEEN ? AND ?';
      params.push(weekStart, weekEnd);
    } else if (scope === 'month' && date) {
      const month = date.substring(0, 7);
      sql += " AND date LIKE ?";
      params.push(`${month}%`);
    } else if (scope === 'year' && date) {
      const year = date.substring(0, 4);
      sql += " AND date LIKE ?";
      params.push(`${year}%`);
    }
    
    const result = db.prepare(sql).run(...params);
    res.json({ success: true, deleted: result.changes });
  } catch (error) {
    console.error('Bulk delete error:', error);
    res.status(500).json({ error: error.message });
  }
});

export default router;


================ FILE: ./server/routes/analytics.js ================
// server/routes/analytics.js
import express from 'express';
import {
  getDashboard,
  getEfficiency,
  getEfficiencyTrends,
  getRecommendations,
  getAvailableCountries,
  getCampaignsByCountry,
  getCampaignsByAge,
  getCampaignsByGender,
  getCampaignsByPlacement,
  getCountryTrends,
  getCampaignsByAgeGender,
  getShopifyTimeOfDay
} from '../services/analyticsService.js';
import { importMetaDailyRows } from '../services/metaImportService.js';

const router = express.Router();

// Dashboard endpoint
router.get('/dashboard', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getDashboard(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Dashboard error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Campaigns by country breakdown
router.get('/campaigns/by-country', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getCampaignsByCountry(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Campaigns by country error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Campaigns by age breakdown
router.get('/campaigns/by-age', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getCampaignsByAge(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Campaigns by age error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Campaigns by gender breakdown
router.get('/campaigns/by-gender', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getCampaignsByGender(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Campaigns by gender error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Campaigns by placement breakdown
router.get('/campaigns/by-placement', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getCampaignsByPlacement(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Campaigns by placement error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Campaigns by combined age and gender breakdown
router.get('/campaigns/by-age-gender', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getCampaignsByAgeGender(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Campaigns by age_gender error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Efficiency endpoint
router.get('/efficiency', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getEfficiency(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Efficiency error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Efficiency trends endpoint
router.get('/efficiency/trends', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getEfficiencyTrends(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Efficiency trends error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Recommendations endpoint
router.get('/recommendations', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getRecommendations(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Recommendations error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Get available countries for a store (dynamic from data)
router.get('/countries', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const countries = getAvailableCountries(store);
    res.json(countries);
  } catch (error) {
    console.error('Countries error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Per-country order trends
router.get('/countries/trends', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getCountryTrends(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Country trends error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Shopify time-of-day trends (last 7 days by default)
router.get('/shopify/time-of-day', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getShopifyTimeOfDay(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Shopify time-of-day error:', error);
    res.status(500).json({ error: error.message });
  }
});

// *** NEW: Manual Meta CSV import (temporary replacement for token sync) ***
router.post('/meta/import', (req, res) => {
  try {
    const store = req.query.store || req.body.store || 'vironax';
    const rows = Array.isArray(req.body?.rows) ? req.body.rows : [];

    if (!store) {
      return res.status(400).json({ error: 'store is required' });
    }
    if (rows.length === 0) {
      return res.json({
        ok: true,
        inserted: 0,
        updated: 0,
        skipped: 0,
        reason: 'No rows provided'
      });
    }

    const result = importMetaDailyRows(store, rows);
    res.json({ ok: true, ...result });
  } catch (error) {
    console.error('Meta import error:', error);
    res.status(500).json({ error: error.message || 'Meta import failed' });
  }
});

export default router;


================ FILE: ./server/routes/budgetIntelligence.js ================
import express from 'express';
import { getBudgetIntelligence } from '../services/budgetIntelligenceService.js';

const router = express.Router();

router.get('/', (req, res) => {
  try {
    const store = req.query.store || 'vironax';
    const data = getBudgetIntelligence(store, req.query);
    res.json(data);
  } catch (error) {
    console.error('Budget intelligence error:', error);
    res.status(500).json({ error: error.message });
  }
});

export default router;


================ FILE: ./server/db/database.js ================
import Database from 'better-sqlite3';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

let db = null;

export function initDb() {
  const dbPath = process.env.DATABASE_PATH || path.join(__dirname, '../../data/dashboard.db');
  
  // Ensure data directory exists
  const dataDir = path.dirname(dbPath);
  import('fs').then(fs => {
    if (!fs.existsSync(dataDir)) {
      fs.mkdirSync(dataDir, { recursive: true });
    }
  });

  db = new Database(dbPath);
  db.pragma('journal_mode = WAL');

  // Meta daily metrics - with store column and breakdown fields
  db.exec(`
    CREATE TABLE IF NOT EXISTS meta_daily_metrics (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      store TEXT NOT NULL DEFAULT 'vironax',
      date TEXT NOT NULL,
      campaign_id TEXT NOT NULL,
      campaign_name TEXT NOT NULL,
      country TEXT DEFAULT 'ALL',
      age TEXT DEFAULT '',
      gender TEXT DEFAULT '',
      publisher_platform TEXT DEFAULT '',
      platform_position TEXT DEFAULT '',
      spend REAL DEFAULT 0,
      impressions INTEGER DEFAULT 0,
      reach INTEGER DEFAULT 0,
      clicks INTEGER DEFAULT 0,
      landing_page_views INTEGER DEFAULT 0,
      add_to_cart INTEGER DEFAULT 0,
      checkouts_initiated INTEGER DEFAULT 0,
      conversions INTEGER DEFAULT 0,
      conversion_value REAL DEFAULT 0,
      cpm REAL DEFAULT 0,
      cpc REAL DEFAULT 0,
      ctr REAL DEFAULT 0,
      frequency REAL DEFAULT 0,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(store, date, campaign_id, country, age, gender, publisher_platform, platform_position)
    )
  `);

  // Add columns if they don't exist (for existing databases)
  try {
    db.exec(`ALTER TABLE meta_daily_metrics ADD COLUMN age TEXT DEFAULT ''`);
  } catch (e) { /* column exists */ }
  try {
    db.exec(`ALTER TABLE meta_daily_metrics ADD COLUMN gender TEXT DEFAULT ''`);
  } catch (e) { /* column exists */ }
  try {
    db.exec(`ALTER TABLE meta_daily_metrics ADD COLUMN publisher_platform TEXT DEFAULT ''`);
  } catch (e) { /* column exists */ }
  try {
    db.exec(`ALTER TABLE meta_daily_metrics ADD COLUMN platform_position TEXT DEFAULT ''`);
  } catch (e) { /* column exists */ }
  try {
    db.exec(`ALTER TABLE salla_orders ADD COLUMN city TEXT`);
  } catch (e) { /* column exists */ }
  try {
    db.exec(`ALTER TABLE shopify_orders ADD COLUMN city TEXT`);
  } catch (e) { /* column exists */ }
  try {
    db.exec(`ALTER TABLE shopify_orders ADD COLUMN state TEXT`);
  } catch (e) { /* column exists */ }
  try {
    db.exec(`ALTER TABLE shopify_orders ADD COLUMN order_created_at TEXT`);
  } catch (e) { /* column exists */ }

  // Salla orders (VironaX only)
  db.exec(`
    CREATE TABLE IF NOT EXISTS salla_orders (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      store TEXT NOT NULL DEFAULT 'vironax',
      order_id TEXT UNIQUE,
      date TEXT NOT NULL,
      country TEXT,
      country_code TEXT,
      city TEXT,
      state TEXT,
      order_total REAL DEFAULT 0,
      subtotal REAL DEFAULT 0,
      shipping REAL DEFAULT 0,
      tax REAL DEFAULT 0,
      discount REAL DEFAULT 0,
      items_count INTEGER DEFAULT 1,
      status TEXT,
      payment_method TEXT,
      currency TEXT DEFAULT 'SAR',
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  // Shopify orders (Shawq only)
  db.exec(`
    CREATE TABLE IF NOT EXISTS shopify_orders (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      store TEXT NOT NULL DEFAULT 'shawq',
      order_id TEXT,
      date TEXT NOT NULL,
      country TEXT,
      country_code TEXT,
      city TEXT,
      state TEXT,
      order_total REAL DEFAULT 0,
      subtotal REAL DEFAULT 0,
      shipping REAL DEFAULT 0,
      tax REAL DEFAULT 0,
      discount REAL DEFAULT 0,
      items_count INTEGER DEFAULT 1,
      status TEXT,
      financial_status TEXT,
      fulfillment_status TEXT,
      payment_method TEXT,
      currency TEXT DEFAULT 'USD',
      order_created_at TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(store, order_id)
    )
  `);

  // Manual orders - with store column
  db.exec(`
    CREATE TABLE IF NOT EXISTS manual_orders (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      store TEXT NOT NULL DEFAULT 'vironax',
      date TEXT NOT NULL,
      country TEXT NOT NULL,
      campaign TEXT,
      spend REAL DEFAULT 0,
      orders_count INTEGER DEFAULT 1,
      revenue REAL DEFAULT 0,
      source TEXT DEFAULT 'whatsapp',
      notes TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  try {
    db.exec(`ALTER TABLE manual_orders ADD COLUMN spend REAL DEFAULT 0`);
  } catch (e) { /* column exists */ }

  // Manual spend overrides (per store/date/country)
  db.exec(`
    CREATE TABLE IF NOT EXISTS manual_spend_overrides (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      store TEXT NOT NULL DEFAULT 'vironax',
      date TEXT NOT NULL,
      country TEXT NOT NULL DEFAULT 'ALL',
      amount REAL NOT NULL DEFAULT 0,
      notes TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(store, date, country)
    )
  `);

  // Sync log
  db.exec(`
    CREATE TABLE IF NOT EXISTS sync_log (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      store TEXT NOT NULL DEFAULT 'vironax',
      source TEXT NOT NULL,
      status TEXT NOT NULL,
      records_synced INTEGER DEFAULT 0,
      error_message TEXT,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP
    )
  `);

  // Exchange rates cache
  db.exec(`
    CREATE TABLE IF NOT EXISTS exchange_rates (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      from_currency TEXT NOT NULL,
      to_currency TEXT NOT NULL,
      rate REAL NOT NULL,
      date TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      UNIQUE(from_currency, to_currency, date)
    )
  `);

  // Create indexes for performance
  db.exec(`CREATE INDEX IF NOT EXISTS idx_meta_store_date ON meta_daily_metrics(store, date)`);
  db.exec(`CREATE INDEX IF NOT EXISTS idx_salla_store_date ON salla_orders(store, date)`);
  db.exec(`CREATE INDEX IF NOT EXISTS idx_shopify_store_date ON shopify_orders(store, date)`);
  db.exec(`CREATE INDEX IF NOT EXISTS idx_manual_store_date ON manual_orders(store, date)`);
  db.exec(`CREATE INDEX IF NOT EXISTS idx_manual_spend_store_date ON manual_spend_overrides(store, date)`);

  console.log('âœ… Database initialized');
  return db;
}

export function getDb() {
  if (!db) {
    initDb();
  }
  return db;
}


================ FILE: ./package.json ================
{
  "name": "multistore-dashboard",
  "version": "2.0.0",
  "private": true,
  "scripts": {
    "build": "cd server && npm install && cd ../client && npm install && npm run build",
    "start": "cd server && node server.js"
  }
}


================ FILE: ./railway.json ================
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm run build"
  },
  "deploy": {
    "startCommand": "npm start",
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}


================ FILE: ./client/postcss.config.js ================
export default {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}


================ FILE: ./client/package.json ================
{
  "name": "vironax-client",
  "private": true,
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "recharts": "^2.10.4",
    "lucide-react": "^0.303.0"
  },
  "devDependencies": {
    "@types/react": "^18.2.43",
    "@types/react-dom": "^18.2.17",
    "@vitejs/plugin-react": "^4.2.1",
    "autoprefixer": "^10.4.16",
    "postcss": "^8.4.32",
    "tailwindcss": "^3.4.0",
    "vite": "^5.0.8"
  }
}


================ FILE: ./client/src/data/countries.js ================
export const COUNTRIES = [
  { code: 'AF', name: 'Afghanistan' },
  { code: 'AX', name: 'Ã…land Islands' },
  { code: 'AL', name: 'Albania' },
  { code: 'DZ', name: 'Algeria' },
  { code: 'AS', name: 'American Samoa' },
  { code: 'AD', name: 'Andorra' },
  { code: 'AO', name: 'Angola' },
  { code: 'AI', name: 'Anguilla' },
  { code: 'AQ', name: 'Antarctica' },
  { code: 'AG', name: 'Antigua and Barbuda' },
  { code: 'AR', name: 'Argentina' },
  { code: 'AM', name: 'Armenia' },
  { code: 'AW', name: 'Aruba' },
  { code: 'AU', name: 'Australia' },
  { code: 'AT', name: 'Austria' },
  { code: 'AZ', name: 'Azerbaijan' },
  { code: 'BS', name: 'Bahamas' },
  { code: 'BH', name: 'Bahrain' },
  { code: 'BD', name: 'Bangladesh' },
  { code: 'BB', name: 'Barbados' },
  { code: 'BY', name: 'Belarus' },
  { code: 'BE', name: 'Belgium' },
  { code: 'BZ', name: 'Belize' },
  { code: 'BJ', name: 'Benin' },
  { code: 'BM', name: 'Bermuda' },
  { code: 'BT', name: 'Bhutan' },
  { code: 'BO', name: 'Bolivia' },
  { code: 'BQ', name: 'Bonaire, Sint Eustatius and Saba' },
  { code: 'BA', name: 'Bosnia and Herzegovina' },
  { code: 'BW', name: 'Botswana' },
  { code: 'BV', name: 'Bouvet Island' },
  { code: 'BR', name: 'Brazil' },
  { code: 'IO', name: 'British Indian Ocean Territory' },
  { code: 'BN', name: 'Brunei Darussalam' },
  { code: 'BG', name: 'Bulgaria' },
  { code: 'BF', name: 'Burkina Faso' },
  { code: 'BI', name: 'Burundi' },
  { code: 'CV', name: 'Cabo Verde' },
  { code: 'KH', name: 'Cambodia' },
  { code: 'CM', name: 'Cameroon' },
  { code: 'CA', name: 'Canada' },
  { code: 'KY', name: 'Cayman Islands' },
  { code: 'CF', name: 'Central African Republic' },
  { code: 'TD', name: 'Chad' },
  { code: 'CL', name: 'Chile' },
  { code: 'CN', name: 'China' },
  { code: 'CX', name: 'Christmas Island' },
  { code: 'CC', name: 'Cocos (Keeling) Islands' },
  { code: 'CO', name: 'Colombia' },
  { code: 'KM', name: 'Comoros' },
  { code: 'CG', name: 'Congo' },
  { code: 'CD', name: 'Congo, Democratic Republic of the' },
  { code: 'CK', name: 'Cook Islands' },
  { code: 'CR', name: 'Costa Rica' },
  { code: 'CI', name: "CÃ´te d'Ivoire" },
  { code: 'HR', name: 'Croatia' },
  { code: 'CU', name: 'Cuba' },
  { code: 'CW', name: 'CuraÃ§ao' },
  { code: 'CY', name: 'Cyprus' },
  { code: 'CZ', name: 'Czechia' },
  { code: 'DK', name: 'Denmark' },
  { code: 'DJ', name: 'Djibouti' },
  { code: 'DM', name: 'Dominica' },
  { code: 'DO', name: 'Dominican Republic' },
  { code: 'EC', name: 'Ecuador' },
  { code: 'EG', name: 'Egypt' },
  { code: 'SV', name: 'El Salvador' },
  { code: 'GQ', name: 'Equatorial Guinea' },
  { code: 'ER', name: 'Eritrea' },
  { code: 'EE', name: 'Estonia' },
  { code: 'SZ', name: 'Eswatini' },
  { code: 'ET', name: 'Ethiopia' },
  { code: 'FK', name: 'Falkland Islands (Malvinas)' },
  { code: 'FO', name: 'Faroe Islands' },
  { code: 'FJ', name: 'Fiji' },
  { code: 'FI', name: 'Finland' },
  { code: 'FR', name: 'France' },
  { code: 'GF', name: 'French Guiana' },
  { code: 'PF', name: 'French Polynesia' },
  { code: 'TF', name: 'French Southern Territories' },
  { code: 'GA', name: 'Gabon' },
  { code: 'GM', name: 'Gambia' },
  { code: 'GE', name: 'Georgia' },
  { code: 'DE', name: 'Germany' },
  { code: 'GH', name: 'Ghana' },
  { code: 'GI', name: 'Gibraltar' },
  { code: 'GR', name: 'Greece' },
  { code: 'GL', name: 'Greenland' },
  { code: 'GD', name: 'Grenada' },
  { code: 'GP', name: 'Guadeloupe' },
  { code: 'GU', name: 'Guam' },
  { code: 'GT', name: 'Guatemala' },
  { code: 'GG', name: 'Guernsey' },
  { code: 'GN', name: 'Guinea' },
  { code: 'GW', name: 'Guinea-Bissau' },
  { code: 'GY', name: 'Guyana' },
  { code: 'HT', name: 'Haiti' },
  { code: 'HM', name: 'Heard Island and McDonald Islands' },
  { code: 'VA', name: 'Holy See' },
  { code: 'HN', name: 'Honduras' },
  { code: 'HK', name: 'Hong Kong' },
  { code: 'HU', name: 'Hungary' },
  { code: 'IS', name: 'Iceland' },
  { code: 'IN', name: 'India' },
  { code: 'ID', name: 'Indonesia' },
  { code: 'IR', name: 'Iran' },
  { code: 'IQ', name: 'Iraq' },
  { code: 'IE', name: 'Ireland' },
  { code: 'IM', name: 'Isle of Man' },
  { code: 'IL', name: 'Israel' },
  { code: 'IT', name: 'Italy' },
  { code: 'JM', name: 'Jamaica' },
  { code: 'JP', name: 'Japan' },
  { code: 'JE', name: 'Jersey' },
  { code: 'JO', name: 'Jordan' },
  { code: 'KZ', name: 'Kazakhstan' },
  { code: 'KE', name: 'Kenya' },
  { code: 'KI', name: 'Kiribati' },
  { code: 'KP', name: 'Korea (Democratic People\'s Republic of)' },
  { code: 'KR', name: 'Korea, Republic of' },
  { code: 'KW', name: 'Kuwait' },
  { code: 'KG', name: 'Kyrgyzstan' },
  { code: 'LA', name: "Lao People's Democratic Republic" },
  { code: 'LV', name: 'Latvia' },
  { code: 'LB', name: 'Lebanon' },
  { code: 'LS', name: 'Lesotho' },
  { code: 'LR', name: 'Liberia' },
  { code: 'LY', name: 'Libya' },
  { code: 'LI', name: 'Liechtenstein' },
  { code: 'LT', name: 'Lithuania' },
  { code: 'LU', name: 'Luxembourg' },
  { code: 'MO', name: 'Macao' },
  { code: 'MG', name: 'Madagascar' },
  { code: 'MW', name: 'Malawi' },
  { code: 'MY', name: 'Malaysia' },
  { code: 'MV', name: 'Maldives' },
  { code: 'ML', name: 'Mali' },
  { code: 'MT', name: 'Malta' },
  { code: 'MH', name: 'Marshall Islands' },
  { code: 'MQ', name: 'Martinique' },
  { code: 'MR', name: 'Mauritania' },
  { code: 'MU', name: 'Mauritius' },
  { code: 'YT', name: 'Mayotte' },
  { code: 'MX', name: 'Mexico' },
  { code: 'FM', name: 'Micronesia (Federated States of)' },
  { code: 'MD', name: 'Moldova, Republic of' },
  { code: 'MC', name: 'Monaco' },
  { code: 'MN', name: 'Mongolia' },
  { code: 'ME', name: 'Montenegro' },
  { code: 'MS', name: 'Montserrat' },
  { code: 'MA', name: 'Morocco' },
  { code: 'MZ', name: 'Mozambique' },
  { code: 'MM', name: 'Myanmar' },
  { code: 'NA', name: 'Namibia' },
  { code: 'NR', name: 'Nauru' },
  { code: 'NP', name: 'Nepal' },
  { code: 'NL', name: 'Netherlands' },
  { code: 'NC', name: 'New Caledonia' },
  { code: 'NZ', name: 'New Zealand' },
  { code: 'NI', name: 'Nicaragua' },
  { code: 'NE', name: 'Niger' },
  { code: 'NG', name: 'Nigeria' },
  { code: 'NU', name: 'Niue' },
  { code: 'NF', name: 'Norfolk Island' },
  { code: 'MK', name: 'North Macedonia' },
  { code: 'MP', name: 'Northern Mariana Islands' },
  { code: 'NO', name: 'Norway' },
  { code: 'OM', name: 'Oman' },
  { code: 'PK', name: 'Pakistan' },
  { code: 'PW', name: 'Palau' },
  { code: 'PS', name: 'Palestine, State of' },
  { code: 'PA', name: 'Panama' },
  { code: 'PG', name: 'Papua New Guinea' },
  { code: 'PY', name: 'Paraguay' },
  { code: 'PE', name: 'Peru' },
  { code: 'PH', name: 'Philippines' },
  { code: 'PN', name: 'Pitcairn' },
  { code: 'PL', name: 'Poland' },
  { code: 'PT', name: 'Portugal' },
  { code: 'PR', name: 'Puerto Rico' },
  { code: 'QA', name: 'Qatar' },
  { code: 'RE', name: 'RÃ©union' },
  { code: 'RO', name: 'Romania' },
  { code: 'RU', name: 'Russian Federation' },
  { code: 'RW', name: 'Rwanda' },
  { code: 'BL', name: 'Saint BarthÃ©lemy' },
  { code: 'SH', name: 'Saint Helena, Ascension and Tristan da Cunha' },
  { code: 'KN', name: 'Saint Kitts and Nevis' },
  { code: 'LC', name: 'Saint Lucia' },
  { code: 'MF', name: 'Saint Martin (French part)' },
  { code: 'PM', name: 'Saint Pierre and Miquelon' },
  { code: 'VC', name: 'Saint Vincent and the Grenadines' },
  { code: 'WS', name: 'Samoa' },
  { code: 'SM', name: 'San Marino' },
  { code: 'ST', name: 'Sao Tome and Principe' },
  { code: 'SA', name: 'Saudi Arabia' },
  { code: 'SN', name: 'Senegal' },
  { code: 'RS', name: 'Serbia' },
  { code: 'SC', name: 'Seychelles' },
  { code: 'SL', name: 'Sierra Leone' },
  { code: 'SG', name: 'Singapore' },
  { code: 'SX', name: 'Sint Maarten (Dutch part)' },
  { code: 'SK', name: 'Slovakia' },
  { code: 'SI', name: 'Slovenia' },
  { code: 'SB', name: 'Solomon Islands' },
  { code: 'SO', name: 'Somalia' },
  { code: 'ZA', name: 'South Africa' },
  { code: 'GS', name: 'South Georgia and the South Sandwich Islands' },
  { code: 'SS', name: 'South Sudan' },
  { code: 'ES', name: 'Spain' },
  { code: 'LK', name: 'Sri Lanka' },
  { code: 'SD', name: 'Sudan' },
  { code: 'SR', name: 'Suriname' },
  { code: 'SJ', name: 'Svalbard and Jan Mayen' },
  { code: 'SE', name: 'Sweden' },
  { code: 'CH', name: 'Switzerland' },
  { code: 'SY', name: 'Syrian Arab Republic' },
  { code: 'TW', name: 'Taiwan, Province of China' },
  { code: 'TJ', name: 'Tajikistan' },
  { code: 'TZ', name: 'Tanzania, United Republic of' },
  { code: 'TH', name: 'Thailand' },
  { code: 'TL', name: 'Timor-Leste' },
  { code: 'TG', name: 'Togo' },
  { code: 'TK', name: 'Tokelau' },
  { code: 'TO', name: 'Tonga' },
  { code: 'TT', name: 'Trinidad and Tobago' },
  { code: 'TN', name: 'Tunisia' },
  { code: 'TR', name: 'TÃ¼rkiye' },
  { code: 'TM', name: 'Turkmenistan' },
  { code: 'TC', name: 'Turks and Caicos Islands' },
  { code: 'TV', name: 'Tuvalu' },
  { code: 'UG', name: 'Uganda' },
  { code: 'UA', name: 'Ukraine' },
  { code: 'AE', name: 'United Arab Emirates' },
  { code: 'GB', name: 'United Kingdom of Great Britain and Northern Ireland' },
  { code: 'US', name: 'United States of America' },
  { code: 'UM', name: 'United States Minor Outlying Islands' },
  { code: 'UY', name: 'Uruguay' },
  { code: 'UZ', name: 'Uzbekistan' },
  { code: 'VU', name: 'Vanuatu' },
  { code: 'VE', name: 'Venezuela (Bolivarian Republic of)' },
  { code: 'VN', name: 'Viet Nam' },
  { code: 'VG', name: 'Virgin Islands (British)' },
  { code: 'VI', name: 'Virgin Islands (U.S.)' },
  { code: 'WF', name: 'Wallis and Futuna' },
  { code: 'EH', name: 'Western Sahara' },
  { code: 'YE', name: 'Yemen' },
  { code: 'ZM', name: 'Zambia' },
  { code: 'ZW', name: 'Zimbabwe' }
];

export default COUNTRIES;


================ FILE: ./client/src/App.jsx ================
// client/src/App.jsx
import { Fragment, useState, useEffect, useCallback, useMemo } from 'react';
import { 
  LineChart, Line, AreaChart, Area,
  XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer 
} from 'recharts';
import {
  RefreshCw, TrendingUp, TrendingDown, Plus, Trash2,
  Store, ChevronDown, ChevronUp, ArrowUpDown, Calendar, Bell
} from 'lucide-react';
import { COUNTRIES as MASTER_COUNTRIES } from './data/countries';

const API_BASE = '/api';

const getLocalDateString = (date = new Date()) => {
  const offsetMs = date.getTimezoneOffset() * 60 * 1000;
  const localDate = new Date(date.getTime() - offsetMs);
  return localDate.toISOString().split('T')[0];
};

const countryCodeToFlag = (code) => {
  if (!code || !/^[A-Z]{2}$/i.test(code)) return 'ðŸ³ï¸';
  return String.fromCodePoint(...code.toUpperCase().split('').map(char => 127397 + char.charCodeAt(0)));
};

const MASTER_COUNTRIES_WITH_FLAGS = MASTER_COUNTRIES.map(country => ({
  ...country,
  flag: countryCodeToFlag(country.code)
}));

const STORES = {
  vironax: {
    id: 'vironax',
    name: 'VironaX',
    tagline: "Men's Jewelry",
    currency: 'SAR',
    currencySymbol: 'SAR',
    ecommerce: 'Salla',
    defaultAOV: 280
  },
  shawq: {
    id: 'shawq',
    name: 'Shawq',
    tagline: 'Palestinian & Syrian Apparel',
    currency: 'USD',
    currencySymbol: '$',
    ecommerce: 'Shopify',
    defaultAOV: 75
  }
};

const TABS = ['Dashboard', 'Budget Efficiency', 'Budget Intelligence', 'Manual Data'];

export default function App() {
  const [currentStore, setCurrentStore] = useState('vironax');
  const [storeLoaded, setStoreLoaded] = useState(false);
  const [storeDropdownOpen, setStoreDropdownOpen] = useState(false);
  const [activeTab, setActiveTab] = useState(0);
  const [loading, setLoading] = useState(true);
  const [syncing, setSyncing] = useState(false);
  
  const [dateRange, setDateRange] = useState({ type: 'days', value: 7 });
  const [customRange, setCustomRange] = useState({
    start: getLocalDateString(new Date(Date.now() - 6 * 24 * 60 * 60 * 1000)),
    end: getLocalDateString()
  });
  const [showCustomPicker, setShowCustomPicker] = useState(false);
  
  const [dashboard, setDashboard] = useState(null);
  const [efficiency, setEfficiency] = useState(null);
  const [efficiencyTrends, setEfficiencyTrends] = useState([]);
  const [recommendations, setRecommendations] = useState([]);
  const [budgetIntelligence, setBudgetIntelligence] = useState(null);
  const [manualOrders, setManualOrders] = useState([]);
  const [manualSpendOverrides, setManualSpendOverrides] = useState([]);
  const [availableCountries, setAvailableCountries] = useState([]);
  const [metaBreakdownData, setMetaBreakdownData] = useState([]);
  const [shopifyTimeOfDay, setShopifyTimeOfDay] = useState({ data: [], timezone: 'America/Chicago', sampleTimestamps: [] });
  const [selectedShopifyRegion, setSelectedShopifyRegion] = useState('us');
  const [notifications, setNotifications] = useState([]);
  const [showNotificationPanel, setShowNotificationPanel] = useState(false);
  
  // KPI charts
  const [expandedKpis, setExpandedKpis] = useState([]);
  // Section 2 breakdown (pure meta)
  const [metaBreakdown, setMetaBreakdown] = useState('none');
  // Country trends
  const [countryTrends, setCountryTrends] = useState([]);

  const store = STORES[currentStore];
  const [orderForm, setOrderForm] = useState({
    date: getLocalDateString(),
    country: 'SA',
    campaign: '',
    spend: 0,
    orders_count: 1,
    revenue: 280,
    source: 'whatsapp',
    notes: ''
  });
  const [spendOverrideForm, setSpendOverrideForm] = useState({
    date: getLocalDateString(),
    country: 'ALL',
    amount: 0,
    notes: ''
  });

  // Load store from localStorage on mount
  useEffect(() => {
    try {
      const saved = localStorage.getItem('selectedStore');
      if (saved && STORES[saved]) {
        setCurrentStore(saved);
      }
    } catch (e) {
      console.error('Error reading localStorage:', e);
    }
    setStoreLoaded(true);
  }, []);

  // Save store selection to localStorage whenever it changes
  useEffect(() => {
    if (!storeLoaded) return;
    try {
      localStorage.setItem('selectedStore', currentStore);
    } catch (e) {
      console.error('Error writing localStorage:', e);
    }
  }, [currentStore, storeLoaded]);

  useEffect(() => {
    const newStore = STORES[currentStore];
    setOrderForm(prev => ({
      ...prev,
      country: currentStore === 'vironax' ? 'SA' : 'US',
      revenue: newStore.defaultAOV
    }));
  }, [currentStore]);


  const loadData = useCallback(async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams({ store: currentStore });
      
      if (dateRange.type === 'custom') {
        params.set('startDate', dateRange.start);
        params.set('endDate', dateRange.end);
      } else if (dateRange.type === 'yesterday') {
        params.set('yesterday', '1');
      } else {
        params.set(dateRange.type, dateRange.value);
      }

      const shopifyRegion = selectedShopifyRegion ?? 'us';
      const timeOfDayParams = new URLSearchParams({ store: currentStore, days: 7, region: shopifyRegion });

      const [
        dashData,
        effData,
        effTrends,
        recs,
        intel,
        orders,
        spendOverrides,
        countries,
        cTrends,
        timeOfDay
      ] = await Promise.all([
        fetch(`${API_BASE}/analytics/dashboard?${params}`).then(r => r.json()),
        fetch(`${API_BASE}/analytics/efficiency?${params}`).then(r => r.json()),
        fetch(`${API_BASE}/analytics/efficiency/trends?${params}`).then(r => r.json()),
        fetch(`${API_BASE}/analytics/recommendations?${params}`).then(r => r.json()),
        fetch(`${API_BASE}/budget-intelligence?${params}`).then(r => r.json()),
        fetch(`${API_BASE}/manual?${params}`).then(r => r.json()),
        fetch(`${API_BASE}/manual/spend?${params}`).then(r => r.json()),
        fetch(`${API_BASE}/analytics/countries?store=${currentStore}`).then(r => r.json()),
        fetch(`${API_BASE}/analytics/countries/trends?${params}`).then(r => r.json()),
        currentStore === 'shawq'
          ? fetch(`${API_BASE}/analytics/shopify/time-of-day?${timeOfDayParams}`).then(r => r.json())
          : Promise.resolve({ data: [], timezone: shopifyRegion === 'europe' ? 'Europe/London' : shopifyRegion === 'all' ? 'UTC' : 'America/Chicago', sampleTimestamps: [] })
      ]);

      setDashboard(dashData);
      setEfficiency(effData);
      setEfficiencyTrends(effTrends);
      setRecommendations(recs);
      setBudgetIntelligence(intel);
      setManualOrders(orders);
      setManualSpendOverrides(spendOverrides);

      const safeCountries = (Array.isArray(countries) && countries.length > 0)
        ? countries.map(country => ({ ...country, flag: country.flag || countryCodeToFlag(country.code) }))
        : MASTER_COUNTRIES_WITH_FLAGS;

      setAvailableCountries(safeCountries);
      setOrderForm(prev =>
        safeCountries.some(c => c.code === prev.country)
          ? prev
          : { ...prev, country: safeCountries[0]?.code || prev.country }
      );

      setSpendOverrideForm(prev => {
        if (prev.country === 'ALL') return prev;
        return safeCountries.some(c => c.code === prev.country)
          ? prev
          : { ...prev, country: safeCountries[0]?.code || prev.country };
      });

      setCountryTrends(cTrends);
      const timeOfDayData = Array.isArray(timeOfDay?.data) ? timeOfDay.data : [];
      const timeOfDayZone = typeof timeOfDay?.timezone === 'string' ? timeOfDay.timezone : null;
      const timeOfDaySamples = Array.isArray(timeOfDay?.sampleTimestamps) ? timeOfDay.sampleTimestamps.slice(0, 5) : [];
      const fallbackTimezone = shopifyRegion === 'europe' ? 'Europe/London' : shopifyRegion === 'all' ? 'UTC' : 'America/Chicago';
      const safeTimezone = timeOfDayZone || fallbackTimezone;
      setShopifyTimeOfDay({ data: timeOfDayData, timezone: safeTimezone, sampleTimestamps: timeOfDaySamples });
    } catch (error) {
      console.error('Error loading data:', error);
    }
    setLoading(false);
  }, [currentStore, dateRange, selectedShopifyRegion]);

  useEffect(() => {
    if (storeLoaded) {
      loadData();
    }
  }, [loadData, storeLoaded]);

  // Load breakdown data for Section 2 (pure meta)
  useEffect(() => {
    if (!storeLoaded) return;

    async function loadBreakdown() {
      if (metaBreakdown === 'none') {
        setMetaBreakdownData([]);
        return;
      }

      try {
        const params = new URLSearchParams({ store: currentStore });

        if (dateRange.type === 'custom') {
          params.set('startDate', dateRange.start);
          params.set('endDate', dateRange.end);
        } else if (dateRange.type === 'yesterday') {
          params.set('yesterday', '1');
        } else {
          params.set(dateRange.type, dateRange.value);
        }

        const endpoint = metaBreakdown === 'age_gender'
          ? `${API_BASE}/analytics/campaigns/by-age-gender?${params}`
          : `${API_BASE}/analytics/campaigns/by-${metaBreakdown}?${params}`;
        const data = await fetch(endpoint).then(r => r.json());
        setMetaBreakdownData(data);
      } catch (error) {
        console.error('Error loading breakdown:', error);
        setMetaBreakdownData([]);
      }
    }

    loadBreakdown();
  }, [metaBreakdown, currentStore, dateRange, storeLoaded]);

  async function handleSync() {
    setSyncing(true);
    try {
      await fetch(`${API_BASE}/sync?store=${currentStore}`, { method: 'POST' });
      await loadData();
    } catch (error) {
      console.error('Sync error:', error);
    }
    setSyncing(false);
  }

  async function handleAddOrder(e) {
    e.preventDefault();
    try {
      await fetch(`${API_BASE}/manual?store=${currentStore}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderForm)
      });
      setOrderForm(prev => ({
        ...prev,
        spend: 0,
        orders_count: 1,
        revenue: STORES[currentStore].defaultAOV,
        notes: ''
      }));
      try {
        const newNotification = {
          id: Date.now(),
          type: 'order',
          message: `New order added: ${orderForm.orders_count || 1} order(s) for ${formatCurrency(orderForm.revenue || 0)}`,
          timestamp: new Date().toISOString(),
          country: orderForm.country || '',
          source: orderForm.source || ''
        };
        setNotifications(prev => Array.isArray(prev) ? [newNotification, ...prev].slice(0, 10) : [newNotification]);
      } catch (e) {
        console.error('Notification error:', e);
      }
      loadData();
    } catch (error) {
      console.error('Error adding order:', error);
    }
  }

  async function handleAddSpendOverride(e) {
    e.preventDefault();
    try {
      await fetch(`${API_BASE}/manual/spend?store=${currentStore}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(spendOverrideForm)
      });
      setSpendOverrideForm(prev => ({
        ...prev,
        amount: 0,
        notes: ''
      }));
      loadData();
    } catch (error) {
      console.error('Error adding spend override:', error);
    }
  }

  async function handleDeleteOrder(id) {
    if (!confirm('Delete this order?')) return;
    try {
      await fetch(`${API_BASE}/manual/${id}`, { method: 'DELETE' });
      loadData();
    } catch (error) {
      console.error('Error deleting order:', error);
    }
  }

  async function handleDeleteSpendOverride(id) {
    if (!confirm('Delete this manual spend entry?')) return;
    try {
      await fetch(`${API_BASE}/manual/spend/${id}`, { method: 'DELETE' });
      loadData();
    } catch (error) {
      console.error('Error deleting manual spend:', error);
    }
  }

  async function handleBulkDelete(scope, date) {
    if (!confirm(`Delete all manual data for ${scope}?`)) return;
    try {
      await fetch(`${API_BASE}/manual/delete-bulk?store=${currentStore}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scope, date })
      });
      loadData();
    } catch (error) {
      console.error('Bulk delete error:', error);
    }
  }

  const formatCurrency = (value, decimals = 0) => {
    const symbol = store.currencySymbol;
    if (symbol === '$') {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      }).format(value || 0);
    }
    return `${Math.round(value || 0).toLocaleString()} ${symbol}`;
  };

  const formatNumber = (value) => {
    const v = value || 0;
    if (v >= 1000000) return (v / 1000000).toFixed(2) + 'M';
    if (v >= 1000) return (v / 1000).toFixed(1) + 'K';
    return Math.round(v).toString();
  };

  const formatNotificationTime = (timestamp) => {
    if (!timestamp) return '';
    try {
      return new Date(timestamp).toLocaleString('en-US', {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit'
      });
    } catch {
      return '';
    }
  };

  const getDateRangeLabel = () => {
    if (dateRange.type === 'custom') {
      const formatDate = (d) => {
        const date = new Date(d);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      };
      return `${formatDate(dateRange.start)} - ${formatDate(dateRange.end)}`;
    }
    if (dateRange.type === 'yesterday') return 'Yesterday';
    if (dateRange.type === 'days' && dateRange.value === 1) return 'Today';
    if (dateRange.type === 'days') return `Last ${dateRange.value} days`;
    if (dateRange.type === 'weeks') return `Last ${dateRange.value} weeks`;
    if (dateRange.type === 'months') return `Last ${dateRange.value} months`;
    return 'Custom';
  };

  if (!storeLoaded || (loading && !dashboard)) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-center">
          <RefreshCw className="w-8 h-8 animate-spin mx-auto mb-4 text-indigo-500" />
          <p className="text-gray-500">Loading dashboard...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b border-gray-200 sticky top-0 z-50">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <div className="relative">
                <button
                  onClick={() => setStoreDropdownOpen(!storeDropdownOpen)}
                  className="flex items-center gap-2 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
                >
                  <Store className="w-4 h-4 text-gray-600" />
                  <span className="font-bold text-gray-900">{store.name}</span>
                  <ChevronDown
                    className={`w-4 h-4 text-gray-500 transition-transform ${
                      storeDropdownOpen ? 'rotate-180' : ''
                    }`}
                  />
                </button>
                
                {storeDropdownOpen && (
                  <div className="absolute top-full left-0 mt-1 w-64 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-50">
                    {Object.values(STORES).map(s => (
                      <button
                        key={s.id}
                        onClick={() => {
                          setCurrentStore(s.id);
                          setStoreDropdownOpen(false);
                          setExpandedKpis([]);
                        }}
                        className={`w-full px-4 py-3 text-left hover:bg-gray-50 ${
                          currentStore === s.id ? 'bg-indigo-50' : ''
                        }`}
                      >
                        <div className="font-semibold text-gray-900">{s.name}</div>
                        <div className="text-sm text-gray-500">
                          {s.tagline} â€¢ {s.ecommerce}
                        </div>
                      </button>
                    ))}
                  </div>
                )}
              </div>
              
              <span className="px-2 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded">
                Dashboard
              </span>
            </div>
            
            <div className="flex items-center gap-4">
              <span className="text-sm text-gray-500">
                {dashboard?.dateRange &&
                  `${dashboard.dateRange.startDate} to ${dashboard.dateRange.endDate}`}
              </span>
              <div className="relative">
                <button
                  type="button"
                  onClick={() => setShowNotificationPanel(prev => !prev)}
                  className={`relative p-2 rounded-lg border text-sm font-medium transition-colors ${
                    showNotificationPanel ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50'
                  }`}
                  aria-label="Order notifications"
                >
                  <Bell className="w-4 h-4" />
                  {Array.isArray(notifications) && notifications.length > 0 && (
                    <span className="absolute -top-1 -right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-[10px] font-bold text-white ring-2 ring-white">
                      {notifications.length > 9 ? '9+' : notifications.length}
                    </span>
                  )}
                </button>
                {showNotificationPanel && (
                  <div className="absolute right-0 mt-2 w-80 rounded-xl border border-gray-200 bg-white shadow-lg z-50">
                    <div className="flex items-center justify-between p-3 border-b border-gray-100">
                      <span className="text-sm font-semibold text-gray-900">Notifications</span>
                      {Array.isArray(notifications) && notifications.length > 0 && (
                        <button
                          onClick={() => setNotifications([])}
                          className="text-xs text-gray-500 hover:text-gray-700"
                        >
                          Clear all
                        </button>
                      )}
                    </div>
                    <div className="max-h-64 overflow-y-auto">
                      {Array.isArray(notifications) && notifications.length > 0 ? (
                        notifications.map((notif) => (
                          <div key={notif?.id || Math.random()} className="p-3 border-b border-gray-50 last:border-b-0 hover:bg-gray-50">
                            <p className="text-sm text-gray-900">{notif?.message || 'New order'}</p>
                            <p className="text-xs text-gray-500 mt-1">
                              {notif?.source && <span className="capitalize">{notif.source}</span>}
                              {notif?.country && <span> â€¢ {notif.country}</span>}
                              {notif?.timestamp && <span> â€¢ {formatNotificationTime(notif.timestamp)}</span>}
                            </p>
                          </div>
                        ))
                      ) : (
                        <p className="p-4 text-sm text-gray-500 text-center">No notifications yet</p>
                      )}
                    </div>
                  </div>
                )}
              </div>
              <button
                onClick={handleSync}
                disabled={syncing}
                className="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-colors"
              >
                <RefreshCw className={`w-4 h-4 ${syncing ? 'animate-spin' : ''}`} />
                {syncing ? 'Syncing...' : 'Refresh'}
              </button>
            </div>
          </div>
        </div>
      </header>

      <div className="max-w-7xl mx-auto px-4 py-6">
        <div className="flex gap-1 bg-white p-1.5 rounded-xl shadow-sm mb-6 w-fit">
          {TABS.map((tab, i) => (
            <button
              key={tab}
              onClick={() => setActiveTab(i)}
              className={`px-5 py-2.5 rounded-lg text-sm font-medium transition-all ${
                activeTab === i 
                  ? 'bg-gray-900 text-white' 
                  : 'text-gray-600 hover:bg-gray-100'
              }`}
            >
              {tab}
            </button>
          ))}
        </div>

        {/* Date Range Picker */}
        <div className="flex items-center gap-3 bg-white p-4 rounded-xl shadow-sm mb-6 flex-wrap">
          <span className="text-sm font-medium text-gray-700">Period:</span>
          
          {/* Today */}
          <button
            onClick={() => { setDateRange({ type: 'days', value: 1 }); setShowCustomPicker(false); }}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              dateRange.type === 'days' && dateRange.value === 1
                ? 'bg-indigo-600 text-white'
                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
            }`}
          >
            Today
          </button>
          
          {/* Yesterday */}
          <button
            onClick={() => { setDateRange({ type: 'yesterday', value: 1 }); setShowCustomPicker(false); }}
            className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
              dateRange.type === 'yesterday'
                ? 'bg-indigo-600 text-white'
                : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
            }`}
          >
            Yesterday
          </button>
          
          {[3, 7, 14, 30].map(d => (
            <button
              key={d}
              onClick={() => { setDateRange({ type: 'days', value: d }); setShowCustomPicker(false); }}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                dateRange.type === 'days' && dateRange.value === d
                  ? 'bg-indigo-600 text-white'
                  : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
              }`}
            >
              {d}D
            </button>
          ))}

          {/* Custom Range */}
          <div className="relative">
            <button
              onClick={() => setShowCustomPicker(!showCustomPicker)}
              className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 ${
                dateRange.type === 'custom'
                  ? 'bg-indigo-600 text-white'
                  : 'bg-gray-100 hover:bg-gray-200 text-gray-700'
              }`}
            >
              <Calendar className="w-4 h-4" />
              Custom
            </button>
            
            {showCustomPicker && (
              <div className="absolute top-full mt-2 left-0 bg-white rounded-xl shadow-lg border border-gray-200 p-4 z-50 min-w-[280px]">
                <div className="space-y-3">
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">
                      Start Date
                    </label>
                    <input
                      type="date"
                      value={customRange.start}
                      onChange={(e) => setCustomRange({ ...customRange, start: e.target.value })}
                      max={customRange.end || getLocalDateString()}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">
                      End Date
                    </label>
                    <input
                      type="date"
                      value={customRange.end}
                      onChange={(e) => setCustomRange({ ...customRange, end: e.target.value })}
                      min={customRange.start}
                      max={getLocalDateString()}
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    />
                  </div>
                  <div className="flex gap-2 pt-2">
                    <button
                      onClick={() => {
                        if (customRange.start && customRange.end) {
                          setDateRange({ type: 'custom', start: customRange.start, end: customRange.end });
                          setShowCustomPicker(false);
                        }
                      }}
                      disabled={!customRange.start || !customRange.end}
                      className="flex-1 px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      Apply
                    </button>
                    <button
                      onClick={() => setShowCustomPicker(false)}
                      className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>

          <div className="ml-auto text-sm text-gray-500">
            Showing: <strong>{getDateRangeLabel()}</strong>
          </div>
        </div>

        {activeTab === 0 && dashboard && (
          <DashboardTab
            dashboard={dashboard}
            expandedKpis={expandedKpis}
            setExpandedKpis={setExpandedKpis}
            formatCurrency={formatCurrency}
            formatNumber={formatNumber}
            metaBreakdown={metaBreakdown}
            setMetaBreakdown={setMetaBreakdown}
            metaBreakdownData={metaBreakdownData}
            store={store}
            countryTrends={countryTrends}
            shopifyTimeOfDay={shopifyTimeOfDay}
            selectedShopifyRegion={selectedShopifyRegion}
            setSelectedShopifyRegion={setSelectedShopifyRegion}
          />
          )}
        
        {activeTab === 1 && efficiency && (
          <EfficiencyTab
            efficiency={efficiency}
            trends={efficiencyTrends}
            recommendations={recommendations}
            formatCurrency={formatCurrency}
          />
        )}

        {activeTab === 2 && budgetIntelligence && (
          <BudgetIntelligenceTab
            data={budgetIntelligence}
            formatCurrency={formatCurrency}
            store={store}
          />
        )}

        {activeTab === 3 && (
          <ManualDataTab
            orders={manualOrders}
            form={orderForm}
            setForm={setOrderForm}
            onSubmit={handleAddOrder}
            onDelete={handleDeleteOrder}
            manualSpendOverrides={manualSpendOverrides}
            spendOverrideForm={spendOverrideForm}
            setSpendOverrideForm={setSpendOverrideForm}
            onAddSpendOverride={handleAddSpendOverride}
            onDeleteSpendOverride={handleDeleteSpendOverride}
            onBulkDelete={handleBulkDelete}
            formatCurrency={formatCurrency}
            store={store}
            availableCountries={availableCountries}
          />
        )}
      </div>
      
      {storeDropdownOpen && (
        <div className="fixed inset-0 z-40" onClick={() => setStoreDropdownOpen(false)} />
      )}
    </div>
  );
}

function SortableHeader({ label, field, sortConfig, onSort, className = '' }) {
  const isActive = sortConfig.field === field;
  const isAsc = isActive && sortConfig.direction === 'asc';
  
  return (
    <th 
      className={`cursor-pointer hover:bg-gray-100 select-none ${className}`}
      onClick={() => onSort(field)}
    >
      <div className="flex items-center gap-1 justify-center">
        {label}
        {isActive ? (
          isAsc ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />
        ) : (
          <ArrowUpDown className="w-3 h-3 opacity-30" />
        )}
      </div>
    </th>
  );
}

function DashboardTab({
  dashboard = {},
  expandedKpis = [],
  setExpandedKpis = () => {},
  formatCurrency = () => 0,
  formatNumber = () => 0,
  metaBreakdown = 'none',
  setMetaBreakdown = () => {},
  metaBreakdownData = [],
  store = {},
  countryTrends = [],
  shopifyTimeOfDay = { data: [], timezone: 'America/Chicago', sampleTimestamps: [] },
  selectedShopifyRegion = 'us',
  setSelectedShopifyRegion = () => {}
}) {
  const { overview = {}, trends = {}, campaigns = [], countries = [], diagnostics = {} } = dashboard || {};

  const [countrySortConfig, setCountrySortConfig] = useState({ field: 'totalOrders', direction: 'desc' });
  const [campaignSortConfig, setCampaignSortConfig] = useState({ field: 'spend', direction: 'desc' });
  const [showCountryTrends, setShowCountryTrends] = useState(false);
  const [metaView, setMetaView] = useState('campaign'); // 'campaign' | 'country'
  const [showMetaBreakdown, setShowMetaBreakdown] = useState(false); // Section 2 collapse
  const [expandedCountries, setExpandedCountries] = useState(new Set());
  const [expandedStates, setExpandedStates] = useState(new Set());
  
  const ecomLabel = store.ecommerce;
  
  const kpis = [
    { key: 'revenue', label: 'Revenue', value: overview.revenue, format: 'currency', color: '#8b5cf6' },
    { key: 'spend', label: 'Ad Spend', value: overview.spend, format: 'currency', color: '#6366f1' },
    { 
      key: 'orders',
      label: 'Orders',
      value: overview.orders,
      format: 'number',
      subtitle: `${overview.sallaOrders || overview.shopifyOrders || 0} ${ecomLabel} + ${overview.manualOrders} Manual`,
      color: '#22c55e'
    },
    { key: 'aov', label: 'AOV', value: overview.aov, format: 'currency', color: '#f59e0b' },
    { key: 'cac', label: 'CAC', value: overview.cac, format: 'currency', color: '#ef4444' },
    { key: 'roas', label: 'ROAS', value: overview.roas, format: 'roas', color: '#10b981' },
  ];

  const sortedCountries = [...countries].sort((a, b) => {
    const aVal = a[countrySortConfig.field] || 0;
    const bVal = b[countrySortConfig.field] || 0;
    return countrySortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
  });

  const totalCountrySpend = countries.reduce((s, x) => s + (x.spend || 0), 0);

  const sortedCampaigns = [...campaigns].sort((a, b) => {
    const aVal = a[campaignSortConfig.field] || 0;
    const bVal = b[campaignSortConfig.field] || 0;
    return campaignSortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
  });

  const sortedBreakdownData = [...metaBreakdownData].sort((a, b) => {
    const aVal = a[campaignSortConfig.field] || 0;
    const bVal = b[campaignSortConfig.field] || 0;
    return campaignSortConfig.direction === 'asc' ? aVal - bVal : bVal - aVal;
  });

  const orderedCountryTrends = [...countryTrends].sort((a, b) => (b.totalOrders || 0) - (a.totalOrders || 0));

  const parseLocalDate = useCallback((dateString) => {
    if (!dateString) return null;
    const safeDate = /^\d{4}-\d{2}-\d{2}$/.test(dateString) ? `${dateString}T00:00:00` : dateString;
    const parsed = new Date(safeDate);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  }, []);

  const formatCountryTick = useCallback((dateString) => {
    const date = parseLocalDate(dateString);
    return date
      ? date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
      : dateString;
  }, [parseLocalDate]);

  const formatCountryTooltip = useCallback((dateString) => {
    const date = parseLocalDate(dateString);
    return date
      ? date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })
      : dateString;
  }, [parseLocalDate]);

  const shopifyRegion = selectedShopifyRegion ?? 'us';
  const shopifyTimeZone = shopifyTimeOfDay?.timezone ?? (shopifyRegion === 'europe' ? 'Europe/London' : shopifyRegion === 'all' ? 'UTC' : 'America/Chicago');
  const shopifyTimeOfDayData = Array.isArray(shopifyTimeOfDay?.data) ? shopifyTimeOfDay.data : [];
  const shopifyHourlyChartData = shopifyTimeOfDayData.map((point) => ({
    ...point,
    hourLabel: `${point.hour}:00`
  }));

  const totalShopifyHourlyOrders = shopifyTimeOfDayData.reduce((sum, point) => sum + (point.orders || 0), 0);

  const handleCountrySort = (field) => {
    setCountrySortConfig(prev => ({
      field,
      direction: prev.field === field && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  const toggleCountryRow = (code) => {
    setExpandedCountries(prev => {
      const next = new Set(prev);
      if (next.has(code)) {
        next.delete(code);
        if (code === 'US') {
          setExpandedStates(prevStates => new Set([...prevStates].filter(key => !key.startsWith(`${code}-`))));
        }
      } else {
        next.add(code);
      }
      return next;
    });
  };

  const toggleStateRow = (stateKey) => {
    setExpandedStates(prev => {
      const next = new Set(prev);
      if (next.has(stateKey)) {
        next.delete(stateKey);
      } else {
        next.add(stateKey);
      }
      return next;
    });
  };

  const handleCampaignSort = (field) => {
    setCampaignSortConfig(prev => ({
      field,
      direction: prev.field === field && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  const getBreakdownLabel = (row, currentBreakdown) => {
    switch(currentBreakdown) {
      case 'country':
        return (
          <span className="flex items-center gap-2">
            <span>{row.countryFlag}</span> {row.countryName || row.country}
          </span>
        );
      case 'age':
        return (
          <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">
            {row.age}
          </span>
        );
      case 'gender':
        return <span>{row.genderLabel || row.gender}</span>;
      case 'age_gender':
        return (
          <div className="flex items-center gap-2 text-xs">
            <span className="px-2 py-1 bg-blue-100 text-blue-700 rounded font-medium">{row.age}</span>
            <span className="px-2 py-1 bg-pink-100 text-pink-700 rounded font-medium">{row.genderLabel || row.gender}</span>
          </div>
        );
      case 'placement':
        return (
          <span className="text-xs">
            {row.placementLabel || `${row.platform} - ${row.placement}`}
          </span>
        );
      default:
        return null;
    }
  };

  const toggleKpi = (key) => {
    setExpandedKpis(prev =>
      prev.includes(key)
        ? prev.filter(k => k !== key)
        : [...prev, key]
    );
  };

  const metaTotals = {
    spend: dashboard.metaSpendTotal || 0,
    revenue: dashboard.metaRevenueTotal || 0,
    roas: dashboard.metaRoasTotal,
    campaigns: dashboard.metaCampaignCount || 0,
    impressions: dashboard.metaImpressionsTotal || 0,
    reach: dashboard.metaReachTotal || 0,
    clicks: dashboard.metaClicksTotal || 0,
    ctr: dashboard.metaCtrTotal,
    lpv: dashboard.metaLpvTotal || 0,
    atc: dashboard.metaAtcTotal || 0,
    checkout: dashboard.metaCheckoutTotal || 0,
    conversions: dashboard.metaConversionsTotal || 0,
    cac: dashboard.metaCacTotal
  };

  const metaOverallRow = {
    campaignName: 'All Campaigns',
    dimension: 'Overall',
    spend: metaTotals.spend,
    conversionValue: metaTotals.revenue,
    conversions: metaTotals.conversions,
    impressions: metaTotals.impressions,
    clicks: metaTotals.clicks,
    ctr: metaTotals.impressions > 0 ? (metaTotals.clicks / metaTotals.impressions) * 100 : null,
    cpc: metaTotals.clicks > 0 ? metaTotals.spend / metaTotals.clicks : null,
    metaRoas: metaTotals.roas ?? null,
    metaAov: metaTotals.conversions > 0 ? metaTotals.revenue / metaTotals.conversions : null,
    metaCac: metaTotals.conversions > 0 ? metaTotals.spend / metaTotals.conversions : null,
    cr: metaTotals.clicks > 0 ? (metaTotals.conversions / metaTotals.clicks) * 100 : null
  };

  const metaBreakdownRows =
    metaBreakdown === 'none' ? [metaOverallRow] : sortedBreakdownData;

  const metaCtrValue =
    metaTotals.ctr != null
      ? metaTotals.ctr * 100
      : (metaTotals.impressions > 0 ? (metaTotals.clicks / metaTotals.impressions) * 100 : null);

  const breakdownLabels = {
    none: 'Overall',
    country: 'Country',
    age: 'Age',
    gender: 'Gender',
    age_gender: 'Age + Gender',
    placement: 'Placement'
  };

  const renderCurrency = (value, decimals = 0) =>
    value === null || value === undefined || Number.isNaN(value)
      ? 'â€”'
      : formatCurrency(value, decimals);

  const renderNumber = (value) =>
    value === null || value === undefined || Number.isNaN(value)
      ? 'â€”'
      : formatNumber(value);

  const renderPercent = (value) =>
    value === null || value === undefined || Number.isNaN(value)
      ? 'â€”'
      : `${value.toFixed(2)}%`;

  const renderRoas = (value) =>
    value === null || value === undefined || Number.isNaN(value)
      ? 'â€”'
      : `${value.toFixed(2)}Ã—`;

  // SECTION 1 rows based on metaView
  const section1Rows =
    metaView === 'campaign' ? sortedCampaigns : sortedCountries;

  const section1Totals = (() => {
    const rows = section1Rows;
    const totalSpend = rows.reduce((s, r) => s + (r.spend || 0), 0);
    const totalMetaRevenue = rows.reduce(
      (s, r) => s + (metaView === 'campaign'
        ? (r.conversionValue || 0)
        : (r.revenue || 0)),
      0
    );
    const totalOrders = rows.reduce(
      (s, r) => s + (metaView === 'campaign'
        ? (r.conversions || 0)
        : (r.totalOrders || 0)),
      0
    );
    const totalImpr = rows.reduce((s, r) => s + (r.impressions || 0), 0);
    const totalReach = rows.reduce((s, r) => s + (r.reach || 0), 0);
    const totalClicks = rows.reduce((s, r) => s + (r.clicks || 0), 0);
    const totalLpv = rows.reduce((s, r) => s + (r.lpv || 0), 0);
    const totalAtc = rows.reduce((s, r) => s + (r.atc || 0), 0);
    const totalCheckout = rows.reduce((s, r) => s + (r.checkout || 0), 0);
    const totalMetaConversions = rows.reduce(
      (s, r) => s + (metaView === 'campaign'
        ? (r.conversions || 0)
        : (r.metaOrders || 0)),
      0
    );

    const roas = totalSpend > 0 ? totalMetaRevenue / totalSpend : 0;
    const aov = totalOrders > 0 ? totalMetaRevenue / totalOrders : 0;
    const cac = totalOrders > 0 ? totalSpend / totalOrders : 0;
    const cpm = totalImpr > 0 ? (totalSpend / totalImpr) * 1000 : 0;
    const freq = totalReach > 0 ? totalImpr / totalReach : 0;
    const ctr = totalImpr > 0 ? (totalClicks / totalImpr) * 100 : 0;
    const cpc = totalClicks > 0 ? totalSpend / totalClicks : 0;
    const cr =
      totalClicks > 0
        ? (metaView === 'campaign'
            ? (totalMetaConversions / totalClicks) * 100
            : (totalOrders / totalClicks) * 100)
        : 0;

    return {
      totalSpend,
      totalMetaRevenue,
      totalOrders,
      totalImpr,
      totalReach,
      totalClicks,
      totalLpv,
      totalAtc,
      totalCheckout,
      totalMetaConversions,
      roas,
      aov,
      cac,
      cpm,
      freq,
      ctr,
      cpc,
      cr
    };
  })();

  return (
    <div className="space-y-6 animate-fade-in">
      {/* KPI CARDS */}
      <div className="grid grid-cols-6 gap-4">
        {kpis.map((kpi) => (
          <KPICard 
            key={kpi.key}
            kpi={kpi}
            trends={trends}
            expanded={expandedKpis.includes(kpi.key)}
            onToggle={() => toggleKpi(kpi.key)}
            formatCurrency={formatCurrency}
          />
        ))}
      </div>

      {/* Global Orders Trend */}
      {trends && trends.length > 0 && (
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h3 className="text-lg font-semibold mb-4">Orders Trend</h3>
          <div className="h-64">
            <ResponsiveContainer>
              <AreaChart data={trends}>
                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                <XAxis dataKey="date" tick={{ fontSize: 12 }} />
                <YAxis tick={{ fontSize: 12 }} />
                <Tooltip />
                <Area 
                  type="monotone" 
                  dataKey="orders" 
                  stroke="#22c55e"
                  fill="#22c55e"
                  fillOpacity={0.2}
                />
              </AreaChart>
            </ResponsiveContainer>
          </div>
        </div>
      )}

      {/* Expanded KPI charts */}
      {expandedKpis.length > 0 && trends && trends.length > 0 && (
        <div className="space-y-6">
          {expandedKpis.map((key) => {
            const thisKpi = kpis.find(k => k.key === key);
            if (!thisKpi) return null;
            return (
              <div key={key} className="bg-white rounded-xl p-6 shadow-sm animate-fade-in">
                <h3 className="text-lg font-semibold mb-4">{thisKpi.label} Trend</h3>
                <div className="h-64">
                  <ResponsiveContainer>
                    <AreaChart data={trends}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                      <XAxis dataKey="date" tick={{ fontSize: 12 }} />
                      <YAxis tick={{ fontSize: 12 }} />
                      <Tooltip />
                      <Area 
                        type="monotone" 
                        dataKey={key} 
                        stroke={thisKpi.color}
                        fill={thisKpi.color}
                        fillOpacity={0.2}
                      />
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* SECTION 1 â€” META FUNNEL (INTEGRATED) */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        <div className="px-6 pt-6 pb-4 border-b border-gray-100 flex items-center justify-between">
          <div>
            <h2 className="text-lg font-semibold">
              {store.id === 'shawq'
                ? 'Section 1 â€” Meta Campaigns (Shopify Data Integrated)'
                : 'Section 1 â€” Meta Campaigns (Salla Data Integrated)'}
            </h2>
            <p className="text-xs text-gray-400">+ any manual orders</p>
            <p className="text-sm text-gray-500">
              Meta funnel metrics with{" "}
              <span className="font-semibold">true revenue & orders</span> when
              you switch to By Country.
            </p>
          </div>
          <div className="flex items-center gap-2">
            <span className="text-xs text-gray-500 mr-2">View:</span>
            <button
              onClick={() => setMetaView('campaign')}
              className={`px-3 py-1.5 text-xs rounded-lg font-medium ${
                metaView === 'campaign'
                  ? 'bg-gray-900 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              Campaigns
            </button>
            <button
              onClick={() => setMetaView('country')}
              className={`px-3 py-1.5 text-xs rounded-lg font-medium ${
                metaView === 'country'
                  ? 'bg-gray-900 text-white'
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              By Country (True)
            </button>
          </div>
        </div>
        <div className="overflow-x-auto">
          <table>
            <thead>
              {/* Highlight header row */}
              <tr className="bg-gray-50 text-xs text-gray-500 uppercase tracking-wide">
                <th className="text-left px-4 py-2">
                  {metaView === 'campaign' ? 'Campaign' : 'Country'}
                </th>
                <th colSpan={5} className="text-center border-l border-gray-100">
                  Meta Financials
                </th>
                <th colSpan={4} className="text-center border-l border-gray-100">
                  Upper Funnel
                </th>
                <th colSpan={4} className="text-center border-l border-gray-100">
                  Mid Funnel
                </th>
                <th colSpan={5} className="text-center border-l border-gray-100">
                  Lower Funnel
                </th>
              </tr>
              <tr className="bg-gray-50 text-xs text-gray-500">
                <SortableHeader
                  label="Name"
                  field={metaView === 'campaign' ? 'campaignName' : 'name'}
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                  className="text-left px-4 py-2"
                />
                <SortableHeader
                  label="Spend"
                  field="spend"
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                />
                <th>Revenue</th>
                <SortableHeader
                  label="ROAS"
                  field={metaView === 'campaign' ? 'metaRoas' : 'roas'}
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                  className="bg-indigo-50 text-indigo-700"
                />
                <SortableHeader
                  label="AOV"
                  field={metaView === 'campaign' ? 'metaAov' : 'aov'}
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                  className="bg-indigo-50 text-indigo-700"
                />
                <SortableHeader
                  label="CAC"
                  field={metaView === 'campaign' ? 'metaCac' : 'cac'}
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                  className="bg-indigo-50 text-indigo-700"
                />

                <SortableHeader
                  label="Impr"
                  field="impressions"
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                />
                <SortableHeader
                  label="Reach"
                  field="reach"
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                />
                <th>CPM</th>
                <th>Freq</th>

                <SortableHeader
                  label="Clicks"
                  field="clicks"
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                />
                <th>CTR</th>
                <th>CPC</th>
                <th>LPV</th>

                <th>ATC</th>
                <th>Checkout</th>
                <th>Orders</th>
                <SortableHeader
                  label="Conv"
                  field={metaView === 'campaign' ? 'conversions' : 'metaOrders'}
                  sortConfig={metaView === 'campaign' ? campaignSortConfig : countrySortConfig}
                  onSort={metaView === 'campaign' ? handleCampaignSort : handleCountrySort}
                />
                <th>CR</th>
              </tr>
            </thead>
            <tbody>
              {section1Rows.map((row) => {
                const isCampaign = metaView === 'campaign';
                const nameCell = isCampaign ? (
                  <span className="font-medium">{row.campaignName}</span>
                ) : (
                  <div className="flex items-center gap-2">
                    <span className="text-xl">{row.flag}</span>
                    <span className="font-medium">{row.name}</span>
                  </div>
                );

                const revenueCell = isCampaign
                  ? formatCurrency(row.conversionValue || 0)
                  : formatCurrency(row.revenue || 0);

                const roas = isCampaign ? row.metaRoas || 0 : row.roas || 0;
                const aov = isCampaign ? row.metaAov || 0 : row.aov || 0;
                const cac = isCampaign ? row.metaCac || 0 : row.cac || 0;

                const orders = isCampaign
                  ? row.conversions || 0
                  : row.totalOrders || 0;

                const metaConv = isCampaign
                  ? row.conversions || 0
                  : row.metaOrders || 0;

                const cr =
                  row.clicks > 0
                    ? (isCampaign
                        ? (metaConv / row.clicks) * 100
                        : (orders / row.clicks) * 100)
                    : 0;

                return (
                  <tr key={isCampaign ? row.campaignId : row.code}>
                    <td className="px-4 py-2">{nameCell}</td>
                    <td className="text-indigo-600 font-semibold">
                      {formatCurrency(row.spend || 0)}
                    </td>
                    <td className="text-green-600 font-semibold">{revenueCell}</td>
                    <td className="text-green-600 font-semibold">
                      {roas.toFixed(2)}Ã—
                    </td>
                    <td>{formatCurrency(aov || 0)}</td>
                    <td className={cac > 100 ? 'text-amber-600 font-medium' : ''}>
                      {formatCurrency(cac || 0)}
                    </td>

                    <td>{formatNumber(row.impressions || 0)}</td>
                    <td>{formatNumber(row.reach || 0)}</td>
                    <td>{formatCurrency(row.cpm || 0, 2)}</td>
                    <td>{(row.frequency || 0).toFixed(2)}</td>

                    <td>{formatNumber(row.clicks || 0)}</td>
                    <td>{(row.ctr || 0).toFixed(2)}%</td>
                    <td>{formatCurrency(row.cpc || 0, 2)}</td>
                    <td>{formatNumber(row.lpv || 0)}</td>

                    <td>{formatNumber(row.atc || 0)}</td>
                    <td>{formatNumber(row.checkout || 0)}</td>
                    <td>{orders}</td>
                    <td>{metaConv}</td>
                    <td>{cr.toFixed(2)}%</td>
                  </tr>
                );
              })}

              {/* TOTAL ROW */}
              <tr className="bg-gray-50 font-semibold">
                <td className="px-4 py-2">
                  {metaView === 'campaign' ? 'TOTAL (Campaigns)' : 'TOTAL (Countries)'}
                </td>
                <td className="text-indigo-600">
                  {formatCurrency(section1Totals.totalSpend)}
                </td>
                <td className="text-green-600">
                  {formatCurrency(section1Totals.totalMetaRevenue)}
                </td>
                <td className="text-green-600">
                  {section1Totals.roas.toFixed(2)}Ã—
                </td>
                <td>{formatCurrency(section1Totals.aov || 0)}</td>
                <td>{formatCurrency(section1Totals.cac || 0)}</td>

                <td>{formatNumber(section1Totals.totalImpr)}</td>
                <td>{formatNumber(section1Totals.totalReach)}</td>
                <td>{formatCurrency(section1Totals.cpm || 0, 2)}</td>
                <td>{section1Totals.freq.toFixed(2)}</td>

                <td>{formatNumber(section1Totals.totalClicks)}</td>
                <td>{section1Totals.ctr.toFixed(2)}%</td>
                <td>{formatCurrency(section1Totals.cpc || 0, 2)}</td>
                <td>{formatNumber(section1Totals.totalLpv)}</td>

                <td>{formatNumber(section1Totals.totalAtc)}</td>
                <td>{formatNumber(section1Totals.totalCheckout)}</td>
                <td>{section1Totals.totalOrders}</td>
                <td>{section1Totals.totalMetaConversions}</td>
                <td>{section1Totals.cr.toFixed(2)}%</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      {/* SECTION 2 â€” PURE META BREAKDOWN WORLD */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        <button
          onClick={() => setShowMetaBreakdown(!showMetaBreakdown)}
          className="w-full px-6 pt-5 pb-4 flex items-center justify-between hover:bg-gray-50 transition-colors border-b border-gray-100"
        >
          <div className="text-left">
            <h2 className="text-lg font-semibold">Section 2 â€” Pure Meta Breakdown World</h2>
            <p className="text-sm text-gray-500">
              Raw Meta reporting (no Shopify/Salla/manual integration). Use this to analyze countries, age, gender, placement, etc.
            </p>
          </div>
          <div className="flex items-center gap-4 text-sm text-gray-500">
            <span>Campaigns: <strong>{metaTotals.campaigns}</strong></span>
            <span>Spend: <strong>{renderCurrency(metaTotals.spend)}</strong></span>
            <span>Meta Rev: <strong>{renderCurrency(metaTotals.revenue)}</strong></span>
            <span>ROAS: <strong>{renderRoas(metaTotals.roas)}</strong></span>
            <ChevronDown
              className={`w-5 h-5 text-gray-500 transform transition-transform ${
                showMetaBreakdown ? 'rotate-180' : ''
              }`}
            />
          </div>
        </button>

        <div className="px-6 pt-4 pb-6">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <div className="text-xs uppercase text-gray-500">Meta Campaigns</div>
              <div className="text-2xl font-semibold text-gray-900">{metaTotals.campaigns}</div>
            </div>
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <div className="text-xs uppercase text-gray-500">Meta Spend</div>
              <div className="text-2xl font-semibold text-gray-900">{renderCurrency(metaTotals.spend)}</div>
            </div>
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <div className="text-xs uppercase text-gray-500">Meta Revenue</div>
              <div className="text-2xl font-semibold text-gray-900">{renderCurrency(metaTotals.revenue)}</div>
            </div>
            <div className="p-4 bg-gray-50 rounded-lg border border-gray-100">
              <div className="text-xs uppercase text-gray-500">Meta ROAS</div>
              <div className="text-2xl font-semibold text-gray-900">{renderRoas(metaTotals.roas)}</div>
            </div>
          </div>
        </div>

        {showMetaBreakdown && (
          <>
            <div className="px-6 pb-4">
              <div className="grid md:grid-cols-3 gap-4 bg-gray-50 rounded-lg p-4">
                <div>
                  <div className="text-xs uppercase text-gray-500">Upper Funnel</div>
                  <div className="mt-2 space-y-1 text-sm text-gray-700">
                    <div className="flex justify-between"><span>Impressions</span><span className="font-semibold">{renderNumber(metaTotals.impressions)}</span></div>
                    <div className="flex justify-between"><span>Reach</span><span className="font-semibold">{renderNumber(metaTotals.reach)}</span></div>
                    <div className="flex justify-between"><span>Clicks</span><span className="font-semibold">{renderNumber(metaTotals.clicks)}</span></div>
                    <div className="flex justify-between"><span>CTR</span><span className="font-semibold">{renderPercent(metaCtrValue)}</span></div>
                  </div>
                </div>
                <div>
                  <div className="text-xs uppercase text-gray-500">Mid Funnel</div>
                  <div className="mt-2 space-y-1 text-sm text-gray-700">
                    <div className="flex justify-between"><span>Landing Page Views</span><span className="font-semibold">{renderNumber(metaTotals.lpv)}</span></div>
                    <div className="flex justify-between"><span>Add to Cart</span><span className="font-semibold">{renderNumber(metaTotals.atc)}</span></div>
                    <div className="flex justify-between"><span>Checkout</span><span className="font-semibold">{renderNumber(metaTotals.checkout)}</span></div>
                  </div>
                </div>
                <div>
                  <div className="text-xs uppercase text-gray-500">Lower Funnel</div>
                  <div className="mt-2 space-y-1 text-sm text-gray-700">
                    <div className="flex justify-between"><span>Conversions</span><span className="font-semibold">{renderNumber(metaTotals.conversions)}</span></div>
                    <div className="flex justify-between"><span>Conversion Value</span><span className="font-semibold">{renderCurrency(metaTotals.revenue)}</span></div>
                    <div className="flex justify-between"><span>Meta ROAS</span><span className="font-semibold">{renderRoas(metaTotals.roas)}</span></div>
                    <div className="flex justify-between"><span>Meta CAC</span><span className="font-semibold">{renderCurrency(metaTotals.cac, 2)}</span></div>
                  </div>
                </div>
              </div>
            </div>

            <div className="px-6 pt-2 pb-2 flex items-center justify-between">
              <div className="text-xs uppercase tracking-wide text-gray-400">
                Meta Campaign Performance <span className="ml-2 text-gray-300">PURE META</span>
              </div>
              <select
                value={metaBreakdown}
                onChange={(e) => setMetaBreakdown(e.target.value)}
                className="px-3 py-2 border border-gray-200 rounded-lg text-sm"
              >
                <option value="none">Overall</option>
                <option value="country">By Country</option>
                <option value="age">By Age</option>
                <option value="gender">By Gender</option>
                <option value="age_gender">By Age + Gender</option>
                <option value="placement">By Placement</option>
              </select>
            </div>
            <div className="overflow-x-auto">
              <table>
                <thead>
                  <tr className="bg-gray-50 text-xs text-gray-500 uppercase tracking-wide">
                    <th className="text-left px-4 py-2">Campaign</th>
                    {metaBreakdown !== 'none' && <th>{breakdownLabels[metaBreakdown]}</th>}
                    <th>Spend</th>
                    <th>Meta Revenue</th>
                    <th className="bg-indigo-50 text-indigo-700">Meta ROAS</th>
                    <th className="bg-indigo-50 text-indigo-700">Meta AOV</th>
                    <th className="bg-indigo-50 text-indigo-700">Meta CAC</th>
                    <th>Impr</th>
                    <th>Clicks</th>
                    <th>CTR</th>
                    <th>CPC</th>
                    <th>Conv</th>
                    <th>Conversion Rate</th>
                  </tr>
                </thead>
                <tbody>
                  {metaBreakdownRows.map((c, idx) => {
                    const spend = c.spend || 0;
                    const revenue = c.conversionValue || 0;
                    const impressions = c.impressions || 0;
                    const clicks = c.clicks || 0;
                    const conversions = c.conversions || 0;
                    const rowRoas = spend > 0 ? revenue / spend : null;
                    const rowAov = conversions > 0 ? revenue / conversions : null;
                    const rowCac = conversions > 0 ? spend / conversions : null;
                    const rowCtr = impressions > 0 ? (clicks / impressions) * 100 : null;
                    const rowCpc = clicks > 0 ? spend / clicks : null;
                    const rowCr = clicks > 0 ? (conversions / clicks) * 100 : null;

                    return (
                      <tr key={`${c.campaignId || 'overall'}-${idx}`}>
                        <td className="px-4 py-2 font-medium">{c.campaignName}</td>
                        {metaBreakdown !== 'none' && (
                          <td>{getBreakdownLabel(c, metaBreakdown)}</td>
                        )}
                        <td className="text-indigo-600 font-semibold">{renderCurrency(spend)}</td>
                        <td className="text-green-600 font-semibold">{renderCurrency(revenue)}</td>
                        <td className="text-green-600 font-semibold">{renderRoas(rowRoas)}</td>
                        <td>{renderCurrency(rowAov)}</td>
                        <td className={rowCac && rowCac > 100 ? 'text-amber-600' : ''}>{renderCurrency(rowCac)}</td>
                        <td>{renderNumber(impressions)}</td>
                        <td>{renderNumber(clicks)}</td>
                        <td>{renderPercent(rowCtr)}</td>
                        <td>{renderCurrency(rowCpc, 2)}</td>
                        <td>{renderNumber(conversions)}</td>
                        <td>{renderPercent(rowCr)}</td>
                      </tr>
                    );
                  })}
                  {metaBreakdown !== 'none' && (
                    <tr className="bg-gray-50 font-semibold">
                      <td className="px-4 py-2">TOTAL</td>
                      <td></td>
                      <td className="text-indigo-600">{renderCurrency(metaTotals.spend)}</td>
                      <td className="text-green-600">{renderCurrency(metaTotals.revenue)}</td>
                      <td className="text-green-600">{renderRoas(metaTotals.roas)}</td>
                      <td>{renderCurrency(metaOverallRow.metaAov)}</td>
                      <td>{renderCurrency(metaTotals.cac, 2)}</td>
                      <td>{renderNumber(metaTotals.impressions)}</td>
                      <td>{renderNumber(metaTotals.clicks)}</td>
                      <td>{renderPercent(metaOverallRow.ctr)}</td>
                      <td>{renderCurrency(metaOverallRow.cpc, 2)}</td>
                      <td>{renderNumber(metaTotals.conversions)}</td>
                      <td>{renderPercent(metaOverallRow.cr)}</td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </>
        )}
      </div>

      {/* Funnel Diagnostics */}
      {diagnostics && diagnostics.length > 0 && (
        <div
          className={`rounded-xl p-6 ${
            diagnostics.some(d => d.type === 'warning') 
              ? 'bg-gradient-to-r from-amber-50 to-yellow-50 border border-amber-200'
              : 'bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200'
          }`}
        >
          <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
            ðŸ” Funnel Diagnostics
          </h3>
          <div className="space-y-3">
            {diagnostics.map((d, i) => (
              <div key={i} className="flex gap-3 p-4 bg-white/70 rounded-lg">
                <span className="text-xl">{d.icon}</span>
                <div>
                  <p className="font-medium">{d.title}</p>
                  <p className="text-sm text-gray-600">{d.detail}</p>
                  <p className="text-sm text-indigo-600 mt-1">{d.action}</p>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Shopify time of day trends */}
      {store.id === 'shawq' && (
        <div className="bg-white rounded-xl shadow-sm p-6 mb-6">
          <div className="flex items-start justify-between gap-4 flex-wrap">
            <div>
              <h2 className="text-lg font-semibold">Orders by Time of Day (Last 7 Days)</h2>
              <p className="text-sm text-gray-500">
                Shopify orders grouped by hour. Use this to spot when customers are most active.
              </p>
              <div className="flex items-center gap-2 mt-2 text-xs text-gray-600 flex-wrap">
                <span>Time Zone:</span>
                <span className="inline-flex items-center px-2 py-1 rounded-full bg-indigo-50 text-indigo-700 font-medium">
                  {shopifyTimeZone}
                </span>
              </div>
              <div className="flex items-center gap-2 mt-2 text-xs text-gray-600 flex-wrap">
                <span>Region:</span>
                <div className="flex items-center gap-1">
                  <button
                    className={`px-2 py-1 rounded ${shopifyRegion === 'all' ? 'bg-gray-200 text-gray-900' : 'bg-white text-gray-600 border'}`}
                    onClick={() => setSelectedShopifyRegion('all')}
                  >
                    All Orders
                  </button>
                  <button
                    className={`px-2 py-1 rounded ${shopifyRegion === 'us' ? 'bg-gray-200 text-gray-900' : 'bg-white text-gray-600 border'}`}
                    onClick={() => setSelectedShopifyRegion('us')}
                  >
                    US Orders
                  </button>
                  <button
                    className={`px-2 py-1 rounded ${shopifyRegion === 'europe' ? 'bg-gray-200 text-gray-900' : 'bg-white text-gray-600 border'}`}
                    onClick={() => setSelectedShopifyRegion('europe')}
                  >
                    Europe Orders
                  </button>
                </div>
              </div>
              {shopifyTimeOfDay?.sampleTimestamps?.length > 0 && (
                <p className="text-xs text-gray-500 mt-1">
                  Sample timestamps: {shopifyTimeOfDay.sampleTimestamps.join(', ')}
                </p>
              )}
            </div>
            <div className="text-right">
              <div className="text-xs uppercase text-gray-400">Total orders</div>
              <div className="text-2xl font-bold text-gray-900">{totalShopifyHourlyOrders}</div>
            </div>
          </div>

          {shopifyHourlyChartData.length > 0 ? (
            <div className="h-64 mt-4">
              <ResponsiveContainer>
                <LineChart data={shopifyHourlyChartData} margin={{ top: 10, right: 20, bottom: 10, left: 0 }}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="hourLabel" tick={{ fontSize: 10 }} />
                  <YAxis allowDecimals={false} tick={{ fontSize: 10 }} />
                  <Tooltip
                    formatter={(value, name) => [value, name === 'orders' ? 'Orders' : 'Revenue']}
                    labelFormatter={(label) => `${label}`}
                  />
                  <Line
                    type="monotone"
                    dataKey="orders"
                    stroke="#6366f1"
                    strokeWidth={3}
                    dot={{ r: 2 }}
                    activeDot={{ r: 4 }}
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>
          ) : (
            <p className="text-sm text-gray-500 mt-4">No Shopify time-of-day data available for this range.</p>
          )}
        </div>
      )}

      {/* Countries Performance (ecommerce-driven with cities) */}
      <div className="bg-white rounded-xl shadow-sm overflow-hidden">
        <div className="p-6 border-b border-gray-100">
          <h2 className="text-lg font-semibold">Countries Performance</h2>
          <p className="text-sm text-gray-500">
            Combined: Meta Spend + {store.ecommerce} Orders + Manual Orders â€¢ Click headers to sort
          </p>
        </div>
        <div className="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th className="text-left">Country</th>
                <SortableHeader
                  label="Spend"
                  field="spend"
                  sortConfig={countrySortConfig}
                  onSort={handleCountrySort}
                />
                <SortableHeader
                  label="Revenue"
                  field="revenue"
                  sortConfig={countrySortConfig}
                  onSort={handleCountrySort}
                />
                <SortableHeader
                  label="Share"
                  field="spend"
                  sortConfig={countrySortConfig}
                  onSort={handleCountrySort}
                />
                <SortableHeader
                  label="Orders"
                  field="totalOrders"
                  sortConfig={countrySortConfig}
                  onSort={handleCountrySort}
                />
                <SortableHeader
                  label="AOV"
                  field="aov"
                  sortConfig={countrySortConfig}
                  onSort={handleCountrySort}
                />
                <SortableHeader
                  label="CAC"
                  field="cac"
                  sortConfig={countrySortConfig}
                  onSort={handleCountrySort}
                />
                <SortableHeader
                  label="ROAS"
                  field="roas"
                  sortConfig={countrySortConfig}
                  onSort={handleCountrySort}
                />
              </tr>
            </thead>
            <tbody>
              {sortedCountries.map((c) => {
                const share = totalCountrySpend > 0 ? (c.spend / totalCountrySpend) * 100 : 0;
                const isExpanded = expandedCountries.has(c.code);
                const hasCities = Array.isArray(c.cities) && c.cities.length > 0;
                const isUsCountry = c.code === 'US';
                return (
                  <Fragment key={c.code}>
                    <tr
                      className={hasCities ? 'cursor-pointer hover:bg-gray-50' : ''}
                      onClick={() => hasCities && toggleCountryRow(c.code)}
                    >
                      <td>
                        <div className="flex items-center gap-3">
                          {hasCities && (
                            <span className="text-gray-400">
                              {isExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                            </span>
                          )}
                          <span className="text-xl">{c.flag}</span>
                          <div>
                            <div className="font-medium">{c.name}</div>
                            <div className="text-xs text-gray-400">{c.code}</div>
                          </div>
                        </div>
                      </td>
                      <td className="text-indigo-600 font-semibold">{formatCurrency(c.spend)}</td>
                      <td className="text-green-600 font-semibold">{formatCurrency(c.revenue || 0)}</td>
                      <td>{share.toFixed(0)}%</td>
                      <td>
                        <span className="badge badge-green">{c.totalOrders}</span>
                      </td>
                      <td>{formatCurrency(c.aov)}</td>
                      <td className={c.cac > 80 ? 'text-amber-600 font-medium' : ''}>{formatCurrency(c.cac, 2)}</td>
                      <td className="text-green-600 font-semibold">{c.roas.toFixed(2)}Ã—</td>
                    </tr>
                    {isExpanded && hasCities && (
                      <tr key={`${c.code}-cities`}>
                        <td colSpan={8} className="bg-gray-50">
                          <div className="p-4">
                            <div className="text-sm font-semibold mb-2">Cities</div>
                            <table className="w-full text-sm">
                              <thead>
                                <tr className="text-left text-gray-500">
                                  {isUsCountry && <th className="w-28">Rank</th>}
                                  <th>{isUsCountry ? 'State' : 'City'}</th>
                                  <th>Orders</th>
                                  <th>Revenue</th>
                                  <th>AOV</th>
                                  <th>Spend</th>
                                  <th>CAC</th>
                                  <th>ROAS</th>
                                </tr>
                              </thead>
                              <tbody>
                {isUsCountry
                  ? [...c.cities]
                      .sort((a, b) => (b.orders || 0) - (a.orders || 0))
                      .map((state, stateIdx) => {
                        const stateKey = `${c.code}-${state.city || 'unknown'}`;
                        const hasStateCities = Array.isArray(state.cities) && state.cities.length > 0;
                        const stateExpanded = expandedStates.has(stateKey);
                        const orderedStateCities = hasStateCities
                          ? [...state.cities].sort((a, b) => (b.orders || 0) - (a.orders || 0))
                          : [];

                        const medal = stateIdx === 0 ? 'ðŸ¥‡' : stateIdx === 1 ? 'ðŸ¥ˆ' : stateIdx === 2 ? 'ðŸ¥‰' : null;

                        return (
                          <Fragment key={stateKey}>
                            <tr
                              className={hasStateCities ? 'cursor-pointer hover:bg-gray-50' : ''}
                              onClick={() => hasStateCities && toggleStateRow(stateKey)}
                            >
                              <td>
                                <div className="flex items-center gap-2">
                                  {medal && <span>{medal}</span>}
                                  <span className="text-xs text-gray-500">#{stateIdx + 1}</span>
                                  {hasStateCities && (
                                    <span className="text-gray-400">
                                      {stateExpanded ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                                    </span>
                                  )}
                                </div>
                              </td>
                              <td>{state.city || 'Unknown'}</td>
                              <td>{state.orders || 0}</td>
                              <td className="text-green-600 font-semibold">{formatCurrency(state.revenue || 0)}</td>
                              <td>{formatCurrency(state.aov || 0)}</td>
                              <td>â€”</td>
                              <td>â€”</td>
                              <td>â€”</td>
                            </tr>

                            {stateExpanded && hasStateCities && (
                              <tr key={`${stateKey}-cities`}>
                                <td colSpan={8} className="bg-gray-50">
                                  <div className="pl-10 pr-4 py-3 space-y-2">
                                    <div className="text-xs font-semibold text-gray-600">Cities</div>
                                    <table className="w-full text-xs">
                                      <thead>
                                        <tr className="text-left text-gray-500">
                                          <th>City</th>
                                          <th>Orders</th>
                                          <th>Revenue</th>
                                          <th>AOV</th>
                                        </tr>
                                      </thead>
                                      <tbody>
                                        {orderedStateCities.map((innerCity, cityIdx) => (
                                          <tr key={`${stateKey}-${innerCity.city || 'unknown'}-${cityIdx}`}>
                                            <td>{innerCity.city || 'Unknown'}</td>
                                            <td>{innerCity.orders || 0}</td>
                                            <td className="text-green-600 font-semibold">{formatCurrency(innerCity.revenue || 0)}</td>
                                            <td>{formatCurrency(innerCity.aov || 0)}</td>
                                          </tr>
                                        ))}
                                      </tbody>
                                    </table>
                                  </div>
                                </td>
                              </tr>
                            )}
                          </Fragment>
                        );
                      })
                  : c.cities.map((city, idx) => (
                      <tr key={`${c.code}-${city.city || 'unknown'}-${idx}`}>
                        <td>{city.city || 'Unknown'}</td>
                        <td>{city.orders || 0}</td>
                        <td className="text-green-600 font-semibold">{formatCurrency(city.revenue || 0)}</td>
                        <td>{formatCurrency(city.aov || 0)}</td>
                        <td>â€”</td>
                        <td>â€”</td>
                        <td>â€”</td>
                      </tr>
                    ))}
              </tbody>
            </table>
          </div>
        </td>
                      </tr>
                    )}
                  </Fragment>
                );
              })}
            </tbody>
          </table>
        </div>
      </div>

      {/* Country order trends (collapsible) */}
      {orderedCountryTrends && orderedCountryTrends.length > 0 && (
        <div className="bg-white rounded-xl shadow-sm overflow-hidden">
          <button
            onClick={() => setShowCountryTrends(!showCountryTrends)}
            className="w-full p-6 flex items-center justify-between hover:bg-gray-50 transition-colors"
          >
            <div>
              <h2 className="text-lg font-semibold text-left">Order Trends by Country</h2>
              <p className="text-sm text-gray-500 text-left">
                Click to {showCountryTrends ? 'collapse' : 'expand'} daily order trends
                per country
              </p>
            </div>
            <div
              className={`transform transition-transform ${
                showCountryTrends ? 'rotate-180' : ''
              }`}
            >
              <ChevronDown className="w-5 h-5 text-gray-500" />
            </div>
          </button>
          
          {showCountryTrends && (
            <div className="p-6 pt-0 space-y-6">
              {orderedCountryTrends.map((country) => (
                <div
                  key={country.countryCode}
                  className="border-t border-gray-100 pt-4 first:border-0 first:pt-0"
                >
                  <div className="flex items-center gap-2 mb-3">
                    <span className="text-xl">{country.flag}</span>
                    <span className="font-semibold">{country.country}</span>
                    <span className="text-sm text-gray-500">
                      ({country.totalOrders} orders)
                    </span>
                  </div>
                  <div className="h-32">
                    <ResponsiveContainer>
                      <AreaChart data={country.trends}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                        <XAxis
                          dataKey="date"
                          tick={{ fontSize: 10 }}
                          tickFormatter={formatCountryTick}
                        />
                        <YAxis tick={{ fontSize: 10 }} allowDecimals={false} />
                        <Tooltip
                          labelFormatter={formatCountryTooltip}
                          formatter={(value, name) => [
                            value,
                            name === 'orders' ? 'Orders' : 'Revenue'
                          ]}
                        />
                        <Area 
                          type="monotone" 
                          dataKey="orders" 
                          stroke="#6366f1"
                          fill="#6366f1"
                          fillOpacity={0.2}
                        />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* Debug panel */}
      <div className="bg-gray-900 text-gray-100 rounded-xl p-4 mt-6 text-sm">
        <h3 className="font-semibold mb-2">Debug Â· Meta vs Dashboard</h3>
        <p>
          Store: <span className="font-mono">{store.id}</span>
        </p>
        <p>
          Date range (API):{' '}
          <span className="font-mono">
            {dashboard?.dateRange?.startDate} â†’ {dashboard?.dateRange?.endDate}
          </span>
        </p>

        <div className="grid grid-cols-2 gap-4 mt-3">
          <div>
            <p className="text-xs text-gray-400 uppercase mb-1">Campaigns</p>
            <p>
              Total rows: <span className="font-mono">{campaigns.length}</span>
            </p>
            <p>
              Spend (sum of campaigns):{' '}
              <span className="font-mono">
                {formatCurrency(
                  campaigns.reduce((s, c) => s + (c.spend || 0), 0)
                )}
              </span>
            </p>
          </div>
          <div>
            <p className="text-xs text-gray-400 uppercase mb-1">Overview</p>
            <p>
              Overview spend:{' '}
              <span className="font-mono">
                {formatCurrency(overview.spend || 0)}
              </span>
            </p>
            <p>
              Overview revenue:{' '}
              <span className="font-mono">
                {formatCurrency(overview.revenue || 0)}
              </span>
            </p>
          </div>
        </div>

        <p className="mt-3 text-xs text-gray-400">
          If campaign spend is far below Ads Manager, suspect pagination, date
          filters, or currency conversion.
        </p>
      </div>
    </div>
  );
}

function KPICard({ kpi, trends, expanded, onToggle, formatCurrency }) {
  const trendData = trends && trends.length > 0
    ? trends.slice(-7).map(t => ({ value: t[kpi.key] || 0 }))
    : [];
  
  const calculateChange = () => {
    if (!trends || trends.length < 2) return { value: 0, isPositive: true };
    
    const midPoint = Math.floor(trends.length / 2);
    const firstHalf = trends.slice(0, midPoint);
    const secondHalf = trends.slice(midPoint);
    
    const firstSum = firstHalf.reduce((sum, t) => sum + (t[kpi.key] || 0), 0);
    const secondSum = secondHalf.reduce((sum, t) => sum + (t[kpi.key] || 0), 0);
    
    const firstAvg = firstHalf.length > 0 ? firstSum / firstHalf.length : 0;
    const secondAvg = secondHalf.length > 0 ? secondSum / secondHalf.length : 0;
    
    if (firstAvg === 0) return { value: 0, isPositive: true };
    
    const change = ((secondAvg - firstAvg) / firstAvg) * 100;
    
    const isGoodChange = kpi.key === 'cac' || kpi.key === 'spend' 
      ? change < 0 
      : change > 0;
    
    return { value: Math.abs(change), isPositive: change >= 0, isGood: isGoodChange };
  };
  
  const change = calculateChange();
  
  const formatValue = () => {
    if (kpi.format === 'currency') return formatCurrency(kpi.value);
    if (kpi.format === 'roas') return (kpi.value || 0).toFixed(2) + 'Ã—';
    return Math.round(kpi.value || 0);
  };

  return (
    <div 
      onClick={onToggle}
      className={`bg-white rounded-xl p-5 shadow-sm cursor-pointer card-hover ${
        expanded ? 'ring-2 ring-indigo-500' : ''
      }`}
    >
      <div className="flex items-start justify-between mb-2">
        <span className="text-xs font-medium text-gray-500 uppercase tracking-wide">
          {kpi.label}
        </span>
        {change.value > 0 && (
          <span
            className={`flex items-center gap-1 text-xs font-medium ${
              change.isGood ? 'text-green-600' : 'text-red-500'
            }`}
          >
            {change.isPositive ? (
              <TrendingUp className="w-3 h-3" />
            ) : (
              <TrendingDown className="w-3 h-3" />
            )}
            {change.value.toFixed(1)}%
          </span>
        )}
      </div>
      <div className="text-2xl font-bold text-gray-900 mb-1">
        {formatValue()}
      </div>
      {kpi.subtitle && (
        <div className="text-xs text-gray-400">{kpi.subtitle}</div>
      )}
      
      {trendData.length > 0 && (
        <div className="h-10 mt-3">
          <ResponsiveContainer>
            <LineChart data={trendData}>
              <Line 
                type="monotone" 
                dataKey="value" 
                stroke={kpi.color} 
                strokeWidth={2}
                dot={false}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}
      <div className="text-xs text-gray-400 mt-1 text-center">
        {expanded ? 'Click to hide chart' : 'Click to expand'}
      </div>
    </div>
  );
}

function BudgetIntelligenceTab({ data, formatCurrency, store }) {
  const [selectedCountry, setSelectedCountry] = useState('');
  const [objective, setObjective] = useState('purchases');
  const [brandSelection, setBrandSelection] = useState(store.id);

  const countryCodeToFlag = useCallback((code) => {
    if (!code || !/^[A-Z]{2}$/.test(code)) return 'ðŸ³ï¸';
    return String.fromCodePoint(...code.split('').map(char => 127397 + char.charCodeAt(0)));
  }, []);

  const countriesWithData = useMemo(
    () => new Set((data?.availableCountries || []).map(c => c.code)),
    [data]
  );

  const masterCountries = useMemo(() => {
    return MASTER_COUNTRIES.map(country => {
      const dataCountry = data?.availableCountries?.find(c => c.code === country.code);
      return {
        ...country,
        flag: dataCountry?.flag || countryCodeToFlag(country.code)
      };
    });
  }, [countryCodeToFlag, data]);

  const countryOptions = useMemo(() => {
    const apiCountries = Array.isArray(data?.availableCountries) ? data.availableCountries : [];
    if (apiCountries.length > 0) return apiCountries;
    return masterCountries;
  }, [data?.availableCountries, masterCountries]);

  useEffect(() => {
    if (!selectedCountry) {
      if (countryOptions.length) {
        setSelectedCountry(countryOptions[0].code);
      }
    }
    setBrandSelection(store.id);
  }, [store.id, selectedCountry, countryOptions]);

  const planningDefaults = data?.planningDefaults || {};
  const priors = data?.priors || {};

  const hasSelectedCountryData = countriesWithData.has(selectedCountry);

  const buildPlanFromPriors = (countryCode) => {
    const targetRange = planningDefaults.targetPurchasesRange || { min: 8, max: 15 };
    const targetPurchases = (targetRange.min + targetRange.max) / 2;
    const testDays = planningDefaults.testDays || 4;
    const baseCac = priors.meanCAC || priors.targetCAC || 1;
    let daily = (baseCac * targetPurchases) / testDays;

    const comparables = planningDefaults.comparableDailySpends || [];
    if (comparables.length > 0) {
      let nearest = comparables[0];
      let minDiff = Math.abs(daily - nearest);
      for (const val of comparables) {
        const diff = Math.abs(daily - val);
        if (diff < minDiff) {
          minDiff = diff;
          nearest = val;
        }
      }
      daily = Math.max(nearest * 0.7, Math.min(nearest * 1.3, daily));
    }

    if (planningDefaults.minDaily) {
      daily = Math.max(daily, planningDefaults.minDaily);
    }
    if (planningDefaults.maxDaily) {
      daily = Math.min(daily, planningDefaults.maxDaily);
    }

    const expectedPurchases = (daily * testDays) / Math.max(baseCac, 1);

    return {
      country: countryCode,
      name: countryCode,
      flag: 'ðŸ³ï¸',
      recommendedDaily: daily,
      recommendedTotal: daily * testDays,
      testDays,
      posteriorCAC: baseCac,
      posteriorROAS: priors.meanROAS || priors.targetROAS || 0,
      expectedPurchases,
      expectedRange: {
        low: Math.max(targetRange.min * 0.8, expectedPurchases * 0.8),
        high: Math.min(targetRange.max * 1.2, expectedPurchases * 1.2)
      },
      confidence: 'Low',
      confidenceBand: {
        low: (priors.meanROAS || 0) * 0.8,
        high: (priors.meanROAS || 0) * 1.2
      },
      rationale: 'Brand priors applied because no geo history',
      effectiveN: 1
    };
  };

  const startPlan = useMemo(() => {
    if (!data) return null;
    const fromServer = data.startPlans?.find(p => p.country === selectedCountry);
    if (fromServer) return fromServer;
    if (selectedCountry) return buildPlanFromPriors(selectedCountry);
    return data.startPlans?.[0] || null;
  }, [data, selectedCountry]);

  const formatMetric = (value, decimals = 2) =>
    value === null || value === undefined || Number.isNaN(value)
      ? 'â€”'
      : Number(value).toFixed(decimals);

  const formatCurrencySafe = (value, decimals = 0) =>
    value === null || value === undefined || Number.isNaN(value)
      ? 'â€”'
      : formatCurrency(value, decimals);

  const guidance = data?.liveGuidance || [];
  const learningMap = data?.learningMap || {};

  return (
    <div className="space-y-6 animate-fade-in">
      <div className="bg-white rounded-xl p-6 shadow-sm">
        <div className="flex items-start justify-between gap-4 flex-wrap">
          <div>
            <h2 className="text-xl font-semibold text-gray-900 mb-1">Start Budget Planner (New Geo)</h2>
            <p className="text-sm text-gray-600">Disciplined starting budgets grounded in brand priors and nearby performance.</p>
          </div>
          <div className="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
            Prior window: {data?.priorRange?.startDate || 'â€”'} to {data?.priorRange?.endDate || 'â€”'}
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <div className="md:col-span-2">
            <label className="text-sm font-medium text-gray-700">Country</label>
            <select
              value={selectedCountry}
              onChange={(e) => setSelectedCountry(e.target.value)}
              className="mt-2 w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white"
            >
              {countryOptions.map(c => (
                <option key={c.code} value={c.code}>
                  {`${c.flag || countryCodeToFlag(c.code)} ${c.name} (${c.code})`}
                </option>
              ))}
            </select>
            <div className="flex items-center gap-2 mt-2 text-xs">
              <span
                className={`px-2 py-0.5 rounded-full font-semibold ${
                  hasSelectedCountryData ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700'
                }`}
              >
                {hasSelectedCountryData ? 'data' : 'new'}
              </span>
              {!hasSelectedCountryData && (
                <span className="text-amber-700">No historical data yet â€” using global baseline.</span>
              )}
            </div>
          </div>
          <div>
            <label className="text-sm font-medium text-gray-700">Brand</label>
            <select
              value={brandSelection}
              onChange={(e) => setBrandSelection(e.target.value)}
              className="mt-2 w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-700"
              disabled
            >
              <option value="vironax">VironaX</option>
              <option value="shawq">Shawq</option>
            </select>
            <p className="text-[11px] text-gray-500 mt-1">Use the store switcher above to change brand.</p>
          </div>
          <div>
            <label className="text-sm font-medium text-gray-700">Objective</label>
            <select
              value={objective}
              onChange={(e) => setObjective(e.target.value)}
              className="mt-2 w-full px-4 py-2 border border-gray-200 rounded-lg"
            >
              <option value="purchases">Purchases (default)</option>
              <option value="atc">Add To Cart (fallback)</option>
            </select>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
          <div className="bg-gray-50 border border-gray-100 rounded-xl p-4">
            <p className="text-sm text-gray-500">Recommended starting daily</p>
            <div className="text-3xl font-bold text-gray-900 mt-1">
              {startPlan ? formatCurrencySafe(startPlan.recommendedDaily, 0) : 'â€”'}
            </div>
            <p className="text-xs text-gray-500 mt-1">Test for {startPlan?.testDays || planningDefaults.testDays || 4} days â€¢ Objective: {objective === 'atc' ? 'ATC' : 'Purchases'}</p>
          </div>
          <div className="bg-gray-50 border border-gray-100 rounded-xl p-4">
            <p className="text-sm text-gray-500">Expected purchases (range)</p>
            <div className="text-2xl font-bold text-gray-900 mt-1">
              {startPlan ? `${formatMetric(startPlan.expectedRange.low, 1)} - ${formatMetric(startPlan.expectedRange.high, 1)}` : 'â€”'}
            </div>
            <p className="text-xs text-gray-500 mt-1">Posterior CAC {formatCurrencySafe(startPlan?.posteriorCAC || priors.meanCAC, 0)} | ROAS {formatMetric(startPlan?.posteriorROAS || priors.meanROAS, 2)}</p>
          </div>
          <div className="bg-gray-50 border border-gray-100 rounded-xl p-4">
            <p className="text-sm text-gray-500">Confidence band</p>
            <div className="text-xl font-semibold text-gray-900 mt-1">
              {startPlan ? `${formatMetric(startPlan.confidenceBand.low, 2)} - ${formatMetric(startPlan.confidenceBand.high, 2)}` : 'â€”'}
            </div>
            <p className="text-xs text-gray-500 mt-1">Signal strength: {startPlan?.confidence || 'Low'} â€¢ {startPlan?.rationale || 'Using priors'}</p>
          </div>
        </div>
      </div>

      <div className="bg-white rounded-xl p-6 shadow-sm">
        <div className="flex items-start justify-between gap-4 flex-wrap mb-4">
          <div>
            <h2 className="text-xl font-semibold text-gray-900">Live Scale/Hold/Cut Guidance</h2>
            <p className="text-sm text-gray-600">Posterior performance with uncertainty-aware probabilities.</p>
          </div>
          <div className="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
            Targets â€” ROAS â‰¥ {priors.targetROAS || 'â€”'} | CAC â‰¤ {formatCurrencySafe(priors.targetCAC, 0)}
          </div>
        </div>

        {guidance.length === 0 ? (
          <div className="text-center py-10 text-gray-500">No Meta campaigns found for this window.</div>
        ) : (
          <div className="overflow-x-auto">
            <table className="w-full text-sm">
              <thead>
                <tr className="bg-gray-50 text-gray-600">
                  <th className="py-3 px-4 text-left">Campaign Ã— Country</th>
                  <th className="py-3 px-4 text-right">Spend</th>
                  <th className="py-3 px-4 text-right">Purchases</th>
                  <th className="py-3 px-4 text-right">Revenue</th>
                  <th className="py-3 px-4 text-right">AOV</th>
                  <th className="py-3 px-4 text-right">CAC</th>
                  <th className="py-3 px-4 text-right">ROAS</th>
                  <th className="py-3 px-4 text-right">Posterior CAC</th>
                  <th className="py-3 px-4 text-right">Posterior ROAS</th>
                  <th className="py-3 px-4 text-left">Action</th>
                  <th className="py-3 px-4 text-left">Reason</th>
                </tr>
              </thead>
              <tbody>
                {guidance.map((row) => {
                  const badgeStyles = row.action === 'Scale'
                    ? 'bg-green-100 text-green-700'
                    : row.action === 'Cut'
                      ? 'bg-red-100 text-red-700'
                      : row.action === 'Insufficient Data'
                        ? 'bg-amber-100 text-amber-700'
                        : 'bg-gray-100 text-gray-700';
                  return (
                    <tr key={`${row.campaignId}-${row.country}`} className="border-t border-gray-100">
                      <td className="py-3 px-4">
                        <div className="font-medium text-gray-900">{row.campaignName || 'Unnamed Campaign'}</div>
                        <div className="text-xs text-gray-500">{row.country || 'â€”'}</div>
                      </td>
                      <td className="py-3 px-4 text-right">{formatCurrency(row.spend, 0)}</td>
                      <td className="py-3 px-4 text-right">{formatMetric(row.purchases, 0)}</td>
                      <td className="py-3 px-4 text-right">{formatCurrencySafe(row.revenue, 0)}</td>
                      <td className="py-3 px-4 text-right">{formatMetric(row.aov, 0)}</td>
                      <td className="py-3 px-4 text-right">{formatCurrencySafe(row.cac, 0)}</td>
                      <td className="py-3 px-4 text-right">{formatMetric(row.roas, 2)}</td>
                      <td className="py-3 px-4 text-right">{formatCurrencySafe(row.posteriorCAC, 0)}</td>
                      <td className="py-3 px-4 text-right">{formatMetric(row.posteriorROAS, 2)}</td>
                      <td className="py-3 px-4">
                        <span className={`px-3 py-1 rounded-full text-xs font-semibold inline-flex items-center gap-1 ${badgeStyles}`}>
                          {row.action}
                        </span>
                        {row.action === 'Scale' && <div className="text-[11px] text-gray-500">Suggest +15% to +25% daily</div>}
                        {row.action === 'Cut' && <div className="text-[11px] text-gray-500">Suggest -20% to -35% daily</div>}
                      </td>
                      <td className="py-3 px-4 text-gray-600 text-sm max-w-xs">{row.reason}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
        <p className="text-xs text-gray-500 mt-3">These are probabilistic recommendations using smoothed performance to avoid overreacting to noise.</p>
      </div>

      <div className="bg-white rounded-xl p-6 shadow-sm">
        <div className="flex items-start justify-between gap-4 flex-wrap mb-4">
          <div>
            <h2 className="text-xl font-semibold text-gray-900">Learning Health &amp; Expansion Map</h2>
            <p className="text-sm text-gray-600">Ranked by smoothed ROAS minus CAC with signal strength bonus.</p>
          </div>
          <div className="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">Signal bonus grows with purchases/orders</div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <LearningColumn title="High priority to test" data={learningMap.highPriority} accent="border-green-500" />
          <LearningColumn title="Promising but noisy" data={learningMap.noisy} accent="border-amber-500" />
          <LearningColumn title="Likely poor fit" data={learningMap.poorFit} accent="border-red-500" />
          <LearningColumn title="Not enough signal" data={learningMap.lowSignal} accent="border-gray-300" />
        </div>
      </div>
    </div>
  );
}

function LearningColumn({ title, data, accent }) {
  return (
    <div className={`border rounded-xl p-4 ${accent} bg-gray-50`}>
      <h3 className="font-semibold text-gray-900 mb-3">{title}</h3>
      {(!data || data.length === 0) && (
        <p className="text-sm text-gray-500">â€”</p>
      )}
      <div className="space-y-3">
        {(data || []).map((item) => (
          <div key={item.country} className="bg-white rounded-lg p-3 shadow-sm border border-gray-100">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <span>{item.flag}</span>
                <div>
                  <div className="font-medium text-gray-900 text-sm">{item.name || item.country}</div>
                  <div className="text-xs text-gray-500">Posterior ROAS {item.posteriorROAS ? item.posteriorROAS.toFixed(2) : 'â€”'} | CAC {item.posteriorCAC ? Math.round(item.posteriorCAC) : 'â€”'}</div>
                </div>
              </div>
              <div className="text-xs text-gray-500">N={item.effectiveN}</div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function EfficiencyTab({ efficiency, trends, recommendations, formatCurrency }) {
  const statusColors = {
    green: { bg: 'bg-green-100', text: 'text-green-700', label: 'Healthy' },
    yellow: { bg: 'bg-amber-100', text: 'text-amber-700', label: 'Moderate Pressure' },
    red: { bg: 'bg-red-100', text: 'text-red-700', label: 'High Pressure' }
  };
  
  const status = statusColors[efficiency.status] || statusColors.yellow;

  return (
    <div className="space-y-6 animate-fade-in">
      <div className="grid grid-cols-3 gap-6">
        <div className="bg-white rounded-xl p-6 shadow-sm">
          <div className="flex items-center gap-4 mb-4">
            <div className={`w-12 h-12 rounded-xl flex items-center justify-center text-2xl ${status.bg}`}>
              {efficiency.status === 'green' ? 'âœ…' : efficiency.status === 'red' ? 'ðŸ”´' : 'âš ï¸'}
            </div>
            <div>
              <h3 className="font-semibold text-lg">{status.label}</h3>
              <p className="text-sm text-gray-500">Overall efficiency status</p>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h3 className="font-semibold mb-4">Average vs Marginal CAC</h3>
          <div className="space-y-3">
            <div className="flex justify-between p-3 bg-gray-50 rounded-lg">
              <span className="text-sm text-gray-600">Average CAC</span>
              <span className="font-semibold text-green-600">
                {formatCurrency(efficiency.averageCac, 2)}
              </span>
            </div>
            <div className="flex justify-between p-3 bg-gray-50 rounded-lg">
              <span className="text-sm text-gray-600">Marginal CAC</span>
              <span className="font-semibold">
                {formatCurrency(efficiency.marginalCac, 2)}
              </span>
            </div>
          </div>
        </div>

        <div className="bg-white rounded-xl p-6 shadow-sm">
          <h3 className="font-semibold mb-4">Scaling Headroom</h3>
          <div className="space-y-2">
            {efficiency.countries && efficiency.countries.map(c => (
              <div
                key={c.code}
                className="flex justify-between items-center p-3 bg-gray-50 rounded-lg"
              >
                <span className="text-sm">
                  {c.scaling === 'green' ? 'ðŸŸ¢' : c.scaling === 'yellow' ? 'ðŸŸ¡' : 'ðŸ”´'}{' '}
                  {c.name}
                </span>
                <span
                  className={`text-sm font-medium ${
                    c.scaling === 'green'
                      ? 'text-green-600'
                      : c.scaling === 'yellow'
                      ? 'text-amber-600'
                      : 'text-red-600'
                  }`}
                >
                  {c.headroom}
                </span>
              </div>
            ))}
          </div>
        </div>
      </div>

      {trends && trends.length > 0 && (
        <div className="grid grid-cols-2 gap-6">
          <div className="bg-white rounded-xl p-6 shadow-sm">
            <h3 className="font-semibold mb-4">CAC Trend</h3>
            <div className="h-64">
              <ResponsiveContainer>
                <LineChart data={trends}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="date" tick={{ fontSize: 11 }} />
                  <YAxis tick={{ fontSize: 11 }} />
                  <Tooltip />
                  <Line
                    type="monotone"
                    dataKey="cac"
                    name="Daily CAC"
                    stroke="#6366f1"
                    strokeWidth={2}
                    dot={false}
                  />
                </LineChart>
              </ResponsiveContainer>
            </div>
          </div>

          <div className="bg-white rounded-xl p-6 shadow-sm">
            <h3 className="font-semibold mb-4">ROAS Trend</h3>
            <div className="h-64">
              <ResponsiveContainer>
                <AreaChart data={trends}>
                  <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                  <XAxis dataKey="date" tick={{ fontSize: 11 }} />
                  <YAxis tick={{ fontSize: 11 }} />
                  <Tooltip />
                  <Area
                    type="monotone"
                    dataKey="roas"
                    name="Daily ROAS"
                    stroke="#10b981"
                    fill="#10b981"
                    fillOpacity={0.2}
                  />
                </AreaChart>
              </ResponsiveContainer>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white rounded-xl p-6 shadow-sm">
        <h3 className="text-lg font-semibold mb-4">ðŸ’¡ Recommendations</h3>
        <div className="space-y-3">
          {recommendations.map((r, i) => (
            <div 
              key={i}
              className={`flex gap-4 p-4 rounded-xl border-l-4 ${
                r.type === 'urgent'
                  ? 'bg-red-50 border-red-500'
                  : r.type === 'positive'
                  ? 'bg-green-50 border-green-500'
                  : 'bg-gray-50 border-indigo-500'
              }`}
            >
              <div
                className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white ${
                  r.type === 'urgent'
                    ? 'bg-red-500'
                    : r.type === 'positive'
                    ? 'bg-green-500'
                    : 'bg-indigo-500'
                }`}
              >
                {i + 1}
              </div>
              <div className="flex-1">
                <h4 className="font-semibold">{r.title}</h4>
                <p className="text-sm text-gray-600 mt-1">{r.detail}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

function ManualDataTab({
  orders,
  form,
  setForm,
  onSubmit,
  onDelete,
  manualSpendOverrides,
  spendOverrideForm,
  setSpendOverrideForm,
  onAddSpendOverride,
  onDeleteSpendOverride,
  onBulkDelete,
  formatCurrency,
  store,
  availableCountries
}) {
  const [deleteScope, setDeleteScope] = useState('day');
  const [deleteDate, setDeleteDate] = useState(getLocalDateString());

  const overrideLabel = (code) => {
    if (code === 'ALL') return 'All Countries (override total spend)';
    const country = availableCountries.find(c => c.code === code);
    return country ? `${country.flag} ${country.name}` : code;
  };

  return (
    <div className="space-y-6 animate-fade-in">
      <div className="bg-white rounded-xl p-6 shadow-sm">
        <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
          <Plus className="w-5 h-5" />
          Add Manual Order
        </h3>
        <form onSubmit={onSubmit}>
          <div className="grid grid-cols-7 gap-4 mb-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Country
              </label>
              <select
                value={form.country}
                onChange={(e) => setForm({ ...form, country: e.target.value })}
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              >
                {availableCountries.map(c => (
                  <option key={c.code} value={c.code}>
                    {c.flag} {c.name}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Campaign
              </label>
              <input
                type="text"
                value={form.campaign}
                onChange={(e) => setForm({ ...form, campaign: e.target.value })}
                placeholder="Campaign name"
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Date
              </label>
              <input
                type="date"
                value={form.date}
                onChange={(e) => setForm({ ...form, date: e.target.value })}
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                # Orders
              </label>
              <input
                type="number"
                min="1"
                value={form.orders_count}
                onChange={(e) =>
                  setForm({ ...form, orders_count: parseInt(e.target.value) })
                }
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Revenue ({store.currencySymbol})
              </label>
              <input
                type="number"
                min="0"
                value={form.revenue}
                onChange={(e) =>
                  setForm({ ...form, revenue: parseFloat(e.target.value) })
                }
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Spend ({store.currencySymbol})
              </label>
              <input
                type="number"
                min="0"
                value={form.spend}
                onChange={(e) =>
                  setForm({ ...form, spend: parseFloat(e.target.value) || 0 })
                }
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Source
              </label>
              <select
                value={form.source}
                onChange={(e) => setForm({ ...form, source: e.target.value })}
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              >
                <option value="whatsapp">WhatsApp</option>
                <option value="correction">Meta Correction</option>
                <option value="phone">Phone Call</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>
          <button
            type="submit"
            className="px-6 py-2.5 bg-gray-900 text-white rounded-lg font-medium hover:bg-gray-800 transition-colors"
          >
            Add Order
          </button>
        </form>
      </div>

      <div className="bg-white rounded-xl p-6 shadow-sm">
        <h3 className="text-lg font-semibold mb-4 flex items-center gap-2">
          <Plus className="w-5 h-5" />
          Manual Spend Overrides
        </h3>
        <form onSubmit={onAddSpendOverride} className="space-y-4">
          <div className="grid grid-cols-4 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Date
              </label>
              <input
                type="date"
                value={spendOverrideForm.date}
                onChange={(e) => setSpendOverrideForm({ ...spendOverrideForm, date: e.target.value })}
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Scope
              </label>
              <select
                value={spendOverrideForm.country}
                onChange={(e) => setSpendOverrideForm({ ...spendOverrideForm, country: e.target.value })}
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              >
                <option value="ALL">All Countries (override total)</option>
                {availableCountries.map(c => (
                  <option key={c.code} value={c.code}>
                    {c.flag} {c.name}
                  </option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Spend ({store.currencySymbol})
              </label>
              <input
                type="number"
                min="0"
                value={spendOverrideForm.amount}
                onChange={(e) => setSpendOverrideForm({ ...spendOverrideForm, amount: parseFloat(e.target.value) || 0 })}
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Notes (optional)
              </label>
              <input
                type="text"
                value={spendOverrideForm.notes}
                onChange={(e) => setSpendOverrideForm({ ...spendOverrideForm, notes: e.target.value })}
                placeholder="Reason or details"
                className="w-full px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
          </div>
          <button
            type="submit"
            className="px-6 py-2.5 bg-gray-900 text-white rounded-lg font-medium hover:bg-gray-800 transition-colors"
          >
            Save Manual Spend
          </button>
        </form>

        <div className="mt-6 space-y-3">
          {manualSpendOverrides.length === 0 ? (
            <div className="text-gray-500 text-sm">No manual spend overrides added for this period.</div>
          ) : (
            manualSpendOverrides.map((entry) => (
              <div
                key={entry.id}
                className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200"
              >
                <div className="space-y-1">
                  <div className="font-medium text-gray-900">{overrideLabel(entry.country)}</div>
                  <div className="text-sm text-gray-600">{entry.date}</div>
                  <div className="text-sm text-indigo-700 font-semibold">
                    {formatCurrency(entry.amount || 0)}
                  </div>
                  {entry.notes ? (
                    <div className="text-sm text-gray-500">{entry.notes}</div>
                  ) : null}
                </div>
                <button
                  onClick={() => onDeleteSpendOverride(entry.id)}
                  className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              </div>
            ))
          )}
        </div>
      </div>

      <div className="bg-white rounded-xl p-6 shadow-sm">
        <h3 className="text-lg font-semibold mb-4">Manual Orders History</h3>
        {orders.length === 0 ? (
          <div className="text-center py-12 text-gray-500">
            <p className="text-4xl mb-3">ðŸ“‹</p>
            <p>No manual orders added yet</p>
          </div>
        ) : (
          <div className="space-y-3">
            {orders.map((order) => (
              <div
                key={order.id}
                className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border-l-4 border-indigo-500"
              >
                <div className="flex items-center gap-6">
                  <span className="font-medium">{order.date}</span>
                  <span className="px-2 py-1 bg-gray-200 rounded text-sm">
                    {order.country}
                  </span>
                  <span className="px-2 py-1 bg-gray-200 rounded text-sm capitalize">
                    {order.source}
                  </span>
                  <span>
                    <strong>{order.orders_count}</strong> orders â€¢{' '}
                    <span className="text-green-600 font-medium">
                      {formatCurrency(order.revenue)}
                    </span>
                    {order.spend ? (
                      <span className="ml-2 text-indigo-600 font-medium">
                        Spend: {formatCurrency(order.spend)}
                      </span>
                    ) : null}
                  </span>
                </div>
                <button
                  onClick={() => onDelete(order.id)}
                  className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              </div>
            ))}
          </div>
        )}
      </div>

      <div className="bg-red-50 border border-red-200 rounded-xl p-6">
        <h3 className="text-lg font-semibold text-red-700 mb-4 flex items-center gap-2">
          <Trash2 className="w-5 h-5" />
          Delete Manual Data
        </h3>
        <div className="flex items-end gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Delete data for
            </label>
            <select
              value={deleteScope}
              onChange={(e) => setDeleteScope(e.target.value)}
              className="px-3 py-2 border border-gray-200 rounded-lg"
            >
              <option value="day">Specific Day</option>
              <option value="week">Specific Week</option>
              <option value="month">Specific Month</option>
              <option value="all">All Manual Data</option>
            </select>
          </div>
          {deleteScope !== 'all' && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Date
              </label>
              <input
                type="date"
                value={deleteDate}
                onChange={(e) => setDeleteDate(e.target.value)}
                className="px-3 py-2 border border-gray-200 rounded-lg"
              />
            </div>
          )}
          <button
            onClick={() => onBulkDelete(deleteScope, deleteDate)}
            className="px-6 py-2.5 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition-colors"
          >
            Delete
          </button>
        </div>
      </div>
    </div>
  );
}


================ FILE: ./client/src/main.jsx ================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './index.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)


================ FILE: ./client/src/package.json ================
{
  "name": "virona-shawq-dashboard",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "build": "cd client && npm install && npm run build",
    "start": "cd server && npm install && node server.js"
  }
}


================ FILE: ./client/tailwind.config.js ================
/** @type {import('tailwindcss').Config} */
export default {
  content: [
    "./index.html",
    "./src/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      colors: {
        primary: {
          50: '#f0f4ff',
          100: '#dbe4ff',
          500: '#6366f1',
          600: '#4f46e5',
          700: '#4338ca',
        }
      }
    },
  },
  plugins: [],
}


================ FILE: ./client/vite.config.js ================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true
      }
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: false
  }
})
